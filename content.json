{"pages":[{"title":"å…³äºæˆ‘","text":"éå…¸å‹ç å†œï¼Œå–œå¥½ç§‘æŠ€èµ„è®¯ï¼Œçˆ±è£…æœºã€‚èˆªæ‹ï¼Œå…¨æ™¯åˆ¶å›¾èŒæ–°ã€‚ ä¸­åœŸä¸–ç•Œã€‚ å·²ç‚¹å±æ€§ï¼š ä¸‰æµæ®µå­æ‰‹ï¼Œæœºè¯„äºŒåå¹´ã€‚ C++/Javaç¨‹åºçŒ¿ã€‚ Less is More. æ³›å­¦ing å¾…ç»­ å—¯ psï¼š æ²¡äº‹çš„æ—¶å€™å¤šçœ‹ä¹¦å‡†æ²¡é”™ï¼Œå­¦ä¹ æ–°æŠ€æœ¯ï¼Œå¤šè¿åŠ¨é”»ç‚¼ã€‚","link":"/about/index.html"},{"title":"Categories","text":"","link":"/categories/index.html"},{"title":"Tags","text":"","link":"/tags/index.html"}],"posts":[{"title":"C++ä¸­sprintfå‡½æ•°çš„ç”¨æ³•","text":"1.å¸¸ç”¨æ–¹å¼ sprintfå‡½æ•°çš„åŠŸèƒ½ä¸printfå‡½æ•°çš„åŠŸèƒ½åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å®ƒæŠŠç»“æœè¾“å‡ºåˆ°æŒ‡å®šçš„å­—ç¬¦ä¸²ä¸­äº†ï¼Œçœ‹ä¸ªä¾‹å­å°±æ˜ç™½äº†ï¼š ä¾‹ï¼šå°†&quot;test,1,2&quot;å†™å…¥æ•°ç»„sä¸­ 12345678910#include&lt;stdio.h&gt;int main(int argc, char *avgv[]){ char s[40]; sprintf(s,&quot;%s%d%c&quot;,&quot;test&quot;,1,'2'); /*ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æŒ‡å‘è¦å†™å…¥çš„é‚£ä¸ªå­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼Œå‰©ä¸‹çš„å°±å’Œprintf()ä¸€æ ·äº† ä½ å¯ä»¥æ¯”è¾ƒä¸€ä¸‹ï¼Œè¿™æ˜¯å‘å±å¹•è¾“å…¥*/ printf(&quot;%s%d%c&quot;,&quot;test&quot;,1,'2'); return 0;} ç¼–è¯‘ï¼š g++ sprinftest.cpp -o sprinftest &amp;&amp; ./sprinftest è¾“å‡ºç»“æœï¼š sprintftest12sprintftest12 2.è‹¥â€%sâ€ç­‰è¾“å‡ºç¬¦åœ¨å­—ç¬¦ä¸²ä¸­ä¾‹ï¼šè¡¥å…¨å­—ç¬¦ä¸²strçš„ç¼ºçœå†…å®¹ 123456789101112#include &lt;iostream&gt;#include &lt;stdio.h&gt;#include &lt;cstring&gt;int main(int argc, char *avgv[]){ char str[] = &quot;hel%co wo%sd! sp%stf test%d&quot;; char buf[strlen(str)]; sprintf(buf, str, 'l', &quot;rl&quot;, &quot;rin&quot;, 1); std::cout &lt;&lt; &quot;str = &quot;&lt;&lt; buf &lt;&lt; &quot;\\nlen = &quot; &lt;&lt; strlen(buf) &lt;&lt; std::endl; return 0;} ç¼–è¯‘ï¼š g++ sprinftest.cpp -o sprinftest &amp;&amp; ./sprinftest è¾“å‡ºç»“æœï¼š str = hello world! sprintf test1len = 27 è¿™ç§å½¢å¼ä¹Ÿå¯ä»¥å°†å¤šä¸ªå­—ç¬¦å€¼æˆ–å­—ç¬¦ä¸²å€¼èµ‹å€¼åˆ°å­—ç¬¦ä¸²strä¸­ï¼Œæœ‰å¤šå°‘ä¸ªè¾“å‡ºç¬¦å°±åé¢å°±åŠ å¤šå°‘ä¸ªå‚æ•°ã€‚","link":"/2015/07/21/C++%E4%B8%ADsprintf%E5%87%BD%E6%95%B0%E7%9A%84%E7%94%A8%E6%B3%95/"},{"title":"Elasticsearchå®è·µ(1)-æ­å»ºåŠIKä¸­æ–‡åˆ†è¯","text":"ğŸ”è¿‘æœŸåœ¨åšå•†å“æœç´¢ä¼˜åŒ–ï¼Œå¯¹æ¯”äº†Solrä¸Elasticsearchçš„åŒºåˆ«ï¼Œä¸¤è€…éƒ½æ˜¯åŸºäºLuceneå®ç°çš„å°è£…ï¼Œä½†esåœ¨æ•°æ®é‡è¶Šå¤§çš„æƒ…å†µä¸‹å®æ—¶æ£€ç´¢æ€§èƒ½ä¼˜äºsolrï¼Œæ›´é€‚ç”¨äºå®æ—¶å•†å“æœç´¢ï¼Œäºæ˜¯é€‰ç”¨äº†esï¼Œä¸‹é¢ä»‹ç»elasticsearchæœç´¢å¼•æ“çš„æ­å»ºåŠä½¿ç”¨ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯2.2.1çš„esç‰ˆæœ¬ï¼Œä»¥åŠ1.8.1çš„ikåˆ†è¯ç‰ˆæœ¬ã€‚ å®‰è£…esåŠIKä¸­æ–‡åˆ†è¯1. ä¸‹è½½å®‰è£…åŒ…12345##æˆ‘çš„ç¯å¢ƒæ˜¯Redhat6.4ï¼Œæ­¤å¤„ä½¿ç”¨çš„æ˜¯es2.2.1ç‰ˆæœ¬##ï¼ˆ1ï¼‰å¯ä»¥ä½¿ç”¨æŒ‡ä»¤å®‰è£…$ yum install https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/rpm/elasticsearch/2.2.1/elasticsearch-2.2.1.rpm##ï¼ˆ2ï¼‰ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½æ–‡ä»¶ï¼Œç„¶åä¸Šä¼ è‡³linuxç›®å½•ä¸‹https://download.elasticsearch.org/elasticsearch/release/org/elasticsearch/distribution/tar/elasticsearch/2.2.1/elasticsearch-2.2.1.tar.gz 2. ä¸Šä¼ å®‰è£…æ–‡ä»¶åˆ°linuxç›®å½•å¹¶è§£å‹æˆ‘è¿™é‡Œå°†elasticsearch-2.2.1.tar.gzæ–‡ä»¶æ”¾è‡³/opt/elasticsearchç›®å½•ä¸‹ã€‚ è§£å‹ï¼š 12$ cd /opt/elasticsearch$ tar -zxvf elasticsearch-2.2.1.tar.gz æ­¤æ—¶åˆ‡è®°ä¸èƒ½ç”¨ ./bin/elasticsearchå¯åŠ¨ï¼Œå› ä¸ºåœ¨rootæƒé™ä¸‹ä¼šæç¤ºé”™è¯¯ï¼š 1Exception in thread &quot;main&quot; java.lang.RuntimeException: don't run elasticsearch as root. 3. æ–°æ·»åŠ ä¸€ä¸ªelasticsearchç”¨æˆ·123456789101112#æ·»åŠ elasticsearchç”¨æˆ·ï¼š$ useradd elasticsearch#ç»™ç”¨æˆ·elasticsearchè®¾ç½®å¯†ç ï¼Œè¿ç»­è¾“å…¥2æ¬¡ï¼š$ passwd elasticsearch#åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç»„es:$ groupadd es#åˆ†é…elasticsearchåˆ°esç»„:$ usermod -G es elasticsearch#åœ¨elasticsearch æ ¹ç›®å½•ä¸‹ï¼Œç»™å®šç”¨æˆ·æƒé™ã€‚-Rè¡¨ç¤ºé€çº§ï¼ˆNå±‚ç›®å½•ï¼‰ ï¼Œ * è¡¨ç¤º ä»»ä½•æ–‡ä»¶:$ chown -R elasticsearch:es *#åˆ‡æ¢åˆ°elasticsearchç”¨æˆ·:$ su elasticsearch 4. ä¿®æ”¹é…ç½®æ–‡ä»¶1$ vi config/elasticsearch.yml ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š 123456789#cluster namecluster.name: my-application#èŠ‚ç‚¹åç§°node.name: node-1path.data: /opt/elasticsearch/elasticsearch-2.2.1/datapath.logs: /opt/elasticsearch/elasticsearch-2.2.1/logs#ç»‘å®šIPå’Œç«¯å£network.host: 0.0.0.0http.port: 9200 5. å®‰è£…headheadæ˜¯elasticsearchçš„å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥ä¸ç”¨å®‰è£…headï¼Œå¦‚æœä¸éœ€è¦å®‰è£…ï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œes2.xçš„ç‰ˆæœ¬headå¯ç›´æ¥å®‰è£…ï¼Œes5.xä»¥ä¸Šçš„ç‰ˆæœ¬éœ€è¦å…ˆå®‰è£…nodejsã€‚ 5.1. ES2.x.xç‰ˆæœ¬å®‰è£…headåœ¨/opt/elasticsearch/elasticsearch-2.2.1/ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ï¼šplugins 1234$ cd /opt/elasticsearch/elasticsearch-2.2.1/$ mkdir plugins$ cd elasticsearch/bin$ ./plugin install mobz/elasticsearch-head å®‰è£…æˆåŠŸå³å¯ã€‚å¯åŠ¨esä¹‹åï¼Œè®¿é—®http://ip:9200/_plugin/head/å³å¯çœ‹åˆ°å¯è§†åŒ–ç•Œé¢ã€‚ 5.2 ES5.x.xç‰ˆæœ¬å®‰è£…headES5.xç‰ˆæœ¬æš‚æ—¶ä¸æ”¯æŒç›´æ¥å®‰è£…ï¼Œä½†æ˜¯headä½œè€…æä¾›äº†å¦ä¸€ç§å®‰è£…æ–¹æ³•ã€‚ 1234$ git clone git://github.com/mobz/elasticsearch-head.git$ cd elasticsearch-head$ npm install$ npm run start ç„¶åæ‰“å¼€http://localhost:9100/è®¿é—®å³å¯ã€‚ å¦‚æœæç¤ºæœªå®‰è£…node.jsï¼Œå…ˆå®‰è£…node.jsï¼Œ node.jså®˜ç½‘ï¼šhttp://nodejs.cn/download/ é€‰æ‹©å®‰è£…åŒ…ï¼Œæˆ‘è¿™è¾¹æ˜¯64ä½linuxï¼Œä¸‹è½½çš„æ˜¯https://nodejs.org/dist/v8.11.3/node-v8.11.3-linux-x64.tar.xz è§£å‹ï¼ˆæ³¨ï¼šå¦‚æœæ˜¯è™šæ‹Ÿæœºï¼Œä¸è¦åœ¨å…±äº«æ–‡ä»¶å¤¹ä¸­è§£å‹ï¼Œä¼šæŠ¥Cannot create symlink toåˆ›å»ºè½¯é“¾çš„é”™ï¼Œè¯·æ”¾è‡³linuxä¸‹è§£å‹ï¼‰ï¼š 12345678$ xz -d node-v8.11.3-linux-x64.tar.xz$ tar -xvf node-v8.11.3-linux-x64.tar$ mv node-v8.11.3-linux-x64 nodejs#ç¡®è®¤ä¸€ä¸‹nodejsä¸‹binç›®å½•æ˜¯å¦æœ‰node å’Œnpmæ–‡ä»¶ï¼Œå¦‚æœæœ‰æ‰§è¡Œè½¯è¿æ¥ï¼Œå¦‚æœæ²¡æœ‰é‡æ–°ä¸‹è½½æ‰§è¡Œä¸Šè¾¹æ­¥éª¤ï¼›å»ºç«‹è½¯è¿æ¥ï¼Œå˜ä¸ºå…¨å±€:$ ln -s /opt/nodejs/bin/npm /usr/local/bin/$ ln -s /opt/nodejs/bin/node /usr/local/bin/#æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ$ node -v 6. å¯åŠ¨ES123$ cd /opt/elasticsearch/elasticsearch-2.2.1$ su elasticsearch$ ./bin/elasticsearch å†è®¿é—®http://ip:9200/_plugin/head/å³å¯ã€‚ 7. å®‰è£…IKåˆ†è¯å™¨åœ¨https://github.com/medcl/elasticsearch-analysis-ik æ­¤å¤„é€‰æ‹©ä¸esç‰ˆæœ¬å¯¹åº”çš„ikåˆ†è¯ç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯elasticsearch-analysis-ik-1.8.1.zipï¼Œåœ¨ /opt/elasticsearch/elasticsearch-2.2.1/pluginsç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶å¤¹ï¼šik;å°†elasticsearch-analysis-ik-1.8.1.zipçš„è§£å‹æ–‡ä»¶æ”¾å…¥ikç›®å½•ä¸‹ï¼Œå¹¶å°†è§£å‹åçš„configä¸‹çš„ikæ–‡ä»¶å¤¹æ”¾å…¥ /opt/elasticsearch/elasticsearch-2.2.1/configä¸‹é¢; 123456$ unzip elasticsearch-analysis-ik-1.8.1.zip$ cd /opt/elasticsearch/elasticsearch-2.2.1/plugins$ mkdir ik$ cp -rf /opt/elasticsearch/elasticsearch-analysis-ik-1.8.1/ ik/$ mv /opt/elasticsearch/elasticsearch-analysis-ik-1.8.1/config/ik /opt/elasticsearch/elasticsearch-2.2.1/config$ cd /opt/elasticsearch/elasticsearch-2.2.1/config åœ¨/config/elasticsearch.ymlæ–‡ä»¶çš„æœ€ååŠ ä¸Šä¸€å¥è¯ï¼š 1index.analysis.analyzer.ik.type : &quot;ik&quot; ç„¶åå¯åŠ¨esï¼Œæµ‹è¯•åˆ†è¯æ•ˆæœï¼š 1234curl '10.10.13.234:9200/index/_analyze?analyzer=ik&amp;pretty=true' -d '{&quot;text&quot;:&quot;ä¸–ç•Œå¦‚æ­¤ä¹‹å¤§ è¿›å£æ°´æœ&quot;}' æˆ–è€…æµè§ˆå™¨è®¿é—®http://ip:9200/_analyze?analyzer=ik&amp;pretty=true&amp;text=sojsonåœ¨çº¿å·¥å…·æµ‹è¯•åˆ†è¯ï¼Œå³å¯çœ‹åˆ°ä¸­æ–‡åˆ†è¯æ•ˆæœã€‚ è‡³æ­¤ï¼Œelasticsearchæ­å»ºå®Œæˆï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥è¯´ä¸‹ç´¢å¼•çš„åˆ›å»ºã€‚","link":"/2018/05/15/Elasticsearch%E5%AE%9E%E8%B7%B5%E6%90%AD%E5%BB%BA%E5%8F%8AIK%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/"},{"title":"Elasticsearchå®è·µ(2)-ç´¢å¼•åŠç´¢å¼•åˆ«åalias","text":"æˆ‘ä»¬éƒ½çŸ¥é“esæ•ˆç‡å¦‚æ­¤é«˜ä¸»è¦å’Œç´¢å¼•æ˜¯åˆ†ä¸å¼€çš„ï¼Œéœ€è¦å°†æ¯ä¸€æ¡æ•°æ®å»ºç«‹ç´¢å¼•ï¼Œåˆ›å»ºç´¢å¼•æ—¶æ•°æ®å­—æ®µä¹Ÿæ˜¯ä½ æ’å…¥æ—¶çš„æ ·å­ï¼Œç´¢å¼•ä¸­åŒ…å«äº†æ•°æ®çš„å±æ€§å­—æ®µã€‚è€Œä¸”åˆ›å»ºç´¢å¼•ä¹Ÿæ¯”è¾ƒè€—æ—¶ï¼ˆå½“ç„¶äº†ï¼Œè‚¯å®šæ¯”æ’å…¥å…³ç³»å‹æ•°æ®åº“ä¸­æ›´å¿«ğŸ˜ï¼‰ï¼Œä½†æ˜¯æ¯•ç«Ÿæ¯ä¸€æ¡æ•°æ®éƒ½è¦å»ºä¸€æ¬¡ï¼Œæ•°æ®é‡åˆ°è¾¾åƒä¸‡çº§äº¿çº§æ—¶ï¼Œæ—¶é—´ä¸æ˜¯å¾ˆä¹è§‚ã€‚ğŸ¤” ğŸ’¡æƒ³åƒè¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œäº§å“ä¸Šçº¿ä¸€æ®µæ—¶é—´åï¼Œç”±äºäº§å“éœ€è¦ï¼Œè¦å°†æŸä¸ªå­—æ®µç±»å‹æ”¹å˜ï¼Œæ¯”å¦‚éœ€è¦å°†æŸä¸ªlongå‹å­—æ®µæ”¹æˆstringç±»å‹ï¼Œç›´æ¥æ”¹ä¼šç±»å‹æŠ¥é”™ï¼ŒæŸ¥é˜…å®˜æ–¹æ–‡æ¡£å¯çŸ¥ï¼Œesæ˜¯ä¸æ”¯æŒç´¢å¼•çš„æ›´æ–°æ“ä½œçš„ï¼Œéœ€è¦å¯¹æ‰€æœ‰å·²æœ‰æ•°æ®çš„æ‰€æœ‰fieldè¿›è¡Œreindexï¼Œè¿™æ„å‘³ç€ï¼Œéœ€è¦åœæ­¢æœåŠ¡è¿›è¡Œé‡å»ºç´¢å¼•æ“ä½œï¼Œåœæœæ˜¯æœ€ä¸æƒ³çœ‹åˆ°ğŸ˜­ï¼Œè¿™æ—¶å¦‚æœä½ å½“åˆå»ºäº†ç´¢å¼•åˆ«åï¼Œä½ ä¼šæ„Ÿè°¢ä½ å½“åˆä½¿ç”¨åˆ«åçš„å†³å®šï¼Œä¸ºä½•è¦ç”¨åˆ«åaliasï¼ŸğŸ¤· Elasticsearchçš„ç´¢å¼•åˆ«åaliasï¼Œç±»ä¼¼äºæ•°æ®åº“çš„è§†å›¾ã€‚å› ä¸ºç´¢å¼•åˆ«åaliasæ˜¯æ˜ å°„åˆ°ä¹‹å‰å·²åˆ›å»ºçš„ç´¢å¼•ä¸Šçš„ï¼Œå¯¹ä½ è¦åˆ›å»ºæ–°çš„ç´¢å¼•æ¯«æ— å½±å“ã€‚åœ¨åˆ›å»ºå¥½æ–°ç´¢å¼•ä¹‹åï¼Œæˆ‘ä»¬åªéœ€å°†è¿™åˆ«åaliasæ˜ å°„åˆ°æ–°åˆ›å»ºçš„åˆ«åä¸Šå³å¯ï¼Œè¿™äº›æ“ä½œåªéœ€è¦åœ¨æœåŠ¡å™¨ä¸Šé€šè¿‡æŒ‡ä»¤æ“ä½œå³å¯ï¼Œå®Œå…¨ä¸å½±å“çº¿ä¸ŠæœåŠ¡ï¼Œå®ç°æ— ç¼åˆ‡æ¢ç´¢å¼•ã€‚ç„¶åå†å°†è€çš„ç´¢å¼•åˆ æ‰å³å¯ï¼Œä»¥èŠ‚çœç©ºé—´ã€‚ 1. åˆ›å»ºä¸€ä¸ªç´¢å¼•åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œåä¸ºgoodsï¼š 1$ curl -XPUT 10.10.13.234:9200/goods 2. ä¸ºç´¢å¼•åˆ›å»ºmappingä¸ºç´¢å¼•goodsåˆ›å»ºmappingï¼Œè¿™é‡Œåˆ¶å®šcontentå­—æ®µå±æ€§ä½¿ç”¨ikä¸­æ–‡åˆ†è¯å™¨ï¼Œåªè¦åˆ¶å®šæœç´¢contentå†…å®¹å°±ä¼šæŸ¥è¯¢å‡ºåˆ†è¯ä¹‹åçš„å…³è”ç»“æœï¼š 1234567891011121314151617$ curl -XPOST 10.10.13.234:9200/goods/fulltext/_mapping -d'{ &quot;fulltext&quot;: { &quot;_all&quot;: { &quot;analyzer&quot;: &quot;ik&quot; }, &quot;properties&quot;: { &quot;content&quot;: { &quot;type&quot; : &quot;string&quot;, &quot;boost&quot; : 8.0, &quot;term_vector&quot; : &quot;with_positions_offsets&quot;, &quot;analyzer&quot; : &quot;ik&quot;, &quot;include_in_all&quot; : true } } }}' è¿™é‡Œåˆ›å»ºçš„ç´¢å¼•goodsï¼Œå¦‚æœæœªä½¿ç”¨åˆ«åï¼Œç¨‹åºä¸­ä¹Ÿæ˜¯ç”¨goodsè¿™ä¸ªç´¢å¼•åï¼Œå¦‚æœå»ºäº†æ–°çš„ç´¢å¼•ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿè¦ç”¨æ–°çš„ç´¢å¼•åç§°ï¼Œè¿™æ˜¯ä¸å‹å¥½çš„ï¼Œå¦‚æœç”¨äº†ç´¢å¼•åˆ«åaliaså°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»§ç»­çœ‹åé¢çš„æ“ä½œã€‚ 3. æ’å…¥æ•°æ®æ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®ï¼š 1234567891011121314$ curl -XPOST 10.10.13.234:9200/goods/fulltext/1 -H 'Content-Type:application/json' -d'{ &quot;content&quot;: &quot;è¿›å£åç››é¡¿çº¢è›‡æœ è‹¹æœ4ä¸ªè£… å•æœé‡çº¦180g æ–°é²œæ°´æœ&quot; }'$ curl -XPOST 10.10.13.234:9200/goods/fulltext/2 -H 'Content-Type:application/json' -d'{ &quot;content&quot;: &quot;åç››é¡¿è‹¹æœç¤¼ç›’ 8ä¸ªè£…ï¼ˆ4ä¸ªçº¢è›‡æœ+4ä¸ªé’è‹¹æœï¼‰å•æœé‡çº¦145g-180g æ–°é²œæ°´æœç¤¼ç›’&quot; }'$ curl -XPOST 10.10.13.234:9200/goods/fulltext/4 -H 'Content-Type:application/json' -d'{ &quot;content&quot;: &quot;æ–°ç–†é˜¿å…‹è‹å†°ç³–å¿ƒ çº¦5kg å•æœ200-250gï¼ˆ7Fresh ä¸“ä¾›ï¼‰&quot; }'$ curl -XPOST 10.10.13.234:9200/goods/fulltext/5 -H 'Content-Type:application/json' -d'{ &quot;content&quot;: &quot;æœèŠ± çç å²© æ— åœŸæ ½åŸ¹åŸºè´¨ é¢—ç²’çŠ¶ ä¿æ¸©æ€§èƒ½å¥½ å›­è‰ºç”¨å“&quot; }'#æŸ¥çœ‹goodsçš„mppingï¼Œåé¢éœ€è¦ä¸ç´¢å¼•åˆ«åçš„mappingå¯¹æ¯”$ curl -XGET &quot;10.10.13.234:9200/goods/_mapping?pretty&quot; 4. æµ‹è¯•åˆ†è¯é«˜äº®æµ‹è¯•å‘½ä¸­åˆ†è¯é«˜äº®ï¼š 12345678910$ curl -XPOST 10.10.13.234:9200/goods/fulltext/_search -H 'Content-Type:application/json' -d'{ &quot;query&quot; : { &quot;match&quot; : { &quot;content&quot; : &quot;è¿›å£æ°´æœ&quot; }}, &quot;highlight&quot; : { &quot;pre_tags&quot; : [&quot;&lt;tag1&gt;&quot;, &quot;&lt;tag2&gt;&quot;], &quot;post_tags&quot; : [&quot;&lt;/tag1&gt;&quot;, &quot;&lt;/tag2&gt;&quot;], &quot;fields&quot; : { &quot;content&quot; : {} } }}' 5. åˆ›å»ºç´¢å¼•åˆ«åæ–°å»ºåŒä¹‰è¯mappingï¼š (1) åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•çš„åç§°æœ€å¥½å¸¦ä¸Šç‰ˆæœ¬å·ï¼Œæ¯”å¦‚my_index_v1,my_index_v2ç­‰; (2) åˆ›å»ºä¸€ä¸ªæŒ‡å‘æœ¬ç´¢å¼•çš„åŒä¹‰è¯ã€‚ä¸ºçš„æ˜¯ä»¥åä¸åœæœæ›´æ–°mappingã€‚ æ­¥éª¤(1)çš„ç´¢å¼•æˆ‘ä»¬ä»¥åˆšåˆšåˆ›å»ºçš„goodsæ‰€ä»¥ä¸ºä¾‹ï¼Œåˆ›å»ºåˆ«åæ˜ å°„åˆ°goodsæ‰€ä»¥ä¸Šï¼š 123456789$ curl -XPOST 10.10.13.234:9200/_aliases -d ' { &quot;actions&quot;: [ { &quot;add&quot;: { &quot;alias&quot;: &quot;my_index&quot;, &quot;index&quot;: &quot;goods&quot; }} ] }' ç„¶åæŸ¥çœ‹ç´¢å¼•my_indexçš„mappingï¼š 1$ curl -XGET &quot;10.10.13.234:9200/my_index/_mapping?pretty&quot; ç´¢å¼•my_indexä¸goodsçš„mappingä¸€è‡´ã€‚ 6. åˆ‡æ¢ç´¢å¼•å†åˆ›å»ºä¸€ä¸ªç´¢å¼•goods_v2ï¼Œé‡å¤æ­¥éª¤1ã€2ï¼Œåç§°æ¢æˆgoods_v2 123456789101112131415161718$ curl -XPUT 10.10.13.234:9200/goods_v2$ curl -XPOST 10.10.13.234:9200/goods_v2/fulltext/_mapping -d'{ &quot;fulltext&quot;: { &quot;_all&quot;: { &quot;analyzer&quot;: &quot;ik&quot; }, &quot;properties&quot;: { &quot;content&quot;: { &quot;type&quot; : &quot;string&quot;, &quot;boost&quot; : 8.0, &quot;term_vector&quot; : &quot;with_positions_offsets&quot;, &quot;analyzer&quot; : &quot;ik&quot;, &quot;include_in_all&quot; : true } } }}' æ’å…¥æµ‹è¯•æ•°ï¼š 123456$ curl -XPOST 10.10.13.234:9200/goods_v2/fulltext/1 -H 'Content-Type:application/json' -d'{ &quot;content&quot;: &quot;è¿›å£åç››é¡¿çº¢è›‡æœ è‹¹æœ4ä¸ªè£… å•æœé‡çº¦180g æ–°é²œæ°´æœ&quot;,&quot;number&quot;: 21}'#æŸ¥çœ‹goods_v2çš„mppingï¼Œåé¢éœ€è¦ä¸ç´¢å¼•åˆ«åçš„mappingå¯¹æ¯”$ curl -XGET &quot;10.10.13.234:9200/goods_v2/_mapping?pretty&quot; é‡ç‚¹æ˜¯æ›´æ¢ç´¢å¼•çš„æ“ä½œï¼Œå°†my_indexåˆ«ååˆ‡æ¢æ˜ å°„åˆ°goods_v2ä¸Šï¼š 12345678910111213141516$ curl -XPOST 10.10.13.234:9200/_aliases -d '{ &quot;actions&quot;: [ { &quot;remove&quot;: { &quot;alias&quot;: &quot;my_index&quot;, &quot;index&quot;: &quot;goods&quot; }}, { &quot;add&quot;: { &quot;alias&quot;: &quot;my_index&quot;, &quot;index&quot;: &quot;goods_v2&quot; }} ]}'#æŸ¥çœ‹my_indexçš„mppingï¼Œä¸å‰é¢goods_v2çš„mappingå¯¹æ¯”$ curl -XGET &quot;10.10.13.234:9200/my_index/_mapping?pretty&quot; æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ç´¢å¼•my_indexä¸goods_v2çš„mappingæ˜¯ä¸€è‡´çš„ï¼Œç´¢å¼•åˆ‡æ¢æˆåŠŸã€‚ åˆ›å»ºäº†ç´¢å¼•åˆ«åaliasçš„è¯ï¼Œç¨‹åºä¸­åˆ¶å®šè¿™ä¸ªmy_indexè¿™ä¸ªåˆ«åå³å¯ï¼Œåéœ€è¦åˆ›å»ºæ–°ç´¢å¼•ï¼Œåªéœ€åˆ‡æ¢ç´¢å¼•æ˜ å°„åˆ°æ–°ç´¢å¼•ä¸Šå³å¯ï¼Œå®ç°ä¸åœæœæ›´æ–°mappingã€‚ ä¸‹ä¸€ç¯‡æˆ‘ä»¬æ¥è¯´ä¸‹é€šè¿‡åˆ›å»ºspring bootå·¥ç¨‹ï¼Œé€šè¿‡esçš„java apiæ“ä½œesï¼Œå®ç°åˆ†é¡µæŸ¥è¯¢å’Œä¸­æ–‡åˆ†è¯æ£€ç´¢çš„åŠŸèƒ½ã€‚","link":"/2018/05/16/Elasticsearch%E5%AE%9E%E8%B7%B5%E7%B4%A2%E5%BC%95%E5%8F%8A%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8Dalias/"},{"title":"Packet for query is too large (84 &gt; -1).","text":"ibatiså·¥ç¨‹ä½¿ç”¨resiné…ç½®mysqlå‡ºç°Packet for query is too large (84 &gt; -1).é”™è¯¯ã€‚ windowsä¸‹çš„resiné…ç½®è¿æ¥mysqlï¼Œå¸¸ç”¨çš„å®‰å…¨çš„åšæ³•æ˜¯å°†æ•°æ®åº“ä¿¡æ¯é…ç½®åˆ°confç›®å½•ä¸‹çš„resin.xmlæ–‡ä»¶ä¸­ã€‚ å› ä¸ºresinè¿æ¥mysqlä¸æ˜¯å¿…é¡»çš„ï¼Œæ‰€ä»¥resinæœ¬èº«æ²¡æœ‰æä¾›mysql-connectorçš„jaråŒ…ï¼Œéœ€è¦è‡ªå·±åŠ åˆ°resinç›®å½•ä¸‹çš„libé‡Œé¢ï¼Œæˆ‘åŠ äº†ä¸ªmysql-connector-java-5.1.45-bin.jarè¿›å»ï¼Œç„¶è€Œåœ¨è¿è¡Œå·¥ç¨‹æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„æ—¶å€™ï¼Œå´å‡ºç°äº†é—®é¢˜ï¼ŒæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š 123456789org.springframework.dao.TransientDataAccessResourceException: SqlMapClient operation; SQL []; --- The error occurred while applying a parameter map. --- Check the T_USER_INFO.selectByMap-InlineParameterMap. --- Check the statement (query failed). --- Cause: com.mysql.jdbc.PacketTooBigException: Packet for query is too large (84 &gt; -1). You can change this value on the server by setting the max_allowed_packet' variable.; nested exception is com.ibatis.common.jdbc.exception.NestedSQLException: --- The error occurred while applying a parameter map. --- Check the T_USER_INFO.selectByMap-InlineParameterMap. --- Check the statement (query failed). --- Cause: com.mysql.jdbc.PacketTooBigException: Packet for query is too large (84 &gt; -1). You can change this value on the server by setting the max_allowed_packet' variable. åªè¿›è¡ŒæŸ¥è¯¢å´å‡ºç°Packet for query is too largeï¼Œè€Œä¸”æŸ¥è¯¢çš„æ¡ä»¶åªæœ‰å‡ ä¸ªå­—æ¯ï¼Œç½‘ä¸Šæœäº†å¾ˆå¤šè§£ç­”ï¼Œéƒ½æ˜¯è¯´éœ€è¦æŠŠmysqlçš„max_allowed_packetå‚æ•°è°ƒå¤§ï¼Œä½†æ˜¯æˆ‘é€šè¿‡show VARIABLES like '%max_allowed_packet%';æŸ¥è¯¢çš„ç»“æœä¹Ÿå¾ˆå¤§ï¼Œå¦‚æœæ˜¯å‚æ•°è¿‡å°ï¼Œåº”è¯¥æ˜¯æç¤ºå¤§äºæ•°æ®åº“ä¸­è®¾ç½®çš„packetçš„å€¼ï¼Œè€Œä¸åº”è¯¥æŠ¥-1ã€‚ æœ€åå‘ç°æœ‰ä¸ªå¸–å­è¯´æ˜¯mysql-connector-javajaråŒ…çš„ç‰ˆæœ¬é—®é¢˜ï¼Œç‰ˆæœ¬ä¸èƒ½å¤ªé«˜ï¼Œéšåæˆ‘å°†mysql-connector-java-5.1.45-bin.jaræ¢æˆmysql-connector-java-5.1.26-bin.jarï¼Œä¸å†å‡ºç°packeté”™è¯¯ï¼Œé—®é¢˜è§£å†³ã€‚ å¯èƒ½æ˜¯å› ä¸ºæˆ‘ç”¨çš„æ˜¯ibatis2.0ç‰ˆæœ¬çš„ç¼˜æ•…ï¼Œä¸æ”¯æŒå¤ªé«˜çš„mysqlè¿æ¥jarç‰ˆæœ¬ï¼Œæ¢æˆmysql-connector-java-5.1.40ä»¥ä¸‹ç‰ˆæœ¬å³å¯è§£å†³Packet for query is too large (84 &gt; -1)é—®é¢˜ã€‚","link":"/2018/03/15/Packet%20for%20query%20is%20too%20large/"},{"title":"Socket sendå‡½æ•°å’Œrecvå‡½æ•°è¯¦è§£","text":"1. send å‡½æ•°**int send( SOCKET s, const char FAR *buf, int len, int flags ); ** ä¸è®ºæ˜¯å®¢æˆ·è¿˜æ˜¯æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½ç”¨sendå‡½æ•°æ¥å‘TCPè¿æ¥çš„å¦ä¸€ç«¯å‘é€æ•°æ®ã€‚å®¢æˆ·ç¨‹åºä¸€èˆ¬ç”¨sendå‡½æ•°å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€ŒæœåŠ¡å™¨åˆ™é€šå¸¸ç”¨sendå‡½æ•°æ¥å‘å®¢æˆ·ç¨‹åºå‘é€åº”ç­”ã€‚ â€‹ è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå‘é€ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› â€‹ ç¬¬äºŒä¸ªå‚æ•°æŒ‡æ˜ä¸€ä¸ªå­˜æ”¾åº”ç”¨ç¨‹åºè¦å‘é€æ•°æ®çš„ç¼“å†²åŒºï¼› â€‹ ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡æ˜å®é™…è¦å‘é€çš„æ•°æ®çš„å­—èŠ‚æ•°ï¼› â€‹ ç¬¬å››ä¸ªå‚æ•°ä¸€èˆ¬ç½®0ã€‚ â€‹ è¿™é‡Œåªæè¿°åŒæ­¥Socketçš„sendå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚å½“è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œ ï¼ˆ1ï¼‰sendå…ˆæ¯”è¾ƒå¾…å‘é€æ•°æ®çš„é•¿åº¦lenå’Œå¥—æ¥å­—sçš„å‘é€ç¼“å†²çš„é•¿åº¦ï¼Œ å¦‚æœlenå¤§äºsçš„å‘é€ç¼“å†²åŒºçš„é•¿åº¦ï¼Œè¯¥å‡½æ•°è¿”å›SOCKET_ERRORï¼› ï¼ˆ2ï¼‰å¦‚æœlenå°äºæˆ–è€…ç­‰äºsçš„å‘é€ç¼“å†²åŒºçš„é•¿åº¦ï¼Œé‚£ä¹ˆsendå…ˆæ£€æŸ¥åè®®æ˜¯å¦æ­£åœ¨å‘é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®ï¼Œå¦‚æœæ˜¯å°±ç­‰å¾…åè®®æŠŠæ•°æ®å‘é€å®Œï¼Œå¦‚æœåè®®è¿˜æ²¡æœ‰å¼€å§‹å‘é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®æˆ–è€…sçš„å‘é€ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆsendå°±æ¯”è¾ƒsçš„å‘é€ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´å’Œlen ï¼ˆ3ï¼‰å¦‚æœlenå¤§äºå‰©ä½™ç©ºé—´å¤§å°ï¼Œsendå°±ä¸€ç›´ç­‰å¾…åè®®æŠŠsçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®å‘é€å®Œ ï¼ˆ4ï¼‰å¦‚æœlenå°äºå‰©ä½™ ç©ºé—´å¤§å°ï¼Œsendå°±ä»…ä»…æŠŠbufä¸­çš„æ•°æ®copyåˆ°å‰©ä½™ç©ºé—´é‡Œï¼ˆæ³¨æ„å¹¶ä¸æ˜¯sendæŠŠsçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®ä¼ åˆ°è¿æ¥çš„å¦ä¸€ç«¯çš„ï¼Œè€Œæ˜¯åè®®ä¼ çš„ï¼Œsendä»…ä»…æ˜¯æŠŠbufä¸­çš„æ•°æ®copyåˆ°sçš„å‘é€ç¼“å†²åŒºçš„å‰©ä½™ç©ºé—´é‡Œï¼‰ã€‚ â€‹ å¦‚æœsendå‡½æ•°copyæ•°æ®æˆåŠŸï¼Œå°±è¿”å›å®é™…copyçš„å­—èŠ‚æ•°ï¼Œå¦‚æœsendåœ¨copyæ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼Œé‚£ä¹ˆsendå°±è¿”å›SOCKET_ERRORï¼›å¦‚æœsendåœ¨ç­‰å¾…åè®®ä¼ é€æ•°æ®æ—¶ç½‘ç»œæ–­å¼€çš„è¯ï¼Œé‚£ä¹ˆsendå‡½æ•°ä¹Ÿè¿”å›SOCKET_ERRORã€‚ â€‹ è¦æ³¨æ„sendå‡½æ•°æŠŠbufä¸­çš„æ•°æ®æˆåŠŸcopyåˆ°sçš„å‘é€ç¼“å†²çš„å‰©ä½™ç©ºé—´é‡Œåå®ƒå°±è¿”å›äº†ï¼Œä½†æ˜¯æ­¤æ—¶è¿™äº›æ•°æ®å¹¶ä¸ä¸€å®šé©¬ä¸Šè¢«ä¼ åˆ°è¿æ¥çš„å¦ä¸€ç«¯ã€‚å¦‚æœåè®®åœ¨åç»­çš„ä¼ é€è¿‡ç¨‹ä¸­å‡ºç°ç½‘ç»œé”™è¯¯çš„è¯ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªSocketå‡½æ•°å°±ä¼šè¿”å›SOCKET_ERRORã€‚ï¼ˆæ¯ä¸€ä¸ªé™¤sendå¤–çš„Socketå‡½æ•°åœ¨æ‰§ è¡Œçš„æœ€å¼€å§‹æ€»è¦å…ˆç­‰å¾…å¥—æ¥å­—çš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®è¢«åè®®ä¼ é€å®Œæ¯•æ‰èƒ½ç»§ç»­ï¼Œå¦‚æœåœ¨ç­‰å¾…æ—¶å‡ºç°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆè¯¥Socketå‡½æ•°å°±è¿”å› SOCKET_ERRORï¼‰ æ³¨æ„ï¼šåœ¨Unixç³»ç»Ÿä¸‹ï¼Œå¦‚æœsendåœ¨ç­‰å¾…åè®®ä¼ é€æ•°æ®æ—¶ç½‘ç»œæ–­å¼€çš„è¯ï¼Œè°ƒç”¨sendçš„è¿›ç¨‹ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªSIGPIPEä¿¡å·ï¼Œè¿›ç¨‹å¯¹è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†æ˜¯è¿›ç¨‹ç»ˆæ­¢ã€‚ é€šè¿‡æµ‹è¯•å‘ç°ï¼Œå¼‚æ­¥socketçš„sendå‡½æ•°åœ¨ç½‘ç»œåˆšåˆšæ–­å¼€æ—¶è¿˜èƒ½å‘é€è¿”å›ç›¸åº”çš„å­—èŠ‚æ•°ï¼ŒåŒæ—¶ä½¿ç”¨selectæ£€æµ‹ä¹Ÿæ˜¯å¯å†™çš„ï¼Œä½†æ˜¯è¿‡å‡ ç§’é’Ÿä¹‹åï¼Œå†sendå°±ä¼šå‡ºé”™äº†ï¼Œè¿”å›-1ã€‚selectä¹Ÿä¸èƒ½æ£€æµ‹å‡ºå¯å†™äº†ã€‚ 2. recvå‡½æ•° int recv( SOCKET s, char FAR *buf, int len, int flags); ä¸è®ºæ˜¯å®¢æˆ·è¿˜æ˜¯æœåŠ¡å™¨åº”ç”¨ç¨‹åºéƒ½ç”¨recvå‡½æ•°ä»TCPè¿æ¥çš„å¦ä¸€ç«¯æ¥æ”¶æ•°æ®ã€‚è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šæ¥æ”¶ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› â€‹ ç¬¬äºŒä¸ªå‚æ•°æŒ‡æ˜ä¸€ä¸ªç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºç”¨æ¥å­˜æ”¾recvå‡½æ•°æ¥æ”¶åˆ°çš„æ•°æ®ï¼› â€‹ ç¬¬ä¸‰ä¸ªå‚æ•°æŒ‡æ˜bufçš„é•¿åº¦ï¼› â€‹ ç¬¬å››ä¸ªå‚æ•°ä¸€èˆ¬ç½®0ã€‚ â€‹ è¿™é‡Œåªæè¿°åŒæ­¥Socketçš„recvå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚å½“åº”ç”¨ç¨‹åºè°ƒç”¨recvå‡½æ•°æ—¶ï¼Œ â€‹ ï¼ˆ1ï¼‰recvå…ˆç­‰å¾…sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®è¢«åè®®ä¼ é€å®Œæ¯•ï¼Œå¦‚æœåè®®åœ¨ä¼ é€sçš„å‘é€ç¼“å†²ä¸­çš„æ•°æ®æ—¶å‡ºç°ç½‘ç»œé”™è¯¯ï¼Œé‚£ä¹ˆrecvå‡½æ•°è¿”å›SOCKET_ERROR ï¼› â€‹ ï¼ˆ2ï¼‰å¦‚æœsçš„å‘é€ç¼“å†²ä¸­æ²¡æœ‰æ•°æ®æˆ–è€…æ•°æ®è¢«åè®®æˆåŠŸå‘é€å®Œæ¯•åï¼Œrecvå…ˆæ£€æŸ¥å¥—æ¥å­—sçš„æ¥æ”¶ç¼“å†²åŒºï¼Œå¦‚æœsæ¥æ”¶ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æˆ–è€…åè®®æ­£åœ¨æ¥æ”¶æ•°æ®ï¼Œé‚£ä¹ˆrecvå°±ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°åè®®æŠŠæ•°æ®æ¥æ”¶å®Œæ¯•ã€‚å½“åè®®æŠŠæ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œrecvå‡½æ•°å°±æŠŠsçš„æ¥æ”¶ç¼“å†²ä¸­çš„æ•°æ®copyåˆ°bufä¸­ï¼ˆæ³¨æ„åè®®æ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½å¤§äºbufçš„é•¿åº¦ï¼Œæ‰€ä»¥ åœ¨è¿™ç§æƒ…å†µä¸‹è¦è°ƒç”¨å‡ æ¬¡recvå‡½æ•°æ‰èƒ½æŠŠsçš„æ¥æ”¶ç¼“å†²ä¸­çš„æ•°æ®copyå®Œã€‚recvå‡½æ•°ä»…ä»…æ˜¯copyæ•°æ®ï¼ŒçœŸæ­£çš„æ¥æ”¶æ•°æ®æ˜¯åè®®æ¥å®Œæˆçš„ï¼‰ï¼› â€‹ recvå‡½æ•°è¿”å›å…¶å®é™…copyçš„å­—èŠ‚æ•°ã€‚å¦‚æœrecvåœ¨copyæ—¶å‡ºé”™ï¼Œé‚£ä¹ˆå®ƒè¿”å›SOCKET_ERRORï¼›å¦‚æœrecvå‡½æ•°åœ¨ç­‰å¾…åè®®æ¥æ”¶æ•°æ®æ—¶ç½‘ç»œä¸­æ–­äº†ï¼Œé‚£ä¹ˆå®ƒè¿”å›0ã€‚ æ³¨æ„ï¼šåœ¨Unixç³»ç»Ÿä¸‹ï¼Œå¦‚æœrecvå‡½æ•°åœ¨ç­‰å¾…åè®®æ¥æ”¶æ•°æ®æ—¶ç½‘ç»œæ–­å¼€äº†ï¼Œé‚£ä¹ˆè°ƒç”¨recvçš„è¿›ç¨‹ä¼šæ¥æ”¶åˆ°ä¸€ä¸ªSIGPIPEä¿¡å·ï¼Œè¿›ç¨‹å¯¹è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†æ˜¯è¿›ç¨‹ç»ˆæ­¢ã€‚","link":"/2017/01/10/Socket_send%E5%87%BD%E6%95%B0%E5%92%8Crecv%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3/"},{"title":"TCPé•¿è¿æ¥ä¸çŸ­è¿æ¥çš„åŒºåˆ«","text":"1. TCPè¿æ¥â€‹ å½“ç½‘ç»œé€šä¿¡æ—¶é‡‡ç”¨TCPåè®®æ—¶ï¼Œåœ¨çœŸæ­£çš„è¯»å†™æ“ä½œä¹‹å‰ï¼Œserverä¸clientä¹‹é—´å¿…é¡»å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå½“è¯»å†™æ“ä½œå®Œæˆåï¼ŒåŒæ–¹ä¸å†éœ€è¦è¿™ä¸ªè¿æ¥æ—¶å®ƒä»¬å¯ä»¥é‡Šæ”¾è¿™ä¸ªè¿æ¥ï¼Œè¿æ¥çš„å»ºç«‹æ˜¯éœ€è¦ä¸‰æ¬¡æ¡æ‰‹çš„ï¼Œè€Œé‡Šæ”¾åˆ™éœ€è¦4æ¬¡æ¡æ‰‹ï¼Œæ‰€ä»¥è¯´æ¯ä¸ªè¿æ¥çš„å»ºç«‹éƒ½æ˜¯éœ€è¦èµ„æºæ¶ˆè€—å’Œæ—¶é—´æ¶ˆè€—çš„ã€‚ ç»å…¸çš„ä¸‰æ¬¡æ¡æ‰‹ç¤ºæ„å›¾ï¼š ç»å…¸çš„å››æ¬¡æ¡æ‰‹å…³é—­å›¾ï¼š 2. TCPçŸ­è¿æ¥â€‹ æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹TCPçŸ­è¿æ¥çš„æƒ…å†µï¼Œclientå‘serverå‘èµ·è¿æ¥è¯·æ±‚ï¼Œserveræ¥åˆ°è¯·æ±‚ï¼Œç„¶ååŒæ–¹å»ºç«‹è¿æ¥ã€‚clientå‘serverå‘é€æ¶ˆæ¯ï¼Œserverå›åº”clientï¼Œç„¶åä¸€æ¬¡è¯»å†™å°±å®Œæˆäº†ï¼Œè¿™æ—¶å€™åŒæ–¹ä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥å‘èµ·closeæ“ä½œï¼Œä¸è¿‡ä¸€èˆ¬éƒ½æ˜¯clientå…ˆå‘èµ·closeæ“ä½œã€‚ ä¸ºä»€ä¹ˆå‘¢ï¼Œä¸€èˆ¬çš„serverä¸ä¼šå›å¤å®Œclientåç«‹å³å…³é—­è¿æ¥çš„ï¼Œå½“ç„¶ä¸æ’é™¤æœ‰ç‰¹æ®Šçš„æƒ…å†µã€‚ ä»ä¸Šé¢çš„æè¿°çœ‹ï¼ŒçŸ­è¿æ¥ä¸€èˆ¬åªä¼šåœ¨client/serveré—´ä¼ é€’ä¸€æ¬¡è¯»å†™æ“ä½œã€‚ çŸ­è¿æ¥çš„ä¼˜ç‚¹æ˜¯ï¼šç®¡ç†èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå­˜åœ¨çš„è¿æ¥éƒ½æ˜¯æœ‰ç”¨çš„è¿æ¥ï¼Œä¸éœ€è¦é¢å¤–çš„æ§åˆ¶æ‰‹æ®µã€‚ 3. TCPé•¿è¿æ¥â€‹ æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¨¡æ‹Ÿä¸€ä¸‹é•¿è¿æ¥çš„æƒ…å†µï¼Œclientå‘serverå‘èµ·è¿æ¥ï¼Œserveræ¥å—clientè¿æ¥ï¼ŒåŒæ–¹å»ºç«‹è¿æ¥ã€‚Clientä¸serverå®Œæˆä¸€æ¬¡è¯»å†™ä¹‹åï¼Œå®ƒä»¬ä¹‹é—´çš„è¿æ¥å¹¶ä¸ä¼šä¸»åŠ¨å…³é—­ï¼Œåç»­çš„è¯»å†™æ“ä½œä¼šç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚ â€‹ é¦–å…ˆè¯´ä¸€ä¸‹TCP/IPè¯¦è§£ä¸Šè®²åˆ°çš„TCPä¿æ´»åŠŸèƒ½ï¼Œä¿æ´»åŠŸèƒ½ä¸»è¦ä¸ºæœåŠ¡å™¨åº”ç”¨æä¾›ï¼ŒæœåŠ¡å™¨åº”ç”¨å¸Œæœ›çŸ¥é“å®¢æˆ·ä¸»æœºæ˜¯å¦å´©æºƒï¼Œä»è€Œå¯ä»¥ä»£è¡¨å®¢æˆ·ä½¿ç”¨èµ„æºã€‚å¦‚æœå®¢æˆ·å·²ç»æ¶ˆå¤±ï¼Œä½¿å¾—æœåŠ¡å™¨ä¸Šä¿ç•™ä¸€ä¸ªåŠå¼€æ”¾çš„è¿æ¥ï¼Œè€ŒæœåŠ¡å™¨åˆåœ¨ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„æ•°æ®ï¼Œåˆ™æœåŠ¡å™¨å°†åº”è¿œç­‰å¾…å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œä¿æ´»åŠŸèƒ½å°±æ˜¯è¯•å›¾åœ¨æœåŠ¡å™¨ç«¯æ£€æµ‹åˆ°è¿™ç§åŠå¼€æ”¾çš„è¿æ¥ã€‚ å¦‚æœä¸€ä¸ªç»™å®šçš„è¿æ¥åœ¨ä¸¤å°æ—¶å†…æ²¡æœ‰ä»»ä½•çš„åŠ¨ä½œï¼Œåˆ™æœåŠ¡å™¨å°±å‘å®¢æˆ·å‘ä¸€ä¸ªæ¢æµ‹æŠ¥æ–‡æ®µï¼Œå®¢æˆ·ä¸»æœºå¿…é¡»å¤„äºä»¥ä¸‹4ä¸ªçŠ¶æ€ä¹‹ä¸€ï¼š å®¢æˆ·ä¸»æœºä¾ç„¶æ­£å¸¸è¿è¡Œï¼Œå¹¶ä»æœåŠ¡å™¨å¯è¾¾ã€‚å®¢æˆ·çš„TCPå“åº”æ­£å¸¸ï¼Œè€ŒæœåŠ¡å™¨ä¹ŸçŸ¥é“å¯¹æ–¹æ˜¯æ­£å¸¸çš„ï¼ŒæœåŠ¡å™¨åœ¨ä¸¤å°æ—¶åå°†ä¿æ´»å®šæ—¶å™¨å¤ä½ã€‚ å®¢æˆ·ä¸»æœºå·²ç»å´©æºƒï¼Œå¹¶ä¸”å…³é—­æˆ–è€…æ­£åœ¨é‡æ–°å¯åŠ¨ã€‚åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·çš„TCPéƒ½æ²¡æœ‰å“åº”ã€‚æœåŠ¡ç«¯å°†ä¸èƒ½æ”¶åˆ°å¯¹æ¢æµ‹çš„å“åº”ï¼Œå¹¶åœ¨75ç§’åè¶…æ—¶ã€‚æœåŠ¡å™¨æ€»å…±å‘é€10ä¸ªè¿™æ ·çš„æ¢æµ‹ ï¼Œæ¯ä¸ªé—´éš”75ç§’ã€‚å¦‚æœæœåŠ¡å™¨æ²¡æœ‰æ”¶åˆ°ä¸€ä¸ªå“åº”ï¼Œå®ƒå°±è®¤ä¸ºå®¢æˆ·ä¸»æœºå·²ç»å…³é—­å¹¶ç»ˆæ­¢è¿æ¥ã€‚ å®¢æˆ·ä¸»æœºå´©æºƒå¹¶å·²ç»é‡æ–°å¯åŠ¨ã€‚æœåŠ¡å™¨å°†æ”¶åˆ°ä¸€ä¸ªå¯¹å…¶ä¿æ´»æ¢æµ‹çš„å“åº”ï¼Œè¿™ä¸ªå“åº”æ˜¯ä¸€ä¸ªå¤ä½ï¼Œä½¿å¾—æœåŠ¡å™¨ç»ˆæ­¢è¿™ä¸ªè¿æ¥ã€‚ å®¢æˆ·æœºæ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯æœåŠ¡å™¨ä¸å¯è¾¾ï¼Œè¿™ç§æƒ…å†µä¸2ç±»ä¼¼ï¼ŒTCPèƒ½å‘ç°çš„å°±æ˜¯æ²¡æœ‰æ”¶åˆ°æ¢æŸ¥çš„å“åº”ã€‚ â€‹ ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒTCPä¿æ´»åŠŸèƒ½ä¸»è¦ä¸ºæ¢æµ‹é•¿è¿æ¥çš„å­˜æ´»çŠ¶å†µï¼Œä¸è¿‡è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå­˜æ´»åŠŸèƒ½çš„æ¢æµ‹å‘¨æœŸå¤ªé•¿ï¼Œè¿˜æœ‰å°±æ˜¯å®ƒåªæ˜¯æ¢æµ‹TCPè¿æ¥çš„å­˜æ´»ï¼Œå±äºæ¯”è¾ƒæ–¯æ–‡çš„åšæ³•ï¼Œé‡åˆ°æ¶æ„çš„è¿æ¥æ—¶ï¼Œä¿æ´»åŠŸèƒ½å°±ä¸å¤Ÿä½¿äº†ã€‚ åœ¨é•¿è¿æ¥çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œclientç«¯ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å…³é—­å®ƒä»¬ä¹‹é—´çš„è¿æ¥ï¼Œclientä¸serverä¹‹é—´çš„è¿æ¥å¦‚æœä¸€ç›´ä¸å…³é—­çš„è¯ï¼Œä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œéšç€å®¢æˆ·ç«¯è¿æ¥è¶Šæ¥è¶Šå¤šï¼Œserveræ—©æ™šæœ‰æ‰›ä¸ä½çš„æ—¶å€™ï¼Œè¿™æ—¶å€™serverç«¯éœ€è¦é‡‡å–ä¸€äº›ç­–ç•¥ï¼Œ å¦‚å…³é—­ä¸€äº›é•¿æ—¶é—´æ²¡æœ‰è¯»å†™äº‹ä»¶å‘ç”Ÿçš„è¿æ¥ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸€äº›æ¶æ„è¿æ¥å¯¼è‡´serverç«¯æœåŠ¡å—æŸï¼› å¦‚æœæ¡ä»¶å†å…è®¸å°±å¯ä»¥ä»¥å®¢æˆ·ç«¯æœºå™¨ä¸ºé¢—ç²’åº¦ï¼Œé™åˆ¶æ¯ä¸ªå®¢æˆ·ç«¯çš„æœ€å¤§é•¿è¿æ¥æ•°ï¼Œè¿™æ ·å¯ä»¥å®Œå…¨é¿å…æŸä¸ªè›‹ç–¼çš„å®¢æˆ·ç«¯è¿ç´¯åç«¯æœã€‚ é•¿è¿æ¥å’ŒçŸ­è¿æ¥çš„äº§ç”Ÿåœ¨äºclientå’Œserveré‡‡å–çš„å…³é—­ç­–ç•¥ï¼Œå…·ä½“çš„åº”ç”¨åœºæ™¯é‡‡ç”¨å…·ä½“çš„ç­–ç•¥ï¼Œæ²¡æœ‰åå…¨åç¾çš„é€‰æ‹©ï¼Œåªæœ‰åˆé€‚çš„é€‰æ‹©ã€‚","link":"/2015/02/20/TCP%E9%95%BF%E8%BF%9E%E6%8E%A5%E4%B8%8E%E7%9F%AD%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%8C%BA%E5%88%AB/"},{"title":"linux-crontabå®šæ—¶æ‰§è¡Œä»»åŠ¡","text":"â±ï¸æœ€è¿‘ç¢°åˆ°ä¸€ä¸ªå…³äºcrontabçš„é—®é¢˜ã€‚ 1. äº‹å› æœåŠ¡å™¨éƒ¨ç½²äº†ä¸€ä¸ªC++æŸ¥è¯¢æ•°æ®åº“è¯åº“çš„æœåŠ¡ï¼Œä»¥åŠJavaå‘é€ç›®æ ‡è¯çš„æœåŠ¡ï¼ŒJavaæœåŠ¡é€šè¿‡soketé•¿è¿æ¥å‘C++æœåŠ¡å‘é€ç›®æ ‡å•è¯ï¼Œç„¶åC++æœåŠ¡è¿”å›æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨çš„ç»“æœã€‚ æœŸé—´ï¼Œç”±äºæ•°æ®åº“æœ‰æ—¶å¢åŠ å•è¯éœ€è¦é‡å¯æœåŠ¡ï¼Œæ‰‹å†™äº†ä¸ªå®šæ—¶è„šæœ¬æ¥é‡å¯è¯¥C++æœåŠ¡ã€‚ æŸä¸€æ¬¡ä¸ºäº†è°ƒè¯•ï¼ŒæŠŠæ”¹å®šæ—¶è„šæœ¬å…³äº†ï¼Œé€šè¿‡ps -ef |grep xxxå‘½ä»¤æŸ¥çœ‹æœåŠ¡çˆ¶å­è¿›ç¨‹æƒ…å†µï¼Œå‘ç°çˆ¶è¿›ç¨‹è¿˜æ˜¯æ¯éš”ååˆ†é’Ÿé€€å‡ºï¼ŒæœåŠ¡ä¼šé‡å¯ï¼Œæƒ³äº†è®¸ä¹…ä¸çŸ¥é“å“ªå‡ºäº†é—®é¢˜ã€‚ æœ€åè¯¢é—®è¿ç»´æ‰æƒ³èµ·ï¼Œä¹‹å‰è¿˜ç”¨äº†linuxè‡ªå¸¦çš„crontabè®¾ç½®è¿‡æ¯éš”ååˆ†é’Ÿé‡å¯æœåŠ¡ï¼Œæ²¡æœ‰åˆ é™¤crontabé‡Œé¢çš„é‚£æ¡è®¾ç½®ã€‚ æ‰€ä»¥æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹linuxè‡ªå¸¦çš„å¯è®¾ç½®å®šæ—¶æŒ‡å®šä»»åŠ¡çš„crontabã€‚ 2. åˆè¯†crontabcronæ˜¯ä¸€ä¸ªæœåŠ¡è¿›ç¨‹ï¼ŒcronæœåŠ¡æä¾›crontabå‘½ä»¤æ¥è®¾å®šcronæœåŠ¡çš„ï¼Œä»¥ä¸‹æ˜¯è¿™ä¸ªå‘½ä»¤çš„ä¸€äº›å‚æ•°ä¸è¯´æ˜ï¼š crontab -u //è®¾å®šæŸä¸ªç”¨æˆ·çš„cronæœåŠ¡ï¼Œä¸€èˆ¬rootç”¨æˆ·åœ¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„æ—¶å€™éœ€è¦æ­¤å‚æ•° crontab -l //åˆ—å‡ºæŸä¸ªç”¨æˆ·cronæœåŠ¡çš„è¯¦ç»†å†…å®¹ crontab -r //åˆ é™¤æŸä¸ªç”¨æˆ·çš„cronæœåŠ¡ crontab -e //ç¼–è¾‘æŸä¸ªç”¨æˆ·çš„cronæœåŠ¡ 3. åŸºæœ¬ç”¨æ³•åŸºæœ¬æ ¼å¼ : 1* * * * * command â€‹ **åˆ† æ—¶ æ—¥ æœˆ å‘¨ å‘½ä»¤ ** ç¬¬1åˆ—è¡¨ç¤ºåˆ†é’Ÿ1ï½59 æ¯åˆ†é’Ÿç”¨*æˆ–è€… */1è¡¨ç¤º ï¼›ç¬¬2åˆ—è¡¨ç¤ºå°æ—¶1ï½23ï¼ˆ0è¡¨ç¤º0ç‚¹ï¼‰ ï¼›ç¬¬3åˆ—è¡¨ç¤ºæ—¥æœŸ1ï½31 ï¼›ç¬¬4åˆ—è¡¨ç¤ºæœˆä»½1ï½12 ï¼›ç¬¬5åˆ—æ ‡è¯†å·æ˜ŸæœŸ0ï½6ï¼ˆ0è¡¨ç¤ºæ˜ŸæœŸå¤©ï¼‰ ï¼›ç¬¬6åˆ—è¦è¿è¡Œçš„å‘½ä»¤ ã€‚ crontabçš„ä¸€äº›ä½¿ç”¨ä¾‹å­: */10 * * * * (cd /opt/resin/bin; ./resin.sh restart) è¡¨ç¤ºæ¯éš”10åˆ†é‡å¯resinæœåŠ¡ï¼› 30 1 * * * (cd /opt/resin/bin; ./resin.sh restart) è¡¨ç¤ºæ¯å¤©1ç‚¹30åˆ†é‡å¯resinæœåŠ¡ï¼› * 23-5/1 * * * (cd /opt/resin/bin; ./resin.sh restart) è¡¨ç¤ºæ¯å¤©23ç‚¹åˆ°æ¬¡æ—¥5ç‚¹ä¹‹é—´æ¯éš”1å°æ—¶é‡å¯resinæœåŠ¡ï¼›","link":"/2017/07/25/linux-crontab%E5%AE%9A%E6%97%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--$elemMatchæ“ä½œç¬¦çš„ä½¿ç”¨","text":"mongodbæä¾›äº†å¾ˆå¤šæ“ä½œç¬¦ä»¥ä¾¿æ›´åŠ æ–¹ä¾¿å¿«æ·åœ°æ“ä½œæ•°æ®ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®¤è¯†ä¸€ä¸‹æŸ¥è¯¢æ“ä½œç¬¦$elemMatchï¼Œ$elemMatchæŠ•å½±æ“ä½œç¬¦å°†é™åˆ¶æŸ¥è¯¢è¿”å›çš„æ•°ç»„å­—æ®µçš„å†…å®¹åªåŒ…å«åŒ¹é…$elemMatchæ¡ä»¶çš„æ•°ç»„å…ƒç´ ã€‚ æ³¨æ„ï¼š æ•°ç»„ä¸­å…ƒç´ æ˜¯å†…åµŒæ–‡æ¡£ã€‚ å¦‚æœå¤šä¸ªå…ƒç´ åŒ¹é…$elemMatchæ¡ä»¶ï¼Œæ“ä½œç¬¦è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…æ¡ä»¶çš„å…ƒç´ ã€‚ 1.é¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•æ–‡æ¡£1db.test.insert({&quot;id&quot;:1, &quot;members&quot;:[{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27, &quot;gender&quot;:&quot;M&quot;}, {&quot;name&quot;:&quot;BuleRiver2&quot;, &quot;age&quot;:23, &quot;gender&quot;:&quot;F&quot;}, {&quot;name&quot;:&quot;BuleRiver3&quot;, &quot;age&quot;:21, &quot;gender&quot;:&quot;M&quot;}]}); 2.ä½¿ç”¨å¤šç§æ–¹å¼å°è¯•æŸ¥è¯¢(1) ä½¿ç”¨db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;}});è¿›è¡ŒæŸ¥è¯¢ï¼š 1db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;}}); æŸ¥è¯¢çš„ç»“æœæ˜¯ç©ºé›†ã€‚ (2) åªæœ‰å®Œå…¨åŒ¹é…ä¸€ä¸ªçš„æ—¶å€™æ‰èƒ½è·å–åˆ°ç»“æœï¼Œå› æ­¤ï¼š 1db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27, &quot;gender&quot;:&quot;M&quot;}}); å¯ä»¥å¾—åˆ°ç»“æœã€‚ (3) å¦‚æœæŠŠé”®å€¼è¿›è¡Œé¢ å€’,ä¹Ÿå¾—ä¸åˆ°ç»“æœï¼š 1db.test.find({&quot;members&quot;:{&quot;age&quot;:27, &quot;name&quot;:&quot;BuleRiver1&quot;, &quot;gender&quot;:&quot;M&quot;}}); å¾—åˆ°çš„ç»“æœæ˜¯ç©ºé›†ã€‚ (4) æˆ‘ä»¬è¿™æ ·æŸ¥è¯¢ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;}); æ˜¯å¯ä»¥æŸ¥è¯¢å‡ºç»“æœçš„ã€‚ (5) å¦‚æœéœ€è¦ä¸¤ä¸ªå±æ€§ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;, &quot;members.age&quot;:27}); ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ (6) æˆ‘ä»¬å†è¿›è¡Œç ´åæ€§å°è¯•ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;, &quot;members.age&quot;:23}); ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ ä¸è¿‡æˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°ï¼šBuleRiver1æ˜¯æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„é”®å€¼ï¼Œè€Œ23æ˜¯æ•°ç»„ä¸­ç¬¬äºŒä¸ªå…ƒç´ çš„é”®å€¼ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ 3.ä½¿ç”¨$elemMatchæ“ä½œç¬¦æŸ¥è¯¢ å¯¹äºæˆ‘ä»¬çš„ä¸€äº›åº”ç”¨æ¥è¯´ï¼Œä»¥ä¸Šç»“æœæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä½¿ç”¨$elemMatchæ“ä½œç¬¦: (1)``$elemMatch+åŒä¸€ä¸ªå…ƒç´ ä¸­çš„é”®å€¼ç»„åˆ 1db.test.find({&quot;members&quot;:{&quot;$elemMatch&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27}}}); å¯ä»¥æŸ¥è¯¢å‡ºç»“æœï¼› (2)$elemMatch+ä¸åŒå…ƒç´ çš„é”®å€¼ç»„åˆ 1db.test.find({&quot;members&quot;:{&quot;$elemMatch&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:23}}}); æŸ¥è¯¢ä¸å‡ºç»“æœã€‚ å› æ­¤ï¼Œ(1)å±•ç¤ºçš„åµŒå¥—æŸ¥è¯¢æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„æŸ¥è¯¢æ–¹å¼ã€‚","link":"/2017/02/21/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--$elemMatch%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E4%BD%BF%E7%94%A8/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--C++æ“ä½œmongodb","text":"åœ¨å­¦ä¹ mongodbè¿‡ç¨‹å½“ä¸­ï¼Œå¿…é¡»å­¦ä¹ çš„å°±æ˜¯ç”¨C++ï¼ˆJavaã€PHPã€C#ç­‰ï¼‰æ“ä½œmongodbï¼Œè¿™é‡Œè®²è¿°C++æ“ä½œmongodbï¼Œåœ¨å®˜æ–¹æä¾›çš„mongo-cxx-driveré©±åŠ¨ä¸­æœ‰ç›¸å…³çš„æ“ä½œä¾‹å­ï¼Œå¯ä»¥ç»“åˆä¾‹å­å­¦ä¹ ï¼Œç›®å½•æ˜¯mongo-cxx-driver-legacy-1.0.0-rc0\\src\\mongo\\client\\examplesï¼Œè¿™é‡Œé’ˆå¯¹å‡ ä¸ªé‡è¦çš„ç‚¹è®²è¿°ã€‚ ##1. C++è¿æ¥mongodb ï¼ˆ1ï¼‰æœ‰æ— å¯†ç éƒ½é€‚ç”¨ 123456789101112131415161718192021mongo::client::GlobalInstance instance;if (!instance.initialized()) { std::cout &lt;&lt; &quot;failed to initialize the client driver: &quot; &lt;&lt; instance.status() &lt;&lt; std::endl; return EXIT_FAILURE;}std::string uri = &quot;mongodb://username:password@127.0.0.1:27017&quot;;std::string errmsg;ConnectionString cs = ConnectionString::parse(uri, errmsg);if (!cs.isValid()) { std::cout &lt;&lt; &quot;Error parsing connection string &quot; &lt;&lt; uri &lt;&lt; &quot;: &quot; &lt;&lt; errmsg &lt;&lt; std::endl; return EXIT_FAILURE;}boost::scoped_ptr&lt;DBClientBase&gt; conn(cs.connect(errmsg));if (!conn) { cout &lt;&lt; &quot;couldn't connect : &quot; &lt;&lt; errmsg &lt;&lt; endl; return EXIT_FAILURE;} è¿™ç§æ–¹å¼æœ‰å¯†ç å’Œæ— å¯†ç çš„æƒ…å†µéƒ½é€‚ç”¨ï¼Œ&quot;username&quot;ä¸ºç™»å½•åï¼Œ&quot;password&quot;ä¸ºç™»å½•å¯†ç ï¼›æ— å¯†ç æ—¶å»æ‰&quot;username:password@&quot;å³å¯è¿æ¥ï¼Œè¿™æ ·è¿æ¥æ–¹å¼æ¯”è¾ƒå¸¸ç”¨ã€‚ ï¼ˆ2ï¼‰å¸¸è§„è¿æ¥æ“ä½œï¼ˆä¸å¸¦å¯†ç è¿æ¥ï¼‰ 1234567891011mongo::DBClientConnection conn; mongo::Status status = mongo::client::initialize();if (!status.isOK()) { MongoException m(-1, &quot;failed to initialize the client driver: &quot; + status.toString()); return -1;}string url = &quot;localhost:27017&quot;;if (!conn.connect(url, errmsg)) { MongoException m(0, &quot;couldnâ€™t connect : &quot; + errmsg); return -1;} é€šè¿‡è¿™ç§æ–¹å¼å¯å»ºç«‹ä¸mongodbçš„è¿æ¥ï¼Œä½†æ˜¯æ˜¯æœªå¸¦æƒé™çš„è¿æ¥ã€‚ ï¼ˆ3ï¼‰å¸¦å¯†ç è¿æ¥ 1conn.auth( &quot;admin&quot; , &quot;username&quot; , &quot;password&quot; , errmsg ); å…¶ä¸­&quot;admin&quot;ä¸ºéªŒè¯ç”¨æˆ·çš„æ‰€åœ¨æ•°æ®åº“ï¼Œä¸€èˆ¬åœ¨&quot;test.system.users&quot;æˆ–&quot;admin.system.users&quot;è¡¨ä¸­ï¼Œæ‰€ä»¥å¡«åº“å&quot;test&quot;æˆ–&quot;admin&quot;ï¼Œ&quot;username&quot;ä¸ºç™»å½•åï¼Œ&quot;password&quot;ä¸ºç™»å½•å¯†ç ã€‚æˆ–è€…ä¸‹é¢çš„authæ–¹å¼ä¹Ÿå¯ä»¥ï¼š 1234conn.auth(BSON( &quot;user&quot; &lt;&lt; &quot;root&quot; &lt;&lt; &quot;db&quot; &lt;&lt; &quot;admin&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;password&quot; &lt;&lt; &quot;mechanism&quot; &lt;&lt; &quot;DEFAULT&quot;)); æ ¹æ®mongodbçš„è®¾ç½®æ›´æ”¹ä¼ é€’ç»™å‡½æ•°conn.authçš„å‚æ•°å€¼ã€‚ ##2. C++æŸ¥è¯¢æ•°æ® 123const char* ns = &quot;test.first&quot;;conn-&gt;findOne(ns, BSONObj()); //æŸ¥è¯¢ä¸€æ¡æ•°æ®conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //æ¡ä»¶æŸ¥è¯¢ ##3. C++æ’å…¥æ•°æ® 1234const char* ns = &quot;test.first&quot;;conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;123456&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 20)); ##4. C++åˆ é™¤æ•°æ® 123const char* ns = &quot;test.first&quot;;conn-&gt;remove(ns, BSONObj()); //åˆ é™¤æ‰€æœ‰conn-&gt;remove(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //åˆ é™¤æŒ‡å®šæ–‡æ¡£ ##5. C++æ›´æ–°æ•°æ® (1) åœ¨åŸæ•°æ®åŸºç¡€ä¸Šå¢åŠ å±æ€§ 1234const char* ns = &quot;test.first&quot;;BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj());BSONObj after = BSONObjBuilder().appendElements(res).append(&quot;name2&quot;, &quot;h&quot;).obj();conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;jeo2&quot;).obj(), after); //åœ¨åŸæ•°æ®ä¸Šå¢åŠ å±æ€§ è¿™ç§updateæ–¹å¼åªæ˜¯åœ¨åŸæ•°æ®åŸºç¡€ä¸Šå¢åŠ å±æ€§ï¼Œå¹¶ä¸ä¼šæ”¹å˜æŒ‡å®šå±æ€§å€¼ã€‚(2) æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼**æƒ³è¦updateæŒ‡å®šå±æ€§çš„å€¼ï¼Œéœ€è¦ç”¨åˆ°â€$setâ€æŒ‡ä»¤**ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š 123BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj());//æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼conn-&gt;update(&quot;test.first&quot;, res, BSON(&quot;$set&quot; &lt;&lt; BSON(&quot;age&quot; &lt;&lt; 11))); ä¸»è¦æƒ³å¼ºè°ƒä¸‹updateæ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼çš„æ–¹å¼ï¼Œæ¯”è¾ƒå¸¸ç”¨ã€‚ ##6. C++æ“ä½œä¾‹å­(1) simple_client_test.cpp 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127/*#if defined(_WIN32)#include &lt;winsock2.h&gt;#include &lt;windows.h&gt;#endif*///g++ simple_client_test.cpp -pthread -lmongoclient -lboost_thread -lboost_system -lboost_regex -o simple_client_test#include &quot;mongo/client/dbclient.h&quot; // the mongo c++ driver#include &lt;iostream&gt;#ifndef verify#define verify(x) MONGO_verify(x)#endifusing namespace std;using namespace mongo;//using mongo::BSONObj;//using mongo::BSONObjBuilder;int main(int argc, char* argv[]) { if (argc &gt; 2) { std::cout &lt;&lt; &quot;usage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; [MONGODB_URI]&quot; &lt;&lt; std::endl; return EXIT_FAILURE; } mongo::client::GlobalInstance instance; if (!instance.initialized()) { std::cout &lt;&lt; &quot;failed to initialize the client driver: &quot; &lt;&lt; instance.status() &lt;&lt; std::endl; return EXIT_FAILURE; } std::string uri = argc == 2 ? argv[1] : &quot;mongodb://127.0.0.1:27017&quot;; std::string errmsg; ConnectionString cs = ConnectionString::parse(uri, errmsg); if (!cs.isValid()) { std::cout &lt;&lt; &quot;Error parsing connection string &quot; &lt;&lt; uri &lt;&lt; &quot;: &quot; &lt;&lt; errmsg &lt;&lt; std::endl; return EXIT_FAILURE; } boost::scoped_ptr&lt;DBClientBase&gt; conn(cs.connect(errmsg)); if (!conn) { cout &lt;&lt; &quot;couldn't connect : &quot; &lt;&lt; errmsg &lt;&lt; endl; return EXIT_FAILURE; } const char* ns = &quot;test.first&quot;; conn-&gt;dropCollection(ns); //clean up old data from any previous tesets conn-&gt;remove(ns, BSONObj()); verify(conn-&gt;findOne(ns, BSONObj()).isEmpty()); //verifyé€»è¾‘è¡¨è¾¾å¼ï¼Œåˆ¤æ–­æ˜¯å¦è¿˜å­˜åœ¨test.firstï¼Œæ˜¯å¦clenn upæˆåŠŸ //test insert cout &lt;&lt; &quot;(1) test insert----&quot; &lt;&lt; endl; conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;123456&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 20)); verify(!conn-&gt;findOne(ns, BSONObj()).isEmpty()); //åˆ¤æ–­æ˜¯å¦æ·»åŠ æˆåŠŸ cout &lt;&lt; &quot;insert data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot;insert success!&quot; &lt;&lt; endl; // test remove cout &lt;&lt; &quot;(2) test remove----&quot; &lt;&lt; endl; conn-&gt;remove(ns, BSONObj()); verify(conn-&gt;findOne(ns, BSONObj()).isEmpty()); cout &lt;&lt; &quot;remove success!&quot; &lt;&lt; endl; // insert, findOne testing conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;234567&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 21)); { BSONObj res = conn-&gt;findOne(ns, BSONObj()); verify(strstr(res.getStringField(&quot;name&quot;), &quot;joe&quot;)); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;joe&quot;)); verify(21 == res.getIntField(&quot;age&quot;)); } cout &lt;&lt; &quot;insert data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt;endl; // test update { BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;jeo&quot;)); BSONObj after = BSONObjBuilder().appendElements(res).append(&quot;name2&quot;, &quot;w&quot;).obj(); cout &lt;&lt; &quot;(3) test update name joe add name2 name3----&quot; &lt;&lt; endl; //upsert type1 update method conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj(), after); //res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name2&quot;, &quot;w&quot;).obj()); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;joe&quot;)); verify(conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe2&quot;).obj()).isEmpty()); //cout &lt;&lt; &quot; update1 data: &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot; update1 data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name2:'w'}&quot;)) &lt;&lt; endl; //upsert type2 update method æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼ const string TEST_NS = &quot;test.first&quot;; conn-&gt;update(&quot;test.first&quot;, res, BSON(&quot;$set&quot; &lt;&lt; BSON(&quot;age&quot; &lt;&lt; 11))); cout &lt;&lt; &quot; update2 data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //upsert type3 update method try { after = BSONObjBuilder().appendElements(res).append(&quot;name3&quot;, &quot;h&quot;).obj(); conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj(), after); } catch (OperationException&amp;) { cout &lt;&lt; &quot; update error: &quot; &lt;&lt; conn-&gt;getLastErrorDetailed().toString() &lt;&lt; endl; } verify(!conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()).isEmpty()); //cout &lt;&lt; &quot; update3 data: &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot; update3 data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name3:'h'}&quot;)) &lt;&lt; endl; cout &lt;&lt; &quot;(4) test query-----&quot; &lt;&lt; &quot;\\n query data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()) &lt;&lt; endl; cout &lt;&lt; &quot; Query data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name:'joe'}&quot;)) &lt;&lt; endl; } return 0;} (2) makefileæ–‡ä»¶ 123456789101112CC = g++TEST = simple_client_test$(TEST): $(CC) $@.cpp -pthread -lmongoclient -lboost_thread -lboost_system -lboost_regex -o $@ ./$(TEST) rm -f $(TEST)run: ./$(TEST)clean: rm -f $(TEST)","link":"/2016/11/10/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0--C++%E6%93%8D%E4%BD%9Cmongodb/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--C++æ“ä½œmongodb","text":"åœ¨å­¦ä¹ mongodbè¿‡ç¨‹å½“ä¸­ï¼Œå¿…é¡»å­¦ä¹ çš„å°±æ˜¯ç”¨C++ï¼ˆJavaã€PHPã€C#ç­‰ï¼‰æ“ä½œmongodbï¼Œè¿™é‡Œè®²è¿°C++æ“ä½œmongodbï¼Œåœ¨å®˜æ–¹æä¾›çš„mongo-cxx-driveré©±åŠ¨ä¸­æœ‰ç›¸å…³çš„æ“ä½œä¾‹å­ï¼Œå¯ä»¥ç»“åˆä¾‹å­å­¦ä¹ ï¼Œç›®å½•æ˜¯mongo-cxx-driver-legacy-1.0.0-rc0\\src\\mongo\\client\\examplesï¼Œè¿™é‡Œé’ˆå¯¹å‡ ä¸ªé‡è¦çš„ç‚¹è®²è¿°ã€‚ 1. C++è¿æ¥mongodbï¼ˆ1ï¼‰æœ‰æ— å¯†ç éƒ½é€‚ç”¨ 123456789101112131415161718192021mongo::client::GlobalInstance instance;if (!instance.initialized()) { std::cout &lt;&lt; &quot;failed to initialize the client driver: &quot; &lt;&lt; instance.status() &lt;&lt; std::endl; return EXIT_FAILURE;}std::string uri = &quot;mongodb://username:password@127.0.0.1:27017&quot;;std::string errmsg;ConnectionString cs = ConnectionString::parse(uri, errmsg);if (!cs.isValid()) { std::cout &lt;&lt; &quot;Error parsing connection string &quot; &lt;&lt; uri &lt;&lt; &quot;: &quot; &lt;&lt; errmsg &lt;&lt; std::endl; return EXIT_FAILURE;}boost::scoped_ptr&lt;DBClientBase&gt; conn(cs.connect(errmsg));if (!conn) { cout &lt;&lt; &quot;couldn't connect : &quot; &lt;&lt; errmsg &lt;&lt; endl; return EXIT_FAILURE;} è¿™ç§æ–¹å¼æœ‰å¯†ç å’Œæ— å¯†ç çš„æƒ…å†µéƒ½é€‚ç”¨ï¼Œ&quot;username&quot;ä¸ºç™»å½•åï¼Œ&quot;password&quot;ä¸ºç™»å½•å¯†ç ï¼›æ— å¯†ç æ—¶å»æ‰&quot;username:password@&quot;å³å¯è¿æ¥ï¼Œè¿™æ ·è¿æ¥æ–¹å¼æ¯”è¾ƒå¸¸ç”¨ã€‚ ï¼ˆ2ï¼‰å¸¸è§„è¿æ¥æ“ä½œï¼ˆä¸å¸¦å¯†ç è¿æ¥ï¼‰ 1234567891011mongo::DBClientConnection conn; mongo::Status status = mongo::client::initialize();if (!status.isOK()) { MongoException m(-1, &quot;failed to initialize the client driver: &quot; + status.toString()); return -1;}string url = &quot;localhost:27017&quot;;if (!conn.connect(url, errmsg)) { MongoException m(0, &quot;couldnâ€™t connect : &quot; + errmsg); return -1;} é€šè¿‡è¿™ç§æ–¹å¼å¯å»ºç«‹ä¸mongodbçš„è¿æ¥ï¼Œä½†æ˜¯æ˜¯æœªå¸¦æƒé™çš„è¿æ¥ã€‚ ï¼ˆ3ï¼‰å¸¦å¯†ç è¿æ¥ 1conn.auth( &quot;admin&quot; , &quot;username&quot; , &quot;password&quot; , errmsg ); å…¶ä¸­&quot;admin&quot;ä¸ºéªŒè¯ç”¨æˆ·çš„æ‰€åœ¨æ•°æ®åº“ï¼Œä¸€èˆ¬åœ¨&quot;test.system.users&quot;æˆ–&quot;admin.system.users&quot;è¡¨ä¸­ï¼Œæ‰€ä»¥å¡«åº“å&quot;test&quot;æˆ–&quot;admin&quot;ï¼Œ&quot;username&quot;ä¸ºç™»å½•åï¼Œ&quot;password&quot;ä¸ºç™»å½•å¯†ç ã€‚æˆ–è€…ä¸‹é¢çš„authæ–¹å¼ä¹Ÿå¯ä»¥ï¼š 1234conn.auth(BSON( &quot;user&quot; &lt;&lt; &quot;root&quot; &lt;&lt; &quot;db&quot; &lt;&lt; &quot;admin&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;password&quot; &lt;&lt; &quot;mechanism&quot; &lt;&lt; &quot;DEFAULT&quot;)); æ ¹æ®mongodbçš„è®¾ç½®æ›´æ”¹ä¼ é€’ç»™å‡½æ•°conn.authçš„å‚æ•°å€¼ã€‚ 2. C++æŸ¥è¯¢æ•°æ®123const char* ns = &quot;test.first&quot;;conn-&gt;findOne(ns, BSONObj()); //æŸ¥è¯¢ä¸€æ¡æ•°æ®conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //æ¡ä»¶æŸ¥è¯¢ 3. C++æ’å…¥æ•°æ®1234const char* ns = &quot;test.first&quot;;conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;123456&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 20)); 4. C++åˆ é™¤æ•°æ®123const char* ns = &quot;test.first&quot;;conn-&gt;remove(ns, BSONObj()); //åˆ é™¤æ‰€æœ‰conn-&gt;remove(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //åˆ é™¤æŒ‡å®šæ–‡æ¡£ 5. C++æ›´æ–°æ•°æ®(1) åœ¨åŸæ•°æ®åŸºç¡€ä¸Šå¢åŠ å±æ€§ 1234const char* ns = &quot;test.first&quot;;BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj());BSONObj after = BSONObjBuilder().appendElements(res).append(&quot;name2&quot;, &quot;h&quot;).obj();conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;jeo2&quot;).obj(), after); //åœ¨åŸæ•°æ®ä¸Šå¢åŠ å±æ€§ è¿™ç§updateæ–¹å¼åªæ˜¯åœ¨åŸæ•°æ®åŸºç¡€ä¸Šå¢åŠ å±æ€§ï¼Œå¹¶ä¸ä¼šæ”¹å˜æŒ‡å®šå±æ€§å€¼ã€‚(2) æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼**æƒ³è¦updateæŒ‡å®šå±æ€§çš„å€¼ï¼Œéœ€è¦ç”¨åˆ°â€$setâ€æŒ‡ä»¤**ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š 123BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj());//æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼conn-&gt;update(&quot;test.first&quot;, res, BSON(&quot;$set&quot; &lt;&lt; BSON(&quot;age&quot; &lt;&lt; 11))); ä¸»è¦æƒ³å¼ºè°ƒä¸‹updateæ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼çš„æ–¹å¼ï¼Œæ¯”è¾ƒå¸¸ç”¨ã€‚ 6. C++æ“ä½œä¾‹å­(1) simple_client_test.cpp 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127/*#if defined(_WIN32)#include &lt;winsock2.h&gt;#include &lt;windows.h&gt;#endif*///g++ simple_client_test.cpp -pthread -lmongoclient -lboost_thread -lboost_system -lboost_regex -o simple_client_test#include &quot;mongo/client/dbclient.h&quot; // the mongo c++ driver#include &lt;iostream&gt;#ifndef verify#define verify(x) MONGO_verify(x)#endifusing namespace std;using namespace mongo;//using mongo::BSONObj;//using mongo::BSONObjBuilder;int main(int argc, char* argv[]) { if (argc &gt; 2) { std::cout &lt;&lt; &quot;usage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; [MONGODB_URI]&quot; &lt;&lt; std::endl; return EXIT_FAILURE; } mongo::client::GlobalInstance instance; if (!instance.initialized()) { std::cout &lt;&lt; &quot;failed to initialize the client driver: &quot; &lt;&lt; instance.status() &lt;&lt; std::endl; return EXIT_FAILURE; } std::string uri = argc == 2 ? argv[1] : &quot;mongodb://127.0.0.1:27017&quot;; std::string errmsg; ConnectionString cs = ConnectionString::parse(uri, errmsg); if (!cs.isValid()) { std::cout &lt;&lt; &quot;Error parsing connection string &quot; &lt;&lt; uri &lt;&lt; &quot;: &quot; &lt;&lt; errmsg &lt;&lt; std::endl; return EXIT_FAILURE; } boost::scoped_ptr&lt;DBClientBase&gt; conn(cs.connect(errmsg)); if (!conn) { cout &lt;&lt; &quot;couldn't connect : &quot; &lt;&lt; errmsg &lt;&lt; endl; return EXIT_FAILURE; } const char* ns = &quot;test.first&quot;; conn-&gt;dropCollection(ns); //clean up old data from any previous tesets conn-&gt;remove(ns, BSONObj()); verify(conn-&gt;findOne(ns, BSONObj()).isEmpty()); //verifyé€»è¾‘è¡¨è¾¾å¼ï¼Œåˆ¤æ–­æ˜¯å¦è¿˜å­˜åœ¨test.firstï¼Œæ˜¯å¦clenn upæˆåŠŸ //test insert cout &lt;&lt; &quot;(1) test insert----&quot; &lt;&lt; endl; conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;123456&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 20)); verify(!conn-&gt;findOne(ns, BSONObj()).isEmpty()); //åˆ¤æ–­æ˜¯å¦æ·»åŠ æˆåŠŸ cout &lt;&lt; &quot;insert data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot;insert success!&quot; &lt;&lt; endl; // test remove cout &lt;&lt; &quot;(2) test remove----&quot; &lt;&lt; endl; conn-&gt;remove(ns, BSONObj()); verify(conn-&gt;findOne(ns, BSONObj()).isEmpty()); cout &lt;&lt; &quot;remove success!&quot; &lt;&lt; endl; // insert, findOne testing conn-&gt;insert(ns, BSON(&quot;name&quot; &lt;&lt; &quot;joe&quot; &lt;&lt; &quot;pwd&quot; &lt;&lt; &quot;234567&quot; &lt;&lt; &quot;age&quot; &lt;&lt; 21)); { BSONObj res = conn-&gt;findOne(ns, BSONObj()); verify(strstr(res.getStringField(&quot;name&quot;), &quot;joe&quot;)); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;joe&quot;)); verify(21 == res.getIntField(&quot;age&quot;)); } cout &lt;&lt; &quot;insert data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt;endl; // test update { BSONObj res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;jeo&quot;)); BSONObj after = BSONObjBuilder().appendElements(res).append(&quot;name2&quot;, &quot;w&quot;).obj(); cout &lt;&lt; &quot;(3) test update name joe add name2 name3----&quot; &lt;&lt; endl; //upsert type1 update method conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj(), after); //res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name2&quot;, &quot;w&quot;).obj()); verify(!strstr(res.getStringField(&quot;name2&quot;), &quot;joe&quot;)); verify(conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe2&quot;).obj()).isEmpty()); //cout &lt;&lt; &quot; update1 data: &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot; update1 data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name2:'w'}&quot;)) &lt;&lt; endl; //upsert type2 update method æ›´æ”¹æŒ‡å®šçš„æŸä¸ªå±æ€§å€¼ const string TEST_NS = &quot;test.first&quot;; conn-&gt;update(&quot;test.first&quot;, res, BSON(&quot;$set&quot; &lt;&lt; BSON(&quot;age&quot; &lt;&lt; 11))); cout &lt;&lt; &quot; update2 data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; res = conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()); //upsert type3 update method try { after = BSONObjBuilder().appendElements(res).append(&quot;name3&quot;, &quot;h&quot;).obj(); conn-&gt;update(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj(), after); } catch (OperationException&amp;) { cout &lt;&lt; &quot; update error: &quot; &lt;&lt; conn-&gt;getLastErrorDetailed().toString() &lt;&lt; endl; } verify(!conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()).isEmpty()); //cout &lt;&lt; &quot; update3 data: &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObj()) &lt;&lt; endl; cout &lt;&lt; &quot; update3 data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name3:'h'}&quot;)) &lt;&lt; endl; cout &lt;&lt; &quot;(4) test query-----&quot; &lt;&lt; &quot;\\n query data : &quot; &lt;&lt; conn-&gt;findOne(ns, BSONObjBuilder().append(&quot;name&quot;, &quot;joe&quot;).obj()) &lt;&lt; endl; cout &lt;&lt; &quot; Query data : &quot; &lt;&lt; conn-&gt;findOne(ns, Query(&quot;{name:'joe'}&quot;)) &lt;&lt; endl; } return 0;} (2) makefileæ–‡ä»¶ 123456789101112CC = g++TEST = simple_client_test$(TEST): $(CC) $@.cpp -pthread -lmongoclient -lboost_thread -lboost_system -lboost_regex -o $@ ./$(TEST) rm -f $(TEST)run: ./$(TEST)clean: rm -f $(TEST)","link":"/2016/11/10/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0C++%E6%93%8D%E4%BD%9Cmongodb/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--$elemMatchæ“ä½œç¬¦çš„ä½¿ç”¨","text":"mongodbæä¾›äº†å¾ˆå¤šæ“ä½œç¬¦ä»¥ä¾¿æ›´åŠ æ–¹ä¾¿å¿«æ·åœ°æ“ä½œæ•°æ®ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è®¤è¯†ä¸€ä¸‹æŸ¥è¯¢æ“ä½œç¬¦$elemMatchï¼Œ$elemMatchæŠ•å½±æ“ä½œç¬¦å°†é™åˆ¶æŸ¥è¯¢è¿”å›çš„æ•°ç»„å­—æ®µçš„å†…å®¹åªåŒ…å«åŒ¹é…$elemMatchæ¡ä»¶çš„æ•°ç»„å…ƒç´ ã€‚ æ³¨æ„ï¼š æ•°ç»„ä¸­å…ƒç´ æ˜¯å†…åµŒæ–‡æ¡£ã€‚ å¦‚æœå¤šä¸ªå…ƒç´ åŒ¹é…$elemMatchæ¡ä»¶ï¼Œæ“ä½œç¬¦è¿”å›æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªåŒ¹é…æ¡ä»¶çš„å…ƒç´ ã€‚ 1.é¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•æ–‡æ¡£1db.test.insert({&quot;id&quot;:1, &quot;members&quot;:[{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27, &quot;gender&quot;:&quot;M&quot;}, {&quot;name&quot;:&quot;BuleRiver2&quot;, &quot;age&quot;:23, &quot;gender&quot;:&quot;F&quot;}, {&quot;name&quot;:&quot;BuleRiver3&quot;, &quot;age&quot;:21, &quot;gender&quot;:&quot;M&quot;}]}); 2.ä½¿ç”¨å¤šç§æ–¹å¼å°è¯•æŸ¥è¯¢(1) ä½¿ç”¨db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;}});è¿›è¡ŒæŸ¥è¯¢ï¼š 1db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;}}); æŸ¥è¯¢çš„ç»“æœæ˜¯ç©ºé›†ã€‚ (2) åªæœ‰å®Œå…¨åŒ¹é…ä¸€ä¸ªçš„æ—¶å€™æ‰èƒ½è·å–åˆ°ç»“æœï¼Œå› æ­¤ï¼š 1db.test.find({&quot;members&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27, &quot;gender&quot;:&quot;M&quot;}}); å¯ä»¥å¾—åˆ°ç»“æœã€‚ (3) å¦‚æœæŠŠé”®å€¼è¿›è¡Œé¢ å€’,ä¹Ÿå¾—ä¸åˆ°ç»“æœï¼š 1db.test.find({&quot;members&quot;:{&quot;age&quot;:27, &quot;name&quot;:&quot;BuleRiver1&quot;, &quot;gender&quot;:&quot;M&quot;}}); å¾—åˆ°çš„ç»“æœæ˜¯ç©ºé›†ã€‚ (4) æˆ‘ä»¬è¿™æ ·æŸ¥è¯¢ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;}); æ˜¯å¯ä»¥æŸ¥è¯¢å‡ºç»“æœçš„ã€‚ (5) å¦‚æœéœ€è¦ä¸¤ä¸ªå±æ€§ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;, &quot;members.age&quot;:27}); ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ (6) æˆ‘ä»¬å†è¿›è¡Œç ´åæ€§å°è¯•ï¼š 1db.test.find({&quot;members.name&quot;:&quot;BuleRiver1&quot;, &quot;members.age&quot;:23}); ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ ä¸è¿‡æˆ‘ä»¬åº”è¯¥æ³¨æ„åˆ°ï¼šBuleRiver1æ˜¯æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ çš„é”®å€¼ï¼Œè€Œ23æ˜¯æ•°ç»„ä¸­ç¬¬äºŒä¸ªå…ƒç´ çš„é”®å€¼ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºç»“æœã€‚ 3.ä½¿ç”¨$elemMatchæ“ä½œç¬¦æŸ¥è¯¢ å¯¹äºæˆ‘ä»¬çš„ä¸€äº›åº”ç”¨æ¥è¯´ï¼Œä»¥ä¸Šç»“æœæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä½¿ç”¨$elemMatchæ“ä½œç¬¦: (1)``$elemMatch+åŒä¸€ä¸ªå…ƒç´ ä¸­çš„é”®å€¼ç»„åˆ 1db.test.find({&quot;members&quot;:{&quot;$elemMatch&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:27}}}); å¯ä»¥æŸ¥è¯¢å‡ºç»“æœï¼› (2)$elemMatch+ä¸åŒå…ƒç´ çš„é”®å€¼ç»„åˆ 1db.test.find({&quot;members&quot;:{&quot;$elemMatch&quot;:{&quot;name&quot;:&quot;BuleRiver1&quot;, &quot;age&quot;:23}}}); æŸ¥è¯¢ä¸å‡ºç»“æœã€‚ å› æ­¤ï¼Œ(1)å±•ç¤ºçš„åµŒå¥—æŸ¥è¯¢æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„æŸ¥è¯¢æ–¹å¼ã€‚","link":"/2017/02/21/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0elemMatch%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E4%BD%BF%E7%94%A8/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–","text":"æœ‰æ—¶å€™æˆ‘ä»¬åœ¨éå…³ç³»æ•°æ®åº“mongodbåšä¸€äº›ç®€å•çš„åˆ†ææŸ¥è¯¢ï¼Œæ¯”å¦‚åˆ†é¡µã€‚mongodbæœ¬èº«æä¾›äº†åˆ†é¡µçš„apiï¼Œä½†æ˜¯æ¯”è¾ƒæœ‰é™ã€‚ 1ã€åˆ†é¡µapimongodbè‡ªèº«æä¾›äº†ç±»ä¼¼mysqlçš„åˆ†é¡µå…³é”®å­—ï¼š æŸ¥è¯¢æ—¶ 1query.skip((pageNum - 1)*pageSize).limit(pageSize); éœ€è¦æ˜¯è·³è·ƒæŸ¥è¯¢ï¼Œä½†æ˜¯è¾¾åˆ°ä¸€å®šæ•°æ®é‡çº§çš„ï¼ŒæŸ¥è¯¢æ•ˆç‡å¾ˆä½ï¼Œç”šè‡³æŸ¥ä¸åŠ¨ã€‚ skipè¾¾åˆ°ä¸€å®šæ•°æ®é‡æ—¶ï¼Œè¶…è¿‡äº†ç³»ç»Ÿé»˜è®¤çš„32MBå†…å­˜æ’åºï¼Œæ‰€ä»¥mongoé‡æ–°ä½¿ç”¨äº†å…¶ä»–ç®—æ³•æ’åºï¼Œå‡ºç°å¤§é‡æ‰«æï¼Œå¯¼è‡´æ…¢æŸ¥è¯¢ã€‚ è¿™ä¸ªå†™æ³•å’Œmysqlçš„limit offset,rowsç±»ä¼¼ï¼š ä¸‹é¢ä¸¤æ¡è¯­å¥æ˜¯ç­‰ä»·çš„ã€‚ 123select id from collect limit 1000000,10;#**MySQL5.0ä¹‹åæ”¯æŒè¯¥è¯­æ³•**select id from collect limit 10 offset 1000000; ç­‰äºæ˜¯ä¸€ç›´å¾€åè¯»å–åˆ°ç¬¬1000000æ¡ï¼Œå¼€å§‹å–10æ¡ï¼Œè¯»å–äº†1000000æ²¡ç”¨çš„æ•°æ®ï¼Œmysqlçš„ä¼˜åŒ–æ–¹å¼æ˜¯æ‰¾åˆ°ç¬¬1000000æ¡æ•°æ®çš„idï¼Œå¼€å§‹è¯»å–10æ¡ï¼Œä¸»è¦æ˜¯åˆ©ç”¨ç´¢å¼•ä½ç½®æ¥å®šä½åˆ†é¡µèµ·å§‹ä½ï¼š 1select id from collect where id&gt;1000000 limit 10; æŸ¥è¯¢è¿‡ç¨‹ç»è¿‡äº†pageNum*pageSizeæ¡æ•°æ®ã€‚ 1234567graph LRweb--&gt;pageNumweb--&gt;pageSizepageNum--&gt;pageNum*pageSizepageSize--&gt;pageNum*pageSizepageNum*pageSize--&gt;skipskip--&gt;limitç¬¬pageNumé¡µçš„æ•°æ® 2ã€ä¼˜åŒ–æ–¹å‘ç­‰å®˜æ–¹ä¼˜åŒ–skip()ç¡®å®šæ—¶é—´ï¼Œæ¯•ç«Ÿmongoä½¿ç”¨åœºæ™¯ä¹Ÿå¤§å¤šä¸æ˜¯ç”¨æ¥åˆ†é¡µï¼Œé‚£ä¹ˆåªèƒ½é¿å…ä½¿ç”¨skip()ã€‚ä¸ä½¿ç”¨skip()é‚£æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬å€ŸåŠ©å…¶ä»–å‡½æ•°æ›²çº¿æ•‘å›½ï¼Œæ¯”å¦‚sort()æ’åºå’Œ limit() ï¼Œå’Œmysqlçš„ä¼˜åŒ–æ–¹å‘ä¸€æ ·ï¼ŒçŸ¥é“èµ·å§‹idå†æŸ¥è¯¢å½“å‰é¡µï¼Œç†è®ºä¸Šä¼šå¿«å¾ˆå¤šã€‚ç›¸å½“äºè·³è¿‡äº†pageNum*pageSizeæ¡æ•°æ®ã€‚ 123456789graph LRweb--&gt;pageNumweb--&gt;pageSizepageNum--&gt;pageNum*pageSizeçš„æ•°æ®_idpageSize--&gt;pageNum*pageSizeçš„æ•°æ®_idpageNum*pageSizeçš„æ•°æ®_id--&gt;ä½¿ç”¨$gtå‡½æ•°å¤§äº_idpageNum*pageSizeçš„æ•°æ®_id--&gt;skipè·³é¡µpageSizeä½¿ç”¨$gtå‡½æ•°å¤§äº_id--&gt;ç¬¬pageNumé¡µçš„æ•°æ®skipè·³é¡µpageSize--&gt;ç¬¬pageNumé¡µçš„æ•°æ® 3ã€å®ç°å¯¹è±¡ä¸­è®¾ç½®idå±æ€§å³å¯å¾—åˆ°_idçš„å€¼ï¼ŒStringçš„è¯å¾—åˆ°ä¸€ä¸²åå…­è¿›åˆ¶çš„å­—ç¬¦æ„æˆçš„å­—ç¬¦ä¸²ï¼Œå…·ä½“æ„æˆå¯æŸ¥çœ‹ObjectIdçš„æ„æˆã€‚ å‡è®¾å®ä½“å¯¹è±¡ä¸ºGoodsï¼Œè®¾ç½®idå±æ€§ï¼š 1private String id; å°†å¾—åˆ°_idè®¾ç½®ä¸ºåˆ†é¡µçš„èµ·å§‹_idï¼Œï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930public List&lt;Goods&gt; getListByPage(int pageNum, int pageSize) { List&lt;Goods&gt; goodsList; Query query = new Query(); // é€šè¿‡ _id æ­£åºæ’åº query.with(Sort.by(Sort.Direction.ASC, &quot;_id&quot;)); if (pageNum != 1) { // number å‚æ•°æ˜¯ä¸ºäº†æŸ¥ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡æ•°æ® int number = (pageNum - 1) * pageSize; query.limit(number); List&lt;Goods&gt; goodsListTemp = mongoTemplate.find(query, Goods.class); // å–å‡ºæœ€åä¸€æ¡ Goods goods = goodsListTemp.get(goodsListTemp.size() - 1); // å–åˆ°ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡æ•°æ®_idï¼Œå½“ä½œæ¡ä»¶æŸ¥æ¥ä¸‹æ¥çš„æ•°æ® String id = goods.getId(); // ä»ä¸Šä¸€é¡µæœ€åä¸€æ¡å¼€å§‹æŸ¥ï¼ˆå¤§äºä¸åŒ…æ‹¬è¿™ä¸€æ¡ï¼‰ query.addCriteria(Criteria.where(&quot;_id&quot;).gt(id)); } // é¡µå¤§å°é‡æ–°èµ‹å€¼ï¼Œè¦†ç›– number å‚æ•° query.limit(pageSize); // å³å¯å¾—åˆ°ç¬¬né¡µæ•°æ® goodsList = mongoTemplate.find(query, Goods.class); return goodsList;} è¿™æ ·çš„é¿å…äº†skip()çš„ä½¿ç”¨ï¼Œé€šè¿‡sort()æ’åºå’Œ limit() é™åˆ¶æ•°æ®å¤§å°ç»“åˆæ’åºï¼Œæ¯ä¸€æ¬¡åˆ†é¡µæŸ¥è¯¢ä»æ•°æ®çš„ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡æ•°æ®ä½œä¸ºèµ·å§‹ä½ç½®ï¼Œå†æŸ¥è¯¢é¡µå¤§å°çš„æ•°æ®é‡ã€‚ 4ã€å»ºè®®ä»ä»£ç è¡¨ç°ä¸Šæ¥çœ‹ï¼Œæ¯ä¸€æ¬¡æŸ¥è¯¢éƒ½éœ€è¦é€šè¿‡æŸ¥è¯¢å½“å‰é¡µä¹‹å‰çš„æ‰€æœ‰æ•°æ®æ¥å¾—åˆ°èµ·å§‹ä½ç½®çš„_idï¼Œç›¸å½“äºæŸ¥è¯¢äº†å¤§é‡æ•°æ®ï¼Œå¯¹å†…å­˜æ¶ˆè€—è¾ƒå¤§ã€‚ é’ˆå¯¹é¡µæ•°ä¸æ˜¯ç‰¹åˆ«å¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ç§ä¼˜åŒ–æ–¹å¼ä¹Ÿæ˜¯æ¯”skip()æ•ˆç‡è¦é«˜çš„ã€‚ å¦‚æœé¡µæ•°ç‰¹åˆ«å¤šï¼Œæ¯é¡µsizeä¹Ÿè¾ƒå¤§ï¼Œé‚£ä¹ˆä¸ç®¡æ˜¯ä»€ä¹ˆç±»å‹çš„æ•°æ®åº“å‹åŠ›ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦ä»ä¸šåŠ¡æ–¹é¢è€ƒé‡ï¼Œä¸é€‚åˆåšåˆ†é¡µï¼Œæˆ–è€…å°†åˆ†æå‹ä¸šåŠ¡ç‹¬ç«‹ï¼Œè¿™æ ·çš„åˆ†æç»Ÿè®¡ç±»æ“ä½œå¯ä»¥æ”¾åˆ°Elasticsearchç­‰æ›´é€‚åˆçš„å­˜å‚¨ä¸Šã€‚","link":"/2020/09/13/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/"},{"title":"mongodbå­¦ä¹ ç¬”è®°--å®ç°è‡ªå¢IDåºåˆ—","text":"åœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åˆ©ç”¨æ•°æ®çš„è‡ªå¢idç‰¹æ€§æ¥ä½œä¸ºæ•°æ®é›†çš„è‡ªå¢æ’åºæŸ¥æ‰¾ç­‰æ“ä½œã€‚æˆ–è€…ç›¸åŒçš„æ•°æ®åˆ†å¸ƒåœ¨å¤šä»½å­˜å‚¨ä¸Šã€‚ å¹¶ä¸”å­˜åœ¨å¯¹æ¡æ•°æ®éœ€è¦é€šè¿‡è¿™ä¸ªidè¿›è¡Œå…³è”ï¼Œç±»ä¼¼äºå¤–é”®ç‰¹æ€§ï¼Œè¿™å°±éœ€è¦å°†idå’Œæ•°æ®åˆ†ç¦»ã€‚ æµç¨‹ï¼š 12345graph LRid--&gt;DB1id--&gt;DB2DB1--&gt;åˆå¹¶æ•°æ®DB2--&gt;åˆå¹¶æ•°æ® è¿™é‡Œåˆ—ä¸¾äº†mysqlã€oracleã€mongodbä¸‰ç§æ•°æ®çš„è‡ªå¢åºåˆ—å®ç°æ–¹å¼ã€‚ 1ã€mysqlçš„è‡ªå¢idâ€‹ mysqlçš„è‡ªå¢idæ˜¯å’Œæ•°æ®ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œæ— æ³•åˆ†å¼€ï¼Œç­‰äºä½ idçš„å¢åŠ æ˜¯ä¼´éšç€æ•°æ®åº“çš„æ•°æ®æ–°å¢è€Œæ¥ã€‚ é‚£æœ‰æ²¡æœ‰åŠæ³•åˆ†å¼€å‘¢ï¼Ÿ â€‹ ä¹Ÿæ˜¯æœ‰çš„ï¼Œéœ€è¦å€ŸåŠ©æ•°æ®åº“å‡½æ•°æ¥å®ç°ã€‚ä½†æ˜¯ä¸€èˆ¬ä¸å»ºè®®ä½¿ç”¨ï¼Œéœ€è¦å¯¹å‡½æ•°è¿›è¡Œåˆ†æåŠ å‚æ•°ä¿®é¥°ï¼Œå¦‚å‡½æ•°é‡ŒåŠ å…³é”®å­—READS SQL DATAï¼ˆåªæŸ¥è¯¢æ—¶ä½¿ç”¨ï¼‰ã€DETERMINISTICï¼ˆå­˜åœ¨æ›´æ–°æ—¶ä½¿ç”¨ï¼‰ï¼Œä¸ç„¶æ•°æ®åº“ä¼šå‘Šè­¦ï¼Œä¼šä¸€å®šç¨‹åº¦å½±å“dmlæ€§èƒ½ã€‚ å…¶åŸç†å°±æ˜¯æ¯æŸ¥è¯¢ä¸€æ¬¡æ›´æ–°sequenceçš„å€¼ã€‚ å…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839--1ã€æ–°å»ºåºåˆ—è¡¨drop table if exists test_sequence;create table test_sequence (seq_name VARCHAR(50) NOT NULL, -- åºåˆ—åç§°current_val bigint NOT NULL, -- å½“å‰å€¼increment_val bigint NOT NULL DEFAULT 1, -- æ­¥é•¿(è·¨åº¦)PRIMARY KEY (seq_name)); --2ã€æ–°å¢ä¸€ä¸ªåºåˆ—INSERT INTO test_sequence VALUES ('user_seq', '0', '1');INSERT INTO test_sequence VALUES ('class_seq', '0', '1');INSERT INTO test_sequence VALUES ('school_seq', '0', '1');INSERT INTO test_sequence VALUES ('data_seq', '0', '1'); --3ã€åˆ›å»ºcurrvalå‡½æ•°ï¼Œç”¨äºè·å–åºåˆ—å½“å‰å€¼create function seq_currval(v_seq_name VARCHAR(50))returns bigint(20)begindeclare value integer;set value = 0;select current_val into value from test_sequence where seq_name = v_seq_name;return value;end; --4ã€æŸ¥è¯¢å½“å‰å€¼select seq_currval('ge_rns_user_info_seq'); --5ã€åˆ›å»ºnextvalå‡½æ•°ï¼Œç”¨äºè·å–åºåˆ—ä¸‹ä¸€ä¸ªå€¼create function seq_nextval (v_seq_name VARCHAR(50)) returns bigint(20)beginupdate test_sequence set current_val = current_val + increment_val where seq_name = v_seq_name;return seq_currval(v_seq_name);end; --6ã€æŸ¥è¯¢ä¸‹ä¸€ä¸ªå€¼select seq_nextval('user_seq');--7ã€æŸ¥è¯¢æ‰€æœ‰sequenceselect * from test_sequence; ä½¿ç”¨ 2ã€oracleçš„è‡ªå¢sequenceoracleçš„è‡ªå¢sequenceæ˜¯ç‹¬ç«‹äºæ•°æ®çš„ï¼Œå¯¹äºè¿ç§»ç»´æŠ¤æ¯”è¾ƒæ–¹ä¾¿ã€‚å…·ä½“ä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011121314151617181920--1ã€é¦–å…ˆå»ºä¸€ä¸ªè¡¨TESTcreate table TEST( NID int PRIMARY KEY, test1 varchar2(20), test2 varchar2(20), test3 varchar2(20), test4 varchar2(20), test5 varchar2(20))--2ã€å†å»ºä¸€ä¸ªåºåˆ—SEQ_TESTcreate sequence SEQ_TESTminvalue 1 --æœ€å°å€¼nomaxvalue --ä¸è®¾ç½®æœ€å¤§å€¼start with 1 --ä»1å¼€å§‹è®¡æ•°increment by 1 --æ¯æ¬¡åŠ 1ä¸ªnocycle --ä¸€ç›´ç´¯åŠ ï¼Œä¸å¾ªç¯nocache; --ä¸å»ºç¼“å†²åŒº ç„¶ååœ¨é¡¹ç›®çš„mybatisä¸­ä½¿ç”¨ä¸‹é¢çš„è¯­å¥èµ‹å€¼åˆ°æ•°æ®idä¸Šå³å¯ï¼› 1SELECT SEQ_TEST FROM DUAL å°±æ˜¯è¿™ä¹ˆçš„ç®€å•ï¼Œso easy! 3ã€mongoå®ç°è‡ªåŠ¨å¢é•¿sequenceä¸¥æ ¼æ¥è¯´mongodbæœ¬èº«æ²¡æœ‰è‡ªå¢åºåˆ—ç›¸å…³çš„åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬äº†è§£åˆ°mongodbæä¾›äº†åŸå­æ“ä½œçš„å‡½æ•°$incï¼Œæ—¢ç„¶æ˜¯åŸå­æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨è¿™ä¸Šé¢åšæ–‡ç« ï¼Œè‡ªå¢idä¹Ÿæ˜¯å…¨å±€å”¯ä¸€ï¼Œé‚£ä¹ˆæœ‰äº†åŸå­æ“ä½œï¼Œæˆ‘ä»¬çš„è‡ªå¢æ“ä½œå°±èƒ½å¤Ÿæ»¡è¶³ã€‚åœ¨æ¯æ¬¡è¿›è¡Œæ’å…¥æ“ä½œçš„æ—¶å€™ï¼Œåºåˆ—å€¼åŠ 1ï¼Œä½œä¸ºæœ¬æ¬¡æ“ä½œçš„idã€‚ å…·ä½“å®ç°å¦‚ä¸‹ï¼š 1ã€å®šä¹‰sequenceå¯¹è±¡1234567891011121314151617181920212223import org.springframework.data.annotation.Id;public class MongoSequence { @Id private String id; private long nextVal; public String getId() { return id; } public void setId(String id) { this.id = id; } public long getNextVal() { return nextVal; } public void setNextVal(long nextVal) { this.nextVal = nextVal; }} 2ã€åˆ›å»ºè‡ªå¢åºåˆ—å·¥å…·ç±»å–å·å·¥å…·ç±»MongoAutoIdUtil.javaï¼š 1234567891011121314@Componentpublic class MongoAutoIdUtil { @Autowired private MongoTemplate mongoTemplate; public long getNextSequenceByCol(String collectionName) { MongoSequence sequence = mongoTemplate.findAndModify(Query.query(where(&quot;_id&quot;).is(collectionName)), new Update().inc(&quot;nextVal&quot;, 1L), options().upsert(true).returnNew(true), MongoSequence.class); return sequence.getNextVal(); }} æœ‰æ²¡æœ‰å‘ç°è¿™é‡Œçš„updateæ“ä½œå¹¶æ²¡æœ‰é›†åˆåç§°ï¼Œé‚£ä¹ˆå…·ä½“æ˜¯æ›´æ–°å“ªä¸ªé›†åˆå‘¢ï¼Ÿä¼šä¸ä¼šå¤±è´¥ï¼Ÿ åˆ«æ‹…å¿ƒï¼Œå¦‚æœä¸è®¾ç½®é›†åˆçš„è¯ï¼Œæ‰§è¡Œçš„æ—¶å€™mongodbè‡ªå·±ä¼šæ–°å¢ä¸€ä¸ªé»˜è®¤é›†åˆåå­—å«mongoSequenceï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¼ å…¥æˆ‘ä»¬æƒ³è¦çš„åºåˆ—åå³å¯ã€‚ç„¶ååœ¨mongodbæ§åˆ¶å°ä¸­å°±èƒ½çœ‹åˆ°mongoSequenceé›†åˆä¸­å­˜åœ¨äº†æˆ‘ä»¬æƒ³è¦çš„éœ€è¦ï¼Œæ¯æ¬¡åªè¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•è·å–çš„å°±æ˜¯è‡ªå¢çš„idã€‚ 3ã€å‡½æ•°æ€§èƒ½é‚£è¿™ä¸ªå‡½æ•°çš„æ€§èƒ½æ€æ ·å‘¢ï¼Ÿ æ€§èƒ½çš„è¯ï¼Œæˆ‘ç¨å¾®æµ‹è¯•äº†ä¸‹ï¼Œ50~200ä¸ªå¹¶å‘å–idæ²¡æœ‰å‡ºç°idé‡å¤çš„æƒ…å†µï¼Œå¹¶ä¸”è‡ªå¢æ— è¯¯ã€‚å†é«˜çš„å¹¶å‘æœ¬æœº4æ ¸cpuå¤ªå¼±ï¼Œæµ‹è¯•å°±ä¸å†å…·æœ‰å‚è€ƒæ€§ï¼Œå°±ä½œç½¢äº†ã€‚ å®˜æ–¹çš„è§£é‡Šæ˜¯incä¸setæ€§èƒ½ç›¸å½“ï¼Œæ¯”$pushå¿«ã€‚ åœ¨å®é™…è¿ç”¨è¿‡ç¨‹å½“ä¸­ä¹Ÿæ²¡æœ‰å‡ºç°é‡å¤å–å’Œè‡ªå¢å‡ºé”™çš„æƒ…å†µï¼Œè¿è¡Œè‰¯å¥½ã€‚ ä¸è¿‡æ—¢ç„¶é€‰æ‹©äº†mongodbï¼Œé‚£ä¹ˆæœ€å¥½åˆ©ç”¨éå…³ç³»æ•°æ®åº“çš„ç‰¹æ€§ï¼Œå‘æŒ¥å®ƒæœ€å¤§çš„æ€§èƒ½ï¼Œä¸è¦å°†è‡ªå¢idè¿™æ ·çš„åœºæ™¯æ”¾åœ¨mongodbä¸Šæ“ä½œã€‚ æ¯”å¦‚å®ƒæœ¬èº«çš„_idå…¶å®å°±æ˜¯ä¸ªå¾ˆå¥½çš„å…¨å±€å”¯ä¸€å¹¶ä¸”æ”¯æŒæ’åºçš„åºåˆ—ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹_idè¿›è¡Œèµ‹å€¼ï¼Œè®¾ç½®æˆ‘ä»¬è‡ªå·±çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚è®¾ç½®ä¸ºä¸Šé¢çš„è‡ªå¢idçš„æ•°å­—ï¼Œä½†æ˜¯ä¸æ¨èã€‚ å®˜æ–¹é’ˆå¯¹_idçš„æœ‰è§£é‡Šï¼Œå°‘é‡æ•°æ®é‡çš„æƒ…å†µä¸‹ï¼Œå¯¹_idè¿›è¡Œèµ‹å€¼å’Œä¸èµ‹å€¼æ€§èƒ½å·®åˆ«ä¸å¤§ï¼Œä½†è¾¾åˆ°ä¸€å®šæ•°æ®é‡çš„æ—¶å€™ï¼Œ_idè‡ªåŠ¨èµ‹å€¼æ¯”æ‰‹åŠ¨èµ‹å€¼æ€§èƒ½è¦å¥½ï¼Œå› ä¸ºéœ€è¦é¢å¤–å¯¹æˆ‘ä»¬æ‰‹åŠ¨èµ‹çš„å€¼åšä¸€æ¬¡å¤šåˆ†ç‰‡å…¨å±€å”¯ä¸€æ€§çš„æ£€æŸ¥æ“ä½œï¼Œè¿™æ²¡æœ‰mongodbè‡ªå·±çš„ç”Ÿæˆç®—æ³•æ¥å¾—å¿«ã€‚","link":"/2020/09/25/mongodb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%A2%9EID%E5%BA%8F%E5%88%97/"},{"title":"mybatisä¸­çš„#{}å’Œ${}çš„åŒºåˆ«","text":"åœ¨ä½¿ç”¨mybatisæ—¶éƒ½ä¼šç”¨åˆ°#{}å’Œ${}ç¬¦å·æ¥è¿›è¡Œä¼ å€¼ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸¤è€…çš„åŒºåˆ«ã€‚ 1. ç‰¹å¾ #{}å°†ä¼ å…¥çš„æ•°æ®éƒ½å½“æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¼šå¯¹è‡ªåŠ¨ä¼ å…¥çš„æ•°æ®åŠ ä¸€ä¸ªåŒå¼•å·ã€‚å¦‚ï¼šorder by #user_id#ï¼Œå¦‚æœä¼ å…¥çš„å€¼æ˜¯111,é‚£ä¹ˆè§£ææˆsqlæ—¶çš„å€¼ä¸ºorder by &quot;111&quot;, å¦‚æœä¼ å…¥çš„å€¼æ˜¯idï¼Œåˆ™è§£ææˆçš„sqlä¸ºorder by &quot;id&quot; ã€‚ ${}å°†ä¼ å…¥çš„æ•°æ®ç›´æ¥æ˜¾ç¤ºç”Ÿæˆåœ¨sqlä¸­ã€‚å¦‚ï¼šorder by $user_id$ï¼Œå¦‚æœä¼ å…¥çš„å€¼æ˜¯111,é‚£ä¹ˆè§£ææˆsqlæ—¶çš„å€¼ä¸ºorder by 111, å¦‚æœä¼ å…¥çš„å€¼æ˜¯idï¼Œåˆ™è§£ææˆçš„sqlä¸ºorder by id. #{}æ–¹å¼èƒ½å¤Ÿå¾ˆå¤§ç¨‹åº¦é˜²æ­¢sqlæ³¨å…¥ã€‚ ${}æ–¹å¼æ— æ³•é˜²æ­¢Sqlæ³¨å…¥ã€‚ ${}æ–¹å¼ä¸€èˆ¬ç”¨äºä¼ å…¥æ•°æ®åº“å¯¹è±¡ï¼Œä¾‹å¦‚ä¼ å…¥è¡¨åã€‚ ä¸€èˆ¬èƒ½ç”¨#{}çš„å°±åˆ«ç”¨${} ã€‚ mybatisæ’åºæ—¶ä½¿ç”¨order by åŠ¨æ€å‚æ•°æ—¶éœ€è¦æ³¨æ„ï¼Œç”¨${}è€Œä¸æ˜¯#{} 2. å­—ç¬¦ä¸²æ›¿æ¢é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨#{}æ ¼å¼çš„è¯­æ³•ä¼šå¯¼è‡´mybatisåˆ›å»ºé¢„å¤„ç†è¯­å¥å±æ€§å¹¶ä»¥å®ƒä¸ºèƒŒæ™¯è®¾ç½®å®‰å…¨çš„å€¼ï¼ˆæ¯”å¦‚?ï¼‰ã€‚è¿™æ ·åšå¾ˆå®‰å…¨ï¼Œå¾ˆè¿…é€Ÿä¹Ÿæ˜¯é¦–é€‰åšæ³•ï¼Œæœ‰æ—¶ä½ åªæ˜¯æƒ³ç›´æ¥åœ¨SQLè¯­å¥ä¸­æ’å…¥ä¸€ä¸ªä¸æ”¹å˜çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ï¼ŒåƒORDER BYï¼Œä½ å¯ä»¥è¿™æ ·æ¥ä½¿ç”¨ï¼š 1ORDER BY ${columnName} è¿™é‡Œmybatisä¸ä¼šä¿®æ”¹æˆ–è½¬ä¹‰å­—ç¬¦ä¸²ã€‚ é‡è¦ï¼šæ¥å—ä»ç”¨æˆ·è¾“å‡ºçš„å†…å®¹å¹¶æä¾›ç»™è¯­å¥ä¸­ä¸å˜çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ã€‚è¿™ä¼šå¯¼è‡´æ½œåœ¨çš„SQLæ³¨å…¥æ”»å‡»ï¼Œå› æ­¤ä½ ä¸åº”è¯¥å…è®¸ç”¨æˆ·è¾“å…¥è¿™äº›å­—æ®µï¼Œæˆ–è€…é€šå¸¸è‡ªè¡Œè½¬ä¹‰å¹¶æ£€æŸ¥ã€‚ 3. mybatis æœ¬èº«çš„è¯´æ˜12345678String SubstitutionBy default, using the #{} syntax will cause MyBatis to generate PreparedStatement properties and set the values safely against the PreparedStatement parameters (e.g. ?). While this is safer, faster and almost always preferred, sometimes you just want to directly inject a string unmodified into the SQL Statement. For example, for ORDER BY, you might use something like this:ORDER BY ${columnName}Here MyBatis won't modify or escape the string.NOTE It's not safe to accept input from a user and supply it to a statement unmodified in this way. This leads to potential SQL Injection attacks and therefore you should either disallow user input in these fields, or always perform your own escapes and checks. ä»ä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼š ä½¿ç”¨#{}æ ¼å¼çš„è¯­æ³•åœ¨mybatisä¸­ä½¿ç”¨Preparementè¯­å¥æ¥å®‰å…¨çš„è®¾ç½®å€¼ï¼Œæ‰§è¡Œsqlç±»ä¼¼ä¸‹é¢çš„ï¼š 12PreparedStatement ps = conn.prepareStatement(sql);ps.setInt(1,id); è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šæ›´å®‰å…¨ï¼Œæ›´è¿…é€Ÿï¼Œé€šå¸¸ä¹Ÿæ˜¯é¦–é€‰åšæ³•ã€‚ ä¸è¿‡æœ‰æ—¶ä½ åªæ˜¯æƒ³ç›´æ¥åœ¨ SQL è¯­å¥ä¸­æ’å…¥ä¸€ä¸ªä¸æ”¹å˜çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ï¼Œåƒ ORDER BYï¼Œä½ å¯ä»¥è¿™æ ·æ¥ä½¿ç”¨ï¼š 1ORDER BY ${columnName} æ­¤æ—¶mybatis ä¸ä¼šä¿®æ”¹æˆ–è½¬ä¹‰å­—ç¬¦ä¸²ã€‚ è¿™ç§æ–¹å¼ç±»ä¼¼äºï¼š 12Statement st = conn.createStatement();ResultSet rs = st.executeQuery(sql); è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼š ä»¥è¿™ç§æ–¹å¼æ¥å—ä»ç”¨æˆ·è¾“å‡ºçš„å†…å®¹å¹¶æä¾›ç»™è¯­å¥ä¸­ä¸å˜çš„å­—ç¬¦ä¸²æ˜¯ä¸å®‰å…¨çš„ï¼Œä¼šå¯¼è‡´æ½œåœ¨çš„ SQL æ³¨å…¥æ”»å‡»ï¼Œå› æ­¤è¦ä¹ˆä¸å…è®¸ç”¨æˆ·è¾“å…¥è¿™äº›å­—æ®µï¼Œè¦ä¹ˆè‡ªè¡Œè½¬ä¹‰å¹¶æ£€éªŒã€‚","link":"/2017/04/20/mybatis_operator/"},{"title":"zookeeperæç¤ºUnable to read additional data from server sessionid 0x","text":"é…ç½®zookeeperé›†ç¾¤ï¼Œä¸€å¼€å§‹é…ç½®äº†ä¸¤å°æœºå™¨server.1å’Œserver.2ã€‚ é…ç½®å‚æ•°ï¼Œåœ¨zoo.cfgä¸­æŒ‡å®šäº†æ•´ä¸ªzookeeperé›†ç¾¤çš„serverç¼–å·ã€åœ°å€å’Œç«¯å£ï¼š server.1=10.10.16.151:2888:3888server.2=10.10.16.234:2888:3888 ç„¶åä¸ºè¿™ä¸¤ä¸ªä¸ªèŠ‚ç‚¹åˆ›å»ºå¯¹åº”çš„ç¼–å·æ–‡ä»¶ï¼Œåœ¨/tmp/zookeeper/data/myidæ–‡ä»¶ä¸­ã€‚å¦‚ä¸‹ï¼š åœ¨server.1=10.10.16.151æœºå™¨ä¸Šæ‰§è¡Œï¼š 1echo 1 &gt; /tmp/zookeeper/data/myid åœ¨server.1=10.10.16.234æœºå™¨ä¸Šæ‰§è¡Œï¼š 1echo 2 &gt; /tmp/zookeeper/data/myid å¯åŠ¨server.1æµ‹è¯•dubboæœåŠ¡ï¼Œä½¿ç”¨zkServer.sh startå¯åŠ¨äº†server.1ï¼Œç„¶åä½¿ç”¨zkServer.sh statusæŸ¥çœ‹å·¥ä½œçŠ¶æ€ï¼Œæ˜¾ç¤º 1Error contacting service. It is probably not running. é€šè¿‡zkCli.sh -server 10.10.16.151:2181æŸ¥çœ‹æœåŠ¡è¯¦ç»†ï¼Œå‘ç°æœåŠ¡æç¤ºäº†ä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ã€‚ å¯åŠ¨æ—¶æç¤ºï¼š 1232017-09-15 14:57:27,139 [myid:] - INFO [main-SendThread(10.10.16.151:2181):ClientCnxn$SendThread@1035] - Opening socket connection to server 10.10.16.151/10.10.16.151:2181. Will not attempt to authenticate using SASL (java.lang.SecurityException: ÏÂ·Â¨Â¶Â¨Î»ÂµÈ‚Â¼Æ¤×ƒ)2017-09-15 14:57:27,140 [myid:] - INFO [main-SendThread(10.10.16.151:2181):ClientCnxn$SendThread@877] - Socket connection established to 10.10.16.151/10.10.16.151:2181, initiating session2017-09-15 14:57:27,143 [myid:] - INFO [main-SendThread(10.10.16.151:2181):ClientCnxn$SendThread@1161] - Unable to read additional data from server sessionid 0x0, likely server has closed socket, closing socket connection and attempting reconnect åæ¥æ‰ææ˜ç™½ï¼Œç”±äºæˆ‘åœ¨zoo.cfgä¸­é…ç½®äº†2å°æœºå™¨ï¼Œä½†æ˜¯åªå¯åŠ¨äº†1å°ï¼Œzookeeperå°±ä¼šè®¤ä¸ºæœåŠ¡å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚ é€šè¿‡zookeeperçš„é€‰ä¸¾ç®—æ³•å¾—çŸ¥ï¼Œå½“æ•´ä¸ªé›†ç¾¤è¶…è¿‡åŠæ•°æœºå™¨å®•æœºï¼Œzookeeperä¼šè®¤ä¸ºé›†ç¾¤å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚æ‰€ä»¥å¯åŠ¨2å°æœåŠ¡æ­£å¸¸ã€‚ ç„¶åæˆ‘åˆå¢åŠ äº†1å°server.3=10.10.16.241:2888:3888æœºå™¨èŠ‚ç‚¹ï¼Œåœ¨3å°éƒ½å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œå…³æ‰å…¶ä¸­1å°ï¼ŒæœåŠ¡æ­£å¸¸ï¼Œå…³æ‰2å°ï¼ŒæœåŠ¡ä¸å¯ç”¨ã€‚ æ‰€ä»¥ï¼Œzookeeperé›†ç¾¤åªå¯åŠ¨ä¸€å°æ— æ³•è¿æ¥ï¼Œå¦‚æœå¯åŠ¨æœºå™¨æ•°ä¸ºåŠæ•°åŠä»¥ä¸Šå°±å¯ä»¥è¿æ¥äº†ã€‚","link":"/2017/09/15/zookeeper%E6%8F%90%E7%A4%BAUnable%20to%20read%20additional%20data%20from%20server%20sessionid%200x/"},{"title":"å…³äº&#x3D;nullå’Œclear()é—®é¢˜ï¼ˆJavaæ€§èƒ½ä¼˜åŒ–ï¼‰","text":"ä»¥ArrayListä¸ºä¾‹ï¼Œæ ¹æ®æƒ…å†µæ¥çœ‹å§ï¼ŒArrayListå†…éƒ¨ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚ 1. list = null é‚£ä¹ˆä½ list = null; ** å°±æ˜¯é‡Šæ”¾è¿™ä¸ªæ•°ç»„å¯¹è±¡ï¼Œå½“ç„¶é‡Œé¢æ‰€å¼•ç”¨çš„å¯¹è±¡ä¹Ÿå°±é‡Šæ”¾äº†**ã€‚ 2. list.clear() å¦‚æœlist.clear(); çœ‹çœ‹æºä»£ç å°±çŸ¥é“äº†ï¼Œæ˜¯æŠŠlisté‡Œé¢å¯¹è±¡éå†èµ‹å€¼ä¸ºnullï¼Œæ„æ€å°±æ˜¯é‡Šæ”¾listé‡Œé¢æ‰€æœ‰å¯¹è±¡ã€‚ è¿™æ ·å°±å¾ˆæ¸…æ¥šäº†ï¼Œå¦‚æœä½ è¿™ä¸ªlistè¿˜éœ€è¦ä½¿ç”¨ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨clearå»é‡Šæ”¾æ‰listé‡Œé¢æ‰€æœ‰çš„æ•°æ®ï¼ŒGCåœ¨å›æ”¶çš„æ—¶å€™å°±æœ‰å¯èƒ½å›æ”¶æ‰åŸlisté‡Œé¢çš„è¿™äº›æ•°æ®äº†ã€‚å¦‚æœä½ éƒ½ä¸éœ€è¦äº†ï¼Œé‚£ä¹ˆä½ å°±ç”¨=nullè¿™æ ·GCå°±æœ‰å¯èƒ½æŠŠlistä»¥åŠé‡Œé¢å…³è”çš„ä¸€äº›æ•°æ®ä¹Ÿéƒ½å›æ”¶äº†ã€‚ 3. å’±ä»¬æ¥çœ‹ä¸‹clear()æºç clear()æºç è§£æï¼šIf we take an ArrayList as an example, the clear() method does this: 123456789public void clear() { modCount++; // Let gc do its work for (int i = 0; i &lt; size; i++) elementData[i] = null; size = 0; } Basically, if elements of a List are not referenced anywhere else in the code there is really no need (or at least you do not gain anything) to call clear(). You also do not need to assign null to the List because it will be garbage collected as soon as it falls out of scope.è¯‘æ–‡ï¼š åŸºæœ¬ä¸Šï¼Œå¦‚æœListä¸­çš„å…ƒç´ æ²¡æœ‰è¢«å¼•ç”¨åˆ°ä»£ç ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œé‚£ä¹ˆç¡®å®æ²¡æœ‰å¿…è¦ï¼ˆæˆ–è‡³å°‘ä½ æ²¡æœ‰è·å¾—ä»»ä½•ä¸œè¥¿ï¼‰æ¥è°ƒç”¨clear()ã€‚ æ‚¨ä¹Ÿä¸éœ€è¦ä¸ºListæŒ‡å®šnullï¼Œå› ä¸ºå®ƒä¼šåœ¨è¶…å‡ºèŒƒå›´çš„æƒ…å†µä¸‹è¢«åƒåœ¾å›æ”¶ã€‚","link":"/2016/04/19/%E5%85%B3%E4%BA%8E=null%E5%92%8Cclear()%E9%97%AE%E9%A2%98(Java%E6%80%A7%E8%83%BD%E7%AF%87)/"},{"title":"å‰åç«¯åˆ†ç¦»ï¼Œå‰ç«¯è·¨åŸŸè®¿é—®åå°çš„ä¸¤ç§æ–¹å¼","text":"â€‹ åœ¨æˆ‘ä»¬åšwebé¡¹ç›®é¡¹ç›®æ—¶ï¼Œå‰ç«¯å’Œåç«¯éƒ½æ˜¯ä¸åŒçš„å¼€å‘äººå‘˜è´Ÿè´£ï¼Œåˆ°æŸä¸ªæ—¶é—´ç‚¹å¿…ç„¶è¦è¿›è¡Œå‰åç«¯æ•°æ®äº¤äº’ï¼Œè¿™æ—¶å€™å°±ä¼šé‡åˆ°è·¨åŸŸé—®é¢˜ã€‚è¿™é‡Œä»‹ç»ä¸¤ç§è§£å†³æ–¹å¼ã€‚ æ–¹å¼1ï¼šå¦‚æœå¼€å‘æ˜¯tomcatæœåŠ¡å™¨ï¼Œåœ¨å·¥ç¨‹çš„web.xmlæ·»åŠ è®¾ç½®â€‹ ç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡CORS (Cross-Origin Resource Sharing)è·¨åŸŸèµ„æºå…±äº«çš„æ–¹å¼å®ç°ã€‚ â€‹ åœ¨web.xmlæ–‡ä»¶ä¸­è®¾ç½®CORSå†…å®¹ï¼Œå¦‚æœåå°å¼€å‘äººç”¨çš„æ˜¯tomcatæœåŠ¡å™¨çš„è¯ï¼Œåˆ™åœ¨webå·¥ç¨‹çš„web.xmlæ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸‹å†…å®¹å³å¯ï¼š 1234567891011121314151617181920212223242526272829&lt;!--è§£å†³tomcatéƒ¨ç½²è·¨åŸŸé—®é¢˜ --&gt;&lt;filter&gt; &lt;filter-name&gt;CORS&lt;/filter-name&gt; &lt;filter-class&gt;com.thetransactioncompany.cors.CORSFilter&lt;/filter-class&gt; &lt;init-param&gt; &lt;param-name&gt;cors.allowOrigin&lt;/param-name&gt; &lt;param-value&gt;*&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;cors.supportedMethods&lt;/param-name&gt; &lt;param-value&gt;GET, POST, HEAD, PUT, DELETE&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;cors.supportedHeaders&lt;/param-name&gt; &lt;param-value&gt;Accept, Origin, X-Requested-With, Content-Type, Last-Modified&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;cors.exposedHeaders&lt;/param-name&gt; &lt;param-value&gt;Set-Cookie&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;cors.supportsCredentials&lt;/param-name&gt; &lt;param-value&gt;true&lt;/param-value&gt; &lt;/init-param&gt;&lt;/filter&gt;&lt;filter-mapping&gt; &lt;filter-name&gt;CORS&lt;/filter-name&gt; &lt;url-pattern&gt;/*&lt;/url-pattern&gt;&lt;/filter-mapping&gt; è¿™æ˜¯é€šè¿‡CORS (Cross-Origin Resource Sharing)è·¨åŸŸèµ„æºå…±äº«çš„æ–¹å¼å®ç°ã€‚è¿™ç§æ–¹å¼å¯¹chromeæµè§ˆå™¨è°ƒè¯•æœ‰ç‚¹é—®é¢˜ï¼ŒfirefoxåŠIEè°ƒè¯•æ­£å¸¸ã€‚ æ–¹å¼2ï¼šé€šè¿‡ajaxå’Œè¿‡æ»¤å™¨å®ç°è·¨åŸŸâ€‹ ç¬¬äºŒç§æ–¹å¼æ˜¯é€šè¿‡å¾€è¯·æ±‚æ¶ˆæ¯å¤´ä¸­åŠ Access-Control-Allow-Originã€‚ â€‹ Access-Control-Allow-Originæ˜¯HTML5 æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œè®¾ç½®è¿™ä¸ªå±æ€§å€¼ä¸ºä½ å‰ç«¯æ‰€åœ¨æœåŠ¡å™¨çš„ipåœ°å€ã€‚ é¦–å…ˆåå°æ·»åŠ è¿‡æ»¤å™¨AccessFilter.javaï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041import java.io.IOException;import javax.servlet.Filter;import javax.servlet.FilterChain;import javax.servlet.FilterConfig;import javax.servlet.ServletException;import javax.servlet.ServletRequest;import javax.servlet.ServletResponse;import javax.servlet.http.HttpServlet;import javax.servlet.http.HttpServletResponse;import org.springframework.beans.factory.annotation.Value;/** * @Title: AccessFilter.java * @Description: TODO(è®¾ç½®å…¶ä»–IPåœ°å€çš„æœºå™¨å¯ä»¥ç›´æ¥è®¿é—®æœ¬é¡¹ç›®Url--å·¥å…·filter) */public class AccessFilter extends HttpServlet implements Filter{ /** * åºåˆ—IDï¼Œç”¨æ¥ç›‘æµ‹æ§åˆ¶ç‰ˆæœ¬æ›´æ–°çš„ */ private static final long serialVersionUID = 1L; @Value(&quot;${test.mavenspring.project.allow.url}&quot;) private String projectDemoAllowOriginUrl; @Override public void init(FilterConfig filterConfig) throws ServletException { } //è®¾ç½®å…¶ä»–IPåœ°å€çš„æœºå™¨å¯ä»¥ç›´æ¥è®¿é—®åˆ°è¿™ä¸ªé¡¹ç›®çš„åç«¯ @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { HttpServletResponse httpResponse = (HttpServletResponse) response; httpResponse.setHeader(&quot;Access-Control-Allow-Origin&quot;, projectDemoAllowOriginUrl); httpResponse.setHeader(&quot;Access-Control-Allow-Headers&quot;,&quot;Origin, X-Requested-With, Content-Type, Accept&quot;); httpResponse.setHeader(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;); chain.doFilter(request, httpResponse); }} ç„¶ååœ¨å‰ç«¯jsçš„ajaxéƒ¨åˆ†æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼è®¾ç½®ï¼š 1234567891011$.ajaxSettings.xhrFields = { withCredentials : true};$.ajax({ crossDomain : true, type : 'post', url : 'http://...', dataType : 'json', data : '...', //å…¶ä»–å¤„ç†ä¸å˜}); é»˜è®¤æƒ…å†µä¸‹widthCredentialsä¸ºfalseï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®widthCredentialsä¸ºtrueã€‚ æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œè®¾ç½®äº†widthCredentialsä¸ºtrueçš„è¯·æ±‚ä¸­ä¼šåŒ…å«è¿œç¨‹åŸŸçš„æ‰€æœ‰cookieï¼Œä½†è¿™äº›cookieä»ç„¶éµå¾ªåŒæºç­–ç•¥ï¼Œæ‰€ä»¥ä½ æ˜¯è®¿é—®ä¸äº†è¿™äº›cookieçš„ã€‚ä»¥ä¸Šæ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­ç”¨åˆ°çš„ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ–¹å¼ç”¨chromeè°ƒè¯•ä¼šæœ‰ç‚¹é—®é¢˜ï¼Œç¬¬äºŒç§æ–¹å¼å…¼å®¹æ€§è¾ƒå¥½ï¼Œä¸»æµæµè§ˆå™¨è°ƒè¯•æ­£å¸¸ã€‚ ä¸è¿‡ä¸€å®šè¦è®°å¾—ï¼Œè¿™ä¸ªä»…ä»…ä½œä¸ºå‰åç«¯äº¤äº’è°ƒè¯•ä¹‹ç”¨ï¼Œ å¼€å‘å®Œæˆåè®°å¾—åˆ é™¤è¿™äº›è·¨åŸŸéƒ¨åˆ†ï¼Œ é¿å…é¡¹ç›®ä¸Šçº¿ä¹‹åå‡ºç°å®‰å…¨é—®é¢˜ã€‚åˆ‡è®°ï¼","link":"/2017/02/28/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%EF%BC%8C%E5%89%8D%E7%AB%AF%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE%E5%90%8E%E5%8F%B0%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F/"},{"title":"æ’å¤§ VS ä¸Šæ¸¯","text":"âš½å¾ˆå°‘çœ‹ä¸­è¶…ï¼Œä¸‰çº¿ä¼ªçƒè¿·ï¼Œå¶å¾—ä¸€å¼ æ’å¤§å¯¹æˆ˜ä¸Šæ¸¯çš„ç¥¨ï¼Œäºšå† è”èµ›1/4å†³èµ›â€œä¸­å›½å¾·æ¯”â€ç¬¬äºŒå›åˆï¼Œéå¸¸å€¼å¾—ä¸€çœ‹ã€‚äºæ˜¯å’Œå³°å“¥å®ˆæƒ…çªç€å°äºŒè½®å„¿å°±å¾€å¤©æ²³ä½“è‚²ä¸­å¿ƒèµ¶ã€‚ â€‹ é¦–å›åˆä¸Šæ¸¯ä¸»åœºåœ¨ä¸Šæµ·ï¼Œæ‰€ä»¥è¿™ä¸€å›åˆæ˜¯æ’å¤§å¹¿å·ä¸»åœºï¼Œç¬¬ä¸€å›åˆä¸Šæ¸¯4-0æ’å¤§ï¼Œæ‰€ä»¥è¿™ä¸€å›æ’å¤§åŠ¿å¿…ä¼šæ”»åŠ¿å¼ºåŠ²ã€‚è¿™å›è¦5-0ä¸Šæ¸¯æ‰èƒ½èµ¢å¾—è¿™æ¬¡æ¯”èµ›ã€‚ åœºå¤–ä¹°äº†ä»¶é˜¿å…°çš„7å·çƒè¡£ã€‚ æ¯”èµ›å¼€å§‹äº†ã€‚ å¤´ä¸€å›é çƒè¿·åä¼šè¿™ä¹ˆè¿‘ï¼Œæ•´åœºçƒè¿·åä¼šéƒ½åœ¨èµ·åŠ¿åŠ©å¨ï¼Œæ„Ÿå—åˆ°äº†ä»–ä»¬çœŸçš„å¾ˆçˆ±æ’å¤§ï¼Œçƒ­çˆ±è¶³çƒã€‚ æˆ‘ç­‰åå…«çº¿çƒè¿·ä¹Ÿå°±æ˜¯åœ¨è¿›çƒæ—¶äº¢å¥‹åç§’ï¼Œä¸¢ï¼ æ•´åœºä¸‹æ¥ï¼Œä¸Šæ¸¯é˜Ÿé˜Ÿå‘˜å—ä¼¤æ¢ä¸‹çš„çƒå‘˜ä¸ä¸‹4ä¸ªï¼Œä¸€ä¸ªæ˜¯éƒ¨åˆ†çƒå‘˜çŠ¶æ€ä¸å¤ªå¥½ï¼ŒäºŒæ˜¯æ’å¤§é˜Ÿå‘˜å¤„äºå‹åŠ›è¸¢çš„å¤ªæ¿€è¿›ã€‚ ç¬¬90åˆ†é’Ÿï¼Œæå­¦é¹å¤´çƒç ´é—¨ï¼Œå¹¿å·æ’å¤§4-0ä¸Šæµ·ä¸Šæ¸¯ï¼ çƒè¿·ä»¬åˆæ˜¯ä¸€é˜µäº¢å¥‹ï¼æˆ‘ä¹Ÿç‰¹æ¿€åŠ¨ï¼Œæ„Ÿè§‰ä¸»åœºæ¥ä¸ª5-0å°±èµ¢äº†ï¼Œçœ‹æ¥èƒœåˆ©ä¸è¿œäº†ï¼Œé‚£ä¸ªæ¿€åŠ¨å•Šï¼ŒçœŸåˆ‡æ„Ÿå—åˆ°äº†è¶³çƒçš„é­…åŠ›ã€‚ å¯æ˜¯ï¼Œæœ€æ€•è¿™ä¸ªå¯æ˜¯äº†ã€‚ ç¬¬109åˆ†é’Ÿï¼Œä¸Šæ¸¯é˜Ÿèƒ¡å°”å…‹ä¸»ç½šçš„çˆ†å°„ç›´é’»ç½‘çªæ­»è§’ï¼Œå¹¿å·æ’å¤§4-1ä¸Šæµ·ä¸Šæ¸¯ï¼æ’å¤§å‹åŠ›å¾ˆå¤§ï¼Œç©†é‡Œå¥‡è¢«ä¸Šæ¸¯é˜Ÿå‘˜æ‹‰å€’ï¼Œè¢«ç½šç‚¹çƒï¼Œé«˜æ‹‰ç‰¹ä¸»ç½šå‘½ä¸­ï¼Œ5-1æ‰“å¹³äº†ï¼Œæ‚¬çš„å¿ƒåˆæ”¾ä¸‹äº†ã€‚ å¸¸è§„èµ›ç»“æŸï¼Œæ¯”èµ›è¿›å…¥åŠ æ—¶ï¼Œ5-1ï¼Œé˜¿å…°è¿›ä¿©çƒï¼Œé«˜æ‹‰ç‰¹è¿›3çƒã€‚å‹åŠ›å·²ç»åœ¨æ’å¤§é˜Ÿè¿™è¾¹äº†ï¼ŒåŠ æ—¶èµ›5:1ï¼Œæ€»æ¯”åˆ†æ’å¤§5-5æˆ˜å¹³ä¸Šæ¸¯ï¼Œæœªåˆ†èƒœè´Ÿï¼Œæ‰€ä»¥å‘¢ï¼Œå°±åˆ°äº†ç²¾å½©çš„ç‚¹çƒå¤§æˆ˜ã€‚åˆæ˜¯åŠ æ—¶ï¼Œåˆæ˜¯ç‚¹çƒï¼ŒåŒæ–¹éƒ½ç´§å’¬æ¯”åˆ†ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œç‚¹çƒä¸Šæ¸¯é˜Ÿ5ç½š5ä¸­ï¼Œæ’å¤§é˜Ÿ5ç½š4ä¸­ï¼Œå…¨åœºæ¯”èµ›ç»“æŸï¼Œæ€»æ¯”åˆ†ä¸Šæµ·ä¸Šæ¸¯10-9æ·˜æ±°å¹¿å·æ’å¤§ã€‚ ä¸€æ³¢ä¸‰æŠ˜ï¼Œå¸¸è§„èµ›ä»¥ä¸ºè¦è¾“äº†ï¼Œç„¶ååˆèµ¢äº†ï¼ŒåŠ æ—¶åŠ ä¸Šç‚¹çƒï¼Œä»¥ä¸ºè¦èµ¢äº†ï¼Œç»“æœè¿˜æ˜¯è¾“äº†ã€‚æ’å¤§çƒå‘˜çš„æ‹¼åŠ²æœ‰ç›®å…±ç¹ï¼Œæ•´åœºçƒçœŸçš„å¾ˆç²¾å½©ï¼Œç°åœºçœ‹çƒï¼Œä¸ç®¡æ˜¯çƒå‘˜è¿˜æ˜¯çƒè¿·å¸¦ç»™äººçš„éƒ½æ˜¯ç‰¹åˆ«æ„ŸåŠ¨æ¿€æ˜‚çš„æ„Ÿå—ï¼Œå°½ç®¡å¹¿å·å¾ˆçƒ­ï¼Œç°åœºçš„çƒ­æƒ…å®Œå…¨æ©ç›–äº†çƒåœºå†…çš„çƒ­æµªã€‚ æœ€åå›è°¢çƒè¿·ã€‚ æ’å¤§é˜Ÿï¼Œè™½è´¥çŠ¹è£ï¼","link":"/2017/09/12/%E6%81%92%E5%A4%A7%E4%B8%BB%E4%B8%8A%E6%B8%AF%E5%AE%A2/"},{"title":"ideaæ­å»ºspringdata+mongodb+maven+springmvc","text":"ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸‹SpringDataæ“ä½œMongoDBã€‚é¡¹ç›®ç¯å¢ƒï¼šIntelliJ IDEA2017+maven3.5.0+MongoDB 3.2+JDK1.7+spring4.3.8 æ¨èç½‘ç«™ï¼ˆé€‚åˆå­¦ä¹ å„ç§çŸ¥è¯†çš„åŸºç¡€ï¼‰ï¼šhttp://www.runoob.com/ mongoå®‰è£…è¯·å‚è€ƒï¼šhttp://www.runoob.com/mongodb/mongodb-window-install.html 1. åˆ›å»ºmavenå·¥ç¨‹é¦–ç›¸åˆ›å»ºmavenå·¥ç¨‹ï¼ŒNew project: è¿™é‡Œä¸ä½¿ç”¨ideaè‡ªå¸¦mavenæ’ä»¶ï¼Œæ”¹ç”¨ä¸‹è½½å¥½çš„3.5.0ç‰ˆmavenï¼› ç”±äºæœ€è¿‘osChinaçš„mavenä»“åº“æŒ‚æ‰ï¼Œæ¨èå¤§å®¶ä½¿ç”¨é˜¿é‡Œçš„é•œåƒï¼Œé€Ÿåº¦å¿«çš„é£èµ·mavené…ç½®ï¼šD:\\apache-maven-3.5.0\\conf\\setting.xmlä¸­æ‰¾åˆ°mirrors: 12345678&lt;mirrors&gt; &lt;mirror&gt; &lt;id&gt;alimaven&lt;/id&gt; &lt;name&gt;aliyun maven&lt;/name&gt; &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt; &lt;mirrorOf&gt;central&lt;/mirrorOf&gt; &lt;/mirror&gt;&lt;/mirrors&gt; é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾ï¼Œæ‰‹åŠ¨åˆ›å»ºç›¸å…³æ–‡ä»¶å¤¹åŠæ–‡ä»¶ï¼Œå¹¶è®¾ç½®æ–‡ä»¶å¤¹çš„å¯¹åº”å±æ€§ï¼š è‡³æ­¤ï¼Œmavenå·¥ç¨‹åˆ›å»ºå®Œæ¯•ã€‚ 2. è®¿é—®mongodbæ•°æ®æ–¹å¼è¿™é‡Œdaoä¸mongoDaoåˆ†åˆ«ä¸ºmongoDBçš„ä¸¤ç§æŸ¥è¯¢æ–¹å¼ï¼š (1) daoä¸ºJPAçš„æŸ¥è¯¢æ–¹å¼ï¼ˆè¯·å‚è€ƒspringdataJPAï¼‰ï¼› (2) mongoDaoä½¿ç”¨mongoTemplateï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä½¿ç”¨çš„jdbcTemplateã€‚ 3. è¯¦ç»†ä»£ç å…ˆçœ‹é…ç½®æ–‡ä»¶spring-context.xmlä¸ºæœ€åŸºæœ¬çš„springé…ç½®: 123456789101112131415161718&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt; &lt;!-- å¼€å¯æ³¨è§£ --&gt; &lt;context:annotation-config/&gt; &lt;!--æ‰«æserviceåŒ…å—²æ‰€æœ‰ä½¿ç”¨æ³¨è§£çš„ç±»å‹--&gt; &lt;context:component-scan base-package=&quot;com.lewis.mongo&quot;&gt; &lt;context:include-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Controller&quot;/&gt; &lt;/context:component-scan&gt; &lt;!-- å¯¼å…¥mongodbçš„é…ç½®æ–‡ä»¶ --&gt; &lt;import resource=&quot;spring-mongo.xml&quot;/&gt;&lt;/beans&gt; spring-web.xmlä¸ºspringmvcçš„åŸºæœ¬é…ç½®: 12345678910111213141516171819202122232425262728293031323334353637&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-4.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;&gt; &lt;!--é…ç½®springmvc--&gt; &lt;!--1.å¼€å¯springmvcæ³¨è§£æ¨¡å¼--&gt; &lt;context:annotation-config/&gt; &lt;!--ç®€åŒ–é…ç½®ï¼š (1)ä¸»åŠ¨æ³¨å†ŒDefaultAnnotationHandlerMapping,AnnotationMethodHandlerAdapter (2)æä¾›ä¸€ç³»åˆ—åŠŸèƒ½ï¼šæ•°æ®ç»‘å®šï¼Œæ•°å­—å’Œæ—¥æœŸçš„format @NumberFormt @DataTimeFormatï¼Œxml jsoné»˜è®¤çš„è¯»å†™æ”¯æŒ--&gt; &lt;mvc:annotation-driven/&gt; &lt;!--servlet-mapping--&gt; &lt;!--2é™æ€èµ„æºé»˜è®¤çš„servleté…ç½®ï¼Œ ï¼ˆ1ï¼‰å…è®¸å¯¹é™æ€èµ„æºçš„å¤„ç†ï¼šjsï¼Œgif ï¼ˆ2ï¼‰å…è®¸ä½¿ç”¨â€œ/â€åšæ•´ä½“æ˜ å°„--&gt; &lt;!-- å®¹å™¨é»˜è®¤çš„DefaultServletHandlerå¤„ç† æ‰€æœ‰é™æ€å†…å®¹ä¸æ— RequestMappingå¤„ç†çš„URL--&gt; &lt;mvc:default-servlet-handler/&gt; &lt;!--3:é…ç½®jsp æ˜¾ç¤ºviewResolver--&gt; &lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt; &lt;property name=&quot;viewClass&quot; value=&quot;org.springframework.web.servlet.view.JstlView&quot;/&gt; &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/views/&quot;/&gt; &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt; &lt;/bean&gt; &lt;!-- 4è‡ªåŠ¨æ‰«æä¸”åªæ‰«æ@Controller --&gt; &lt;context:component-scan base-package=&quot;com.lewis.mongo.controller&quot;/&gt; &lt;!-- å®šä¹‰æ— éœ€Controllerçš„url&lt;-&gt;viewç›´æ¥æ˜ å°„ --&gt; &lt;mvc:view-controller path=&quot;/&quot; view-name=&quot;redirect:/hi/hello&quot;/&gt;&lt;/beans&gt; spring-mongo.xmlä¸ºmongoé…ç½®: 12345678910111213141516171819202122232425262728293031&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:mongo=&quot;http://www.springframework.org/schema/data/mongo&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/data/mongo http://www.springframework.org/schema/data/mongo/spring-mongo.xsd&quot;&gt; &lt;!-- åŠ è½½mongodbçš„å±æ€§é…ç½®æ–‡ä»¶ --&gt; &lt;context:property-placeholder location=&quot;classpath*:mongo.properties&quot;/&gt; &lt;!-- springè¿æ¥mongodbæ•°æ®åº“çš„é…ç½® --&gt; &lt;mongo:mongo-client replica-set=&quot;${mongo.hostport}&quot; id=&quot;mongo&quot;&gt; &lt;mongo:client-options connections-per-host=&quot;${mongo.connectionsPerHost}&quot; threads-allowed-to-block-for-connection-multiplier=&quot;${mongo.threadsAllowedToBlockForConnectionMultiplier}&quot; connect-timeout=&quot;${mongo.connectTimeout}&quot; max-wait-time=&quot;${mongo.maxWaitTime}&quot; socket-timeout=&quot;${mongo.socketTimeout}&quot;/&gt; &lt;/mongo:mongo-client&gt; &lt;!-- mongoçš„å·¥å‚ï¼Œé€šè¿‡å®ƒæ¥å–å¾—mongoå®ä¾‹,dbnameä¸ºmongodbçš„æ•°æ®åº“åï¼Œæ²¡æœ‰çš„è¯ä¼šè‡ªåŠ¨åˆ›å»º --&gt; &lt;mongo:db-factory id=&quot;mongoDbFactory&quot; dbname=&quot;mongoLewis&quot; mongo-ref=&quot;mongo&quot;/&gt; &lt;!-- åªè¦ä½¿ç”¨è¿™ä¸ªè°ƒç”¨ç›¸åº”çš„æ–¹æ³•æ“ä½œ --&gt; &lt;bean id=&quot;mongoTemplate&quot; class=&quot;org.springframework.data.mongodb.core.MongoTemplate&quot;&gt; &lt;constructor-arg name=&quot;mongoDbFactory&quot; ref=&quot;mongoDbFactory&quot;/&gt; &lt;/bean&gt; &lt;!-- mongodb beançš„ä»“åº“ç›®å½•ï¼Œä¼šè‡ªåŠ¨æ‰«ææ‰©å±•äº†MongoRepositoryæ¥å£çš„æ¥å£è¿›è¡Œæ³¨å…¥ --&gt; &lt;mongo:repositories base-package=&quot;com.lewis.mongo&quot;/&gt;&lt;/beans&gt; mongo.properties: 123456789101112mongo.hostport=10.10.16.234:27017 mongo.connectionsPerHost=8 mongo.threadsAllowedToBlockForConnectionMultiplier=4 #è¿æ¥è¶…æ—¶æ—¶é—´mongo.connectTimeout=1000 #ç­‰å¾…æ—¶é—´mongo.maxWaitTime=1500 mongo.autoConnectRetry=true mongo.socketKeepAlive=true #Socketè¶…æ—¶æ—¶é—´mongo.socketTimeout=1500 mongo.slaveOk=true pom.xmlï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯junitç‰ˆæœ¬éœ€è¦4.12ä»¥ä¸Šï¼Œä¸ç„¶ideaä¼šæŠ¥é”™ï¼›spring-data-mongodbç‰ˆæœ¬è¦1.10.1ä»¥ä¸Šï¼› 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;properties&gt; &lt;!-- spring-framework-bom ç‰ˆæœ¬å·--&gt; &lt;spring.version&gt;4.3.8.RELEASE&lt;/spring.version&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;/properties&gt; &lt;groupId&gt;com.liu&lt;/groupId&gt; &lt;artifactId&gt;mongo&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;war&lt;/packaging&gt; &lt;name&gt;mongo Maven Webapp&lt;/name&gt; &lt;url&gt;http://maven.apache.org&lt;/url&gt; &lt;dependencies&gt; &lt;!--ä½¿ç”¨junit4ï¼Œæ³¨è§£çš„æ–¹å¼æµ‹è¯•--&gt; &lt;!--&lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.11&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt;--&gt; &lt;!-- https://mvnrepository.com/artifact/junit/junit --&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;!--æ—¥å¿—--&gt; &lt;!--æ—¥å¿— slf4j,log4j,logback,common-logging--&gt; &lt;!--slf4jæ˜¯è§„èŒƒ/æ¥å£--&gt; &lt;!--log4j,logback,common-loggingæ˜¯æ—¥å¿—å®ç° æœ¬é¡¹ç›®ä½¿ç”¨slf4j + logback --&gt; &lt;dependency&gt; &lt;groupId&gt;org.slf4j&lt;/groupId&gt; &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt; &lt;version&gt;1.7.12&lt;/version&gt; &lt;/dependency&gt; &lt;!--å®ç°slf4jå¹¶æ•´åˆ--&gt; &lt;dependency&gt; &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; &lt;artifactId&gt;logback-core&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; &lt;artifactId&gt;logback-classic&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; &lt;!--æ•°æ®åº“ç›¸å…³--&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.22&lt;/version&gt; &lt;!--mavenå·¥ä½œèŒƒå›´ é©±åŠ¨åœ¨çœŸæ­£å·¥ä½œçš„æ—¶å€™ä½¿ç”¨ï¼Œæ•…ç”Ÿå‘½å‘¨æœŸæ”¹ä¸ºruntime--&gt; &lt;scope&gt;runtime&lt;/scope&gt; &lt;/dependency&gt; &lt;!--servlet webç›¸å…³ jstl1.2ä»¥ä¸Šç‰ˆæœ¬å°±ä¸éœ€è¦standardè¿™ä¸ªåŒ…äº†ï¼Œ ä¸ç„¶ä¼šæŠ¥é”™ï¼š TLD skipped. URI: http://java.sun.com/jstl/core_rt is already defined--&gt; &lt;!--&lt;dependency&gt; &lt;groupId&gt;taglibs&lt;/groupId&gt; &lt;artifactId&gt;standard&lt;/artifactId&gt; &lt;version&gt;1.1.2&lt;/version&gt; &lt;/dependency&gt;--&gt; &lt;dependency&gt; &lt;groupId&gt;jstl&lt;/groupId&gt; &lt;artifactId&gt;jstl&lt;/artifactId&gt; &lt;version&gt;1.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.5.4&lt;/version&gt; &lt;/dependency&gt; &lt;!--spring--&gt; &lt;!--springæ ¸å¿ƒ--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-core&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-asm --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-asm&lt;/artifactId&gt; &lt;version&gt;3.1.4.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-beans&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!--spring dao--&gt; &lt;!--&lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt; &lt;version&gt;1.8.0.RELEASE&lt;/version&gt; &lt;/dependency&gt;--&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework.data/spring-data-mongodb --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.data&lt;/groupId&gt; &lt;artifactId&gt;spring-data-mongodb&lt;/artifactId&gt; &lt;version&gt;1.10.1.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.mongodb&lt;/groupId&gt; &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt; &lt;version&gt;3.2.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-tx&lt;/artifactId&gt; &lt;version&gt;${spring.version}&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aop --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-aop&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!--spring web--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-web&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;!--spring test--&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-test&lt;/artifactId&gt; &lt;version&gt;4.3.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-fileupload&lt;/groupId&gt; &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt; &lt;version&gt;1.3.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/javax/javaee-api --&gt; &lt;dependency&gt; &lt;groupId&gt;javax&lt;/groupId&gt; &lt;artifactId&gt;javaee-api&lt;/artifactId&gt; &lt;version&gt;7.0&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-framework-bom&lt;/artifactId&gt; &lt;version&gt;${spring.version}&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;net.sf.ehcache&lt;/groupId&gt; &lt;artifactId&gt;ehcache-core&lt;/artifactId&gt; &lt;version&gt;2.6.9&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;build&gt; &lt;finalName&gt;mongo&lt;/finalName&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.3&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;1.6&lt;/source&gt; &lt;target&gt;1.6&lt;/target&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; ä¸¤ä¸ªå®ä½“ç±»ï¼š Address.java: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package com.lewis.mongo.entity;/** * Created by liu on 2017/6/7. */public class Address { private String city; private String street; private int num; public Address() { } public Address(String city, String street, int num) { this.city = city; this.street = street; this.num = num; } public String getCity() { return city; } public void setCity(String city) { this.city = city; } public String getStreet() { return street; } public void setStreet(String street) { this.street = street; } public int getNum() { return num; } public void setNum(int num) { this.num = num; } @Override public String toString() { return &quot;Address{&quot; + &quot;city='&quot; + city + '\\'' + &quot;, street='&quot; + street + '\\'' + &quot;, num=&quot; + num + '}'; }} Person.java: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869package com.lewis.mongo.entity;import java.io.Serializable;import org.bson.types.ObjectId;import org.springframework.data.annotation.Id;import org.springframework.data.mongodb.core.mapping.Document;/** * Created by liu on 2017/6/7. */@Document(collection = &quot;person&quot;)public class Person implements Serializable { @Id private ObjectId id; private String name; private int age; private Address address; public Person() { } public Person(String name, int age, Address address) { this.name = name; this.age = age; this.address = address; } public ObjectId getId() { return id; } public void setId(ObjectId id) { this.id = id; } public String getName() { return name; } public void setName(String name) { this.name = name; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } public Address getAddress() { return address; } public void setAddress(Address address) { this.address = address; } @Override public String toString() { return &quot;Person{&quot; + &quot;id=&quot; + id + &quot;, name='&quot; + name + '\\'' + &quot;, age=&quot; + age + &quot;, address=&quot; + address + '}'; }} JPAçš„daoï¼Œæ³¨æ„è¿™é‡Œåªè¦ç»§æ‰¿MongoRepositoryä¸ç”¨å†™æ³¨è§£springå°±èƒ½è®¤è¯†è¿™æ˜¯ä¸ªRepositoryï¼ŒMongoRepositoryæä¾›äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥ï¼Œä¸ç”¨å®ç°ä¾¿å¯ç›´æ¥è°ƒç”¨ï¼Œä¾‹å¦‚testMongoçš„personDao.save(persons); PersonDao.java: 123456789101112131415161718package com.lewis.mongo.dao;import com.lewis.mongo.entity.Person;import org.bson.types.ObjectId;import org.springframework.data.mongodb.repository.MongoRepository;import org.springframework.data.mongodb.repository.Query;import java.util.List;/** * Created by liu on 2017/6/7. */public interface PersonDao extends MongoRepository&lt;Person, ObjectId&gt; { @Query(value = &quot;{'age' : {'$gte' : ?0, '$lte' : ?1}, 'name' : ?2}&quot;, fields = &quot;{'name' : 1, 'age' : 1}&quot;) List&lt;Person&gt; findByAge(int age1, int age2, String name);} mongoTemplateçš„daoï¼ŒPersonMongoDao.java: 123456789101112131415package com.lewis.mongo.mongoDao;import com.lewis.mongo.entity.Person;import java.util.List;/** * Created by liu on 2017/6/7. */public interface PersonMongoDao { List&lt;Person&gt; findAll(); void insertPerson(Person user); void removePerson(String userName); void updatePerson(); List&lt;Person&gt; findForRequery(String userName);} PersonMongoImpl.java: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.lewis.mongo.mongoDao;import com.lewis.mongo.entity.Person;import org.springframework.data.mongodb.core.MongoTemplate;import org.springframework.data.mongodb.core.query.Query;import org.springframework.data.mongodb.core.query.Update;import org.springframework.data.mongodb.core.query.Criteria;import org.springframework.stereotype.Repository;import javax.annotation.Resource;import java.util.List;/** * Created by liu on 2017/6/7. */@Repository(&quot;personMongoImpl&quot;)public class PersonMongoImpl implements PersonMongoDao { @Resource private MongoTemplate mongoTemplate; @Override public List&lt;Person&gt; findAll() { return mongoTemplate.findAll(Person.class, &quot;person&quot;); } @Override public void insertPerson(Person person) { mongoTemplate.insert(person, &quot;person&quot;); } @Override public void removePerson(String userName) { mongoTemplate.remove(Query.query(Criteria.where(&quot;name&quot;).is(userName)), &quot;person&quot;); } @Override public void updatePerson() { mongoTemplate.updateMulti(Query.query(Criteria.where(&quot;age&quot;).gt(3).lte(5)), Update.update(&quot;age&quot;, 3), &quot;person&quot;); } @Override public List&lt;Person&gt; findForRequery(String userName) { return mongoTemplate.find(Query.query(Criteria.where(&quot;name&quot;).is(userName)), Person.class); }} JPAæŸ¥è¯¢çš„æµ‹è¯•ç±»ï¼ŒPersonDaoTest.java: 1234567891011121314151617181920212223242526272829303132333435363738import com.lewis.mongo.dao.PersonDao;import com.lewis.mongo.entity.Address;import com.lewis.mongo.entity.Person;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.test.context.ContextConfiguration;import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;import javax.annotation.Resource;import java.util.ArrayList;import java.util.List;/** * Created by liu on 2017/6/7. */@RunWith(SpringJUnit4ClassRunner.class)//å‘Šè¯‰junit springé…ç½®æ–‡ä»¶@ContextConfiguration({&quot;classpath:spring/spring-context.xml&quot;, &quot;classpath:spring/spring-mongo.xml&quot;})public class PersonDaoTest { @Resource private PersonDao personDao; /*å…ˆå¾€æ•°æ®åº“ä¸­æ’å…¥10ä¸ªperson*/ @Test public void testMongo() { List&lt;Person&gt; persons = new ArrayList&lt;Person&gt;(); for (int i = 0; i &lt; 10; i++) { persons.add(new Person(&quot;name&quot; + i, i, new Address(&quot;å¹¿å·å¸‚&quot;, &quot;å¤©æ²³åŒº&quot;, i))); } personDao.save(persons); } @Test public void findMongo() { System.out.println(personDao.findByAge(2, 8, &quot;name6&quot;)); }} mongoTemplateæŸ¥è¯¢çš„æµ‹è¯•ç±»ï¼ŒMongoTemplateTest.java: 123456789101112131415161718192021222324252627282930import com.lewis.mongo.entity.Address;import com.lewis.mongo.entity.Person;import com.lewis.mongo.mongoDao.PersonMongoImpl;import org.junit.Test;import org.junit.runner.RunWith;import org.springframework.test.context.ContextConfiguration;import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;import javax.annotation.Resource;/** * Created by liu on 2017/6/7. */@RunWith(SpringJUnit4ClassRunner.class)//å‘Šè¯‰junit springé…ç½®æ–‡ä»¶@ContextConfiguration({&quot;classpath:spring/spring-context.xml&quot;, &quot;classpath:spring/spring-mongo.xml&quot;})public class MongoTemplateTest { @Resource private PersonMongoImpl personMongo; @Test public void testMongoTemplate() { //personMongo.insertPerson(new Person(&quot;Lewis&quot;,24,new Address(&quot;å¹¿å·&quot;,&quot;å¤©æ²³&quot;,20))); personMongo.removePerson(&quot;name3&quot;); personMongo.updatePerson(); System.out.println(personMongo.findAll()); System.out.println(personMongo.findForRequery(&quot;Lewis&quot;)); }} æ³¨æ„æµ‹è¯•å‰è¯·å…ˆé€šè¿‡PersonDaoTest.javaä¸­çš„testMongo()æ–¹æ³•å‘æ•°æ®åº“ä¸­æ’å…¥æ•°æ®ã€‚ é¡¹ç›®æºç Gitåœ°å€ï¼Œä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼šhttps://github.com/wonderomg/SpringData-mongdb å‚è€ƒèµ„æ–™ï¼šhttp://docs.spring.io/spring-data/mongodb/docs/current/reference/html/ å‚è€ƒæ–‡ç« ï¼šhttp://www.imooc.com/article/13777","link":"/2017/06/06/idea%E6%90%AD%E5%BB%BAspringdata+mongodb+maven+springmvc/"},{"title":"Elasticsearchå®è·µ(3)-apiåˆ†é¡µæŸ¥è¯¢","text":"elasticsearchç³»åˆ—ï¼š (1)Elasticsearchå®è·µ(1)-æ­å»ºåŠIKä¸­æ–‡åˆ†è¯ (2)Elasticsearchå®è·µ(2)-ç´¢å¼•åŠç´¢å¼•åˆ«åalias (3)Elasticsearchå®è·µ(3)-apiåˆ†é¡µæŸ¥è¯¢ esåˆ†é¡µæœ‰ä¸¤ç§ï¼Œfrom sizeæµ…åˆ†é¡µå’Œscrollæ·±åˆ†é¡µï¼Œè¿™é‡Œå¯¹è¿™ä¸¤ç§åˆ†é¡µéƒ½åšäº†å®ç°ï¼Œä½¿ç”¨çš„æ˜¯esçš„java apiã€‚from sizeç±»ä¼¼äºmysqlçš„limitåˆ†é¡µï¼Œfromåç§»ï¼Œé»˜è®¤ä¸º0ï¼Œsizeä¸ºè¿”å›çš„ç»“æœæ•°é‡ï¼Œé»˜è®¤ä¸º10ã€‚åœ¨æ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ä¸€èˆ¬ä¼šä½¿ç”¨from sizeï¼Œæ•°æ®é‡å¤§çš„æ—¶å€™æ•ˆç‡æ¯”è¾ƒä½ï¼Œè€Œä¸”å¾ˆè´¹å†…å­˜ï¼Œæ¯æ¬¡ä¼šæŠŠfrom*sizeæ¡è®°å½•å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¯¹ç»“æœè¿”å›å‰è¿›è¡Œå…¨å±€æ’åºï¼Œç„¶åä¸¢å¼ƒæ‰èŒƒå›´å¤–çš„ç»“æœï¼Œé‡å¤è¿™æ ·çš„æ“ä½œä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤§è€Œä½¿esæŒ‚æ‰ï¼Œå¹¶ä¸”å—æ•°æ®æ¡æ•°é™åˆ¶ï¼Œ10000æ¡ï¼Œéœ€ä¿®æ”¹ç´¢å¼•é™åˆ¶ã€‚ğŸ¤” scrollåˆ†é¡µé€šä¿—æ¥è¯´å°±æ˜¯æ»šå±ç¿»é¡µï¼Œè®¾ç½®æ¯é¡µæŸ¥è¯¢æ•°é‡ä¹‹åï¼Œæ¯æ¬¡æŸ¥è¯¢ä¼šè¿”å›ä¸€ä¸ªscroll_idï¼Œå³å½“å‰æ–‡æ¡£çš„ä½ç½®ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†ä¼ è¿™ä¸ªscroll_idç»™esè¿”å›ä¸‹ä¸€é¡µçš„æ•°æ®ä»¥åŠä¸€ä¸ªæ–°çš„scroll_idï¼Œç±»ä¼¼äºæŒ‰ä¹¦é¡µç é¡ºåºç¿»ä¹¦å’Œæ¸¸æ ‡ï¼Œé—æ†¾çš„æ˜¯ä¸æ”¯æŒè·³é¡µã€‚ğŸ¤”é€‚ç”¨äºä¸éœ€è¦è·³é¡µæŒç»­æ‰¹é‡æ‹‰å–ç»“æœã€å¯¹æ‰€æœ‰æ•°æ®åˆ†é¡µæˆ–ä¸€æ¬¡æ€§æŸ¥è¯¢å¤§é‡æ•°æ®çš„åœºæ™¯ï¼Œè¿™ç§è®°å½•æ–‡æ¡£ä½ç½®çš„æŸ¥è¯¢æ–¹å¼æ•ˆç‡éå¸¸é«˜ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„å€’æ’ç´¢å¼•ã€‚ä¸‹é¢ä½¿ç”¨java apiå®ç°è¿™ä¸¤ç§åˆ†é¡µæ•ˆæœã€‚ 1. ä½¿ç”¨from sizeæŸ¥è¯¢ä½¿ç”¨ from and size çš„æ·±åº¦åˆ†é¡µï¼Œæ¯”å¦‚è¯´ ?size=10&amp;from=10000 æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œå› ä¸º 100,000 æ’åºçš„ç»“æœå¿…é¡»ä»æ¯ä¸ªåˆ†ç‰‡ä¸Šå–å‡ºå¹¶é‡æ–°æ’åºæœ€åè¿”å› 10 æ¡ã€‚è¿™ä¸ªè¿‡ç¨‹éœ€è¦å¯¹æ¯ä¸ªè¯·æ±‚é¡µé‡å¤ã€‚ 123curl -XPOST 10.10.13.234:9200/goods/fulltext/_search -H 'Content-Type:application/json' -d'{ &quot;from&quot; : 0, &quot;size&quot; : 10, &quot;query&quot; : { &quot;match&quot; : { &quot;content&quot; : &quot;è¿›å£æ°´æœ&quot; }}}' 2. ä½¿ç”¨scrollæŸ¥è¯¢ä½¿ç”¨scrollæŸ¥è¯¢ï¼Œéœ€è¦è®¾ç½®scroll_idçš„å¤±æ•ˆæ—¶é—´ã€‚ 1234curl '10.10.13.234:9200/index/skuId/_search?scroll=1m' -d '{ &quot;query&quot; : { &quot;match&quot; : { &quot;name&quot; : &quot;è¿›å£æ°´æœ&quot; }}}' ä¼šè¿”å›scroll_idï¼Œæ ¹æ®è¿™ä¸ªscroll_idè¿›è¡Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ 12345curl -XGET 10.10.13.234:9200/jd_mall_v2/_search?pretty&amp;scroll=2m -d {&quot;query&quot;:{&quot;match_all&quot;:{}}}curl -XGET '10.10.13.234:9200/jd_mall_v2/_search?pretty&amp;scroll=2m&amp;search_type=scan' -d '{&quot;size&quot;:3,&quot;query&quot;:{&quot;match_all&quot;:{}}}'curl â€“XGET '10.10.13.234:9200/_search/scroll?scroll=2m&amp;pretty&amp;scroll_id=c2Nhbjs1OzcyNTY6N1UtOEx3MmhSQXk2SjFnamw4bk9OUTs3MjYwOjdVLThMdzJoUkF5NkoxZ2psOG5PTlE7NzI1Nzo3VS04THcyaFJBeTZKMWdqbDhuT05ROzcyNTg6N1UtOEx3MmhSQXk2SjFnamw4bk9OUTs3MjU5OjdVLThMdzJoUkF5NkoxZ2psOG5PTlE7MTt0b3RhbF9oaXRzOjUxNTM3MDs=' 1. ä½¿ç”¨esçš„java apiæ“ä½œjava apiå¯æŸ¥é˜…https://es.quanke.name/ï¼Œ åˆ›å»ºspringbootå·¥ç¨‹ï¼Œå¯ä»¥åœ¨http://start.spring.io/ ä¸‹è½½springbootå·¥ç¨‹æ¨¡æ¿ï¼Œä¹Ÿå¯åœ¨github:https://github.com/wonderomg/elasticsearch-visualä¸‹è½½æœ¬å·¥ç¨‹ã€‚ (1)å¯¼å…¥esçš„mavenä¾èµ–ï¼Œpom.xmlå†…å®¹ï¼š 12345678&lt;!-- Elasticsearchæ ¸å¿ƒä¾èµ–åŒ… --&gt;&lt;!-- https://mvnrepository.com/artifact/org.elasticsearch/elasticsearch --&gt;&lt;dependency&gt; &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt; &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt; &lt;version&gt;2.2.1&lt;/version&gt;&lt;/dependency&gt; 1.1 åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨æ£€éªŒç´¢å¼•æ˜¯å¦åˆ›å»ºæˆåŠŸï¼Œæ˜¯å¦å­˜åœ¨ï¼Œé€šè¿‡prepareExistsæŸ¥è¯¢æŒ‡å®šç´¢å¼•ï¼› 123456789101112131415/** * 1.åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨ * * @param client * @param index * @return */ public boolean isIndexExists(Client client, String index) { IndicesAdminClient indicesAdminClient = client.admin().indices(); IndicesExistsResponse response = indicesAdminClient.prepareExists(index).get(); return response.isExists(); /* å¦ä¸€ç§æ–¹å¼ IndicesExistsRequest indicesExistsRequest = new IndicesExistsRequest(index); IndicesExistsResponse response = client.admin().indices().exists(indicesExistsRequest).actionGet();*/ } 1.2 åˆ¤æ–­ç±»å‹æ˜¯å¦å­˜åœ¨ç±»å‹å­˜åœ¨çš„æ£€æŸ¥ä¸ç´¢å¼•çš„æ£€æŸ¥ç±»ä¼¼ï¼Œåªä¸è¿‡ç±»å‹åªæŒ‚åœ¨ç´¢å¼•ä¸‹ï¼Œæ‰€ä»¥éœ€è¦å…ˆæŒ‡å®šç´¢å¼•åï¼Œç„¶åå†æŸ¥è¯¢ç±»å‹æ˜¯å¦å­˜åœ¨ï¼› 12345678910111213141516/** * 2.åˆ¤æ–­ç±»å‹æ˜¯å¦å­˜åœ¨ * * @param client * @param index * @param type * @return */ public boolean isTypeExists(Client client, String index, String type) { if (!isIndexExists(client, index)) { return false; } IndicesAdminClient indicesAdminClient = client.admin().indices(); TypesExistsResponse response = indicesAdminClient.prepareTypesExists(index).setTypes(type).get(); return response.isExists(); } 1.3 åˆ›å»ºå¤æ‚ç´¢å¼•12345678910111213141516171819202122232425262728293031323334353637383940/** * 3.åˆ›å»ºå¤æ‚ç´¢å¼•ï¼Œå³æœ‰æ˜ å°„ * * @param indices * @param type * @param clusterName * @param host * @param port * @return */ public boolean createYxMapping(String indices, String type, String clusterName, String host, int port) { try { Settings settings = Settings.settingsBuilder() .put(&quot;cluster.name&quot;, clusterName) .put(&quot;client.transport.sniff&quot;, true) .build(); Client client = TransportClient.builder().settings(settings).build() .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(host), port)); client.admin().indices().prepareCreate(indices).execute().actionGet(); new XContentFactory(); XContentBuilder builder = XContentFactory.jsonBuilder() .startObject() .startObject(type) .startObject(&quot;properties&quot;) .startObject(&quot;name&quot;).field(&quot;type&quot;, &quot;string&quot;).field(&quot;store&quot;, &quot;yes&quot;).field(&quot;analyzer&quot;, &quot;ik&quot;).field(&quot;index&quot;, &quot;analyzed&quot;).endObject() .startObject(&quot;num&quot;).field(&quot;type&quot;, &quot;long&quot;).endObject() .startObject(&quot;sex&quot;).field(&quot;type&quot;, &quot;string&quot;).field(&quot;index&quot;, &quot;not_analyzed&quot;).endObject() .endObject() .endObject() .endObject(); PutMappingRequest mapping = Requests.putMappingRequest(indices).type(type).source(builder); client.admin().indices().putMapping(mapping).actionGet(); client.close(); return true; } catch (Exception e) { logger.error(&quot;createMapping error &quot;, e); } return false; } 1.4 åˆ›å»ºç©ºç´¢å¼•åˆ›å»ºä¸€ä¸ªç©ºç´¢å¼•ï¼Œæ— æ˜ å°„mappingï¼Œå½“æˆ‘ä»¬è®¾è®¡å¥½mappingçš„ç›¸å…³è®¾ç½®å†æ˜ å°„å³å¯ï¼Œç©ºç´¢å¼•åˆ›å»ºå¦‚ä¸‹ï¼š 1234567891011/** * 4.åˆ›å»ºç©ºç´¢å¼• é»˜è®¤setting æ— mapping * @param client * @param index * @return */public boolean createSimpleIndex(Client client, String index){ IndicesAdminClient indicesAdminClient = client.admin().indices(); CreateIndexResponse response = indicesAdminClient.prepareCreate(index).get(); return response.isAcknowledged();} 1.5 ä¸ºç©ºç´¢å¼•æ˜ å°„mappingå¯ä»¥ä¸ºç©ºç´¢å¼•åˆ›å»ºæˆ–ä¿®æ”¹ç´¢å¼•çš„æ˜ å°„ï¼Œéœ€è¦ç¡®ä¿ç´¢å¼•å­˜åœ¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829/** * 5.è®¾ç½®æ˜ å°„ * @param client * @param index * @param type * @return */public boolean putIndexMapping(Client client, String index, String type){ // mapping XContentBuilder mappingBuilder; try { mappingBuilder = XContentFactory.jsonBuilder() .startObject() .startObject(type) .startObject(&quot;properties&quot;) .startObject(&quot;name&quot;).field(&quot;type&quot;, &quot;string&quot;).field(&quot;store&quot;, &quot;yes&quot;).field(&quot;analyzer&quot;, &quot;ik&quot;).field(&quot;index&quot;, &quot;analyzed&quot;).endObject() .startObject(&quot;num&quot;).field(&quot;type&quot;, &quot;long&quot;).endObject() .startObject(&quot;sex&quot;).field(&quot;type&quot;, &quot;string&quot;).field(&quot;index&quot;, &quot;not_analyzed&quot;).endObject() .endObject() .endObject() .endObject(); } catch (Exception e) { logger.error(&quot;--------- createIndex åˆ›å»º mapping å¤±è´¥ï¼š&quot;, e); return false; } IndicesAdminClient indicesAdminClient = client.admin().indices(); PutMappingResponse response = indicesAdminClient.preparePutMapping(index).setType(type).setSource(mappingBuilder).get(); return response.isAcknowledged();} 1.6 åˆ é™¤ç´¢å¼•åˆ é™¤ç´¢å¼•apiï¼š 1234567891011/** * 6.åˆ é™¤ç´¢å¼• * * @param client * @param index */ public boolean deleteIndex(Client client, String index) { IndicesAdminClient indicesAdminClient = client.admin().indices(); DeleteIndexResponse response = indicesAdminClient.prepareDelete(index).execute().actionGet(); return response.isAcknowledged(); } 1.7 å…³é—­ç´¢å¼•å¦‚æœæˆ‘ä»¬ä¸æƒ³ç›´æ¥åˆ é™¤ç´¢å¼•ï¼Œè€Œæ˜¯ä»…ä»…çŸ­æš‚åœæ­¢æŸä¸ªç´¢å¼•çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…³é—­ç´¢å¼•çš„è¿™ä¸ªåŠŸèƒ½ï¼Œåªæ˜¯çŸ­æš‚ä½¿ç”¨ä¹‹ï¼Œåç»­å¯èƒ½æœ‰æ¢å¤çš„éœ€æ±‚ï¼Œå…³é—­ä½¿ç”¨å¦‚ä¸‹ï¼š 123456789101112/** * 7.å…³é—­ç´¢å¼• * @param client * @param index * @return */public boolean closeIndex(Client client, String index){ IndicesAdminClient indicesAdminClient = client.admin().indices(); CloseIndexResponse response = indicesAdminClient.prepareClose(index).get(); return response.isAcknowledged();} 1.8 æ‰“å¼€ç´¢å¼•æ—¢ç„¶æœ‰å…³é—­ç´¢å¼•ï¼Œé‚£ä¹ˆè‚¯å®šä¹Ÿæœ‰é‡æ–°æ‰“å¼€ç´¢å¼•çš„æ“ä½œï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011/** * 8.å¼€å¯ç´¢å¼• * @param client * @param index * @return */public boolean openIndex(Client client, String index){ IndicesAdminClient indicesAdminClient = client.admin().indices(); OpenIndexResponse response = indicesAdminClient.prepareOpen(index).get(); return response.isAcknowledged();} 1.9 åˆ¤æ–­åˆ«åæ˜¯å¦å­˜åœ¨ä¸Šä¸€ç¯‡æˆ‘ä»¬å­¦ä¹ äº†ç´¢å¼•åˆ«åçš„é‡è¦ï¼Œæ‰€ä»¥apiä¹Ÿä¸èƒ½è½ä¸‹ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011/** * 9.åˆ¤æ–­åˆ«åæ˜¯å¦å­˜åœ¨ * * @param * @return */ public boolean isAliasExist(Client client, String... aliases) { IndicesAdminClient indicesAdminClient = client.admin().indices(); AliasesExistResponse response = indicesAdminClient.prepareAliasesExist(aliases).get(); return response.isExists(); } 1.10 æ·»åŠ åˆ«ååˆ«åæ˜¯æ˜ å°„åˆ°å®é™…ç´¢å¼•ä¸Šï¼Œæ‰€ä»¥éœ€è¦ä¼ å…¥å®é™…ç´¢å¼•åä»¥åŠè¦è®¾ç½®çš„åˆ«åaliasï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011/** * 10.æ·»åŠ åˆ«å * * @param * @return */ public boolean addAlias(TransportClient client, String index, String alias) { IndicesAdminClient indicesAdminClient = client.admin().indices(); IndicesAliasesResponse response = indicesAdminClient.prepareAliases().addAlias(index, alias).get(); return response.isAcknowledged(); } 1.11 ç§»é™¤åˆ«åå½“ç„¶ï¼Œæ·»åŠ çš„åˆ«åä¹Ÿå¯ä»¥åˆ é™¤ï¼Œæ–¹ä¾¿è®¾ç½®æ–°çš„åˆ«åå’Œåˆ‡æ¢ç´¢å¼•åˆ«åï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011/** * 11.ç§»é™¤åˆ«å * * @param * @return */ public boolean removeAlias(TransportClient client, String index, String alias) { IndicesAdminClient indicesAdminClient = client.admin().indices(); IndicesAliasesResponse response = indicesAdminClient.prepareAliases().removeAlias(index, alias).get(); return response.isAcknowledged(); } 1.12 åˆ é™¤ä¸€ä¸ªåˆ«ååå†æ·»åŠ ä¸€ä¸ªåˆ«åè¿™é‡Œå®é™…ä¸Šå°†åˆ é™¤ä¸æ·»åŠ åˆ«åæ”¾åœ¨ä¸€èµ·æ“ä½œï¼Œæ‰€ä»¥éœ€è¦ä¼ å°±åˆ«åå’Œæ–°åˆ«åï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 12345678910111213/** * 12.åˆ é™¤ä¸€ä¸ªåˆ«ååå†æ·»åŠ ä¸€ä¸ª * * @param * @return */ @Override public boolean removeAndCreateAlias(TransportClient client, String indexOld, String indexNew, String alias) { IndicesAdminClient indicesAdminClient = client.admin().indices(); IndicesAliasesResponse response = indicesAdminClient.prepareAliases().removeAlias(indexOld, alias) .addAlias(indexNew, alias).get(); return response.isAcknowledged(); } 2. åˆ›å»ºæµ‹è¯•åŸºç±»è¿æ¥esåˆ›å»ºtestç±»æµ‹è¯•è¿æ¥ã€æ’å…¥ã€æŸ¥è¯¢æ•°æ®æ˜¯å¦æ­£å¸¸ã€‚ è¿™é‡Œå¯ä»¥æ¨¡æ‹Ÿä¸€æ‰¹æ•°æ®æ’å…¥esï¼Œåé¢çš„åˆ†é¡µæ“ä½œå¯¹å¤§é‡æ•°æ®æ‰çœ‹å¾—å‡ºæ•ˆæœï¼Œæˆ‘è¿™é‡Œæœ‰çš„40ä¸‡æ•°æ®åŠ å…¥åˆ°esä¸­ï¼Œæ–¹ä¾¿åé¢çš„åˆ†é¡µæµ‹è¯•ã€‚ ElasticsearchTest.java: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611import com.alibaba.fastjson.JSON;import com.fasterxml.jackson.core.JsonProcessingException;import com.fasterxml.jackson.databind.ObjectMapper;import com.sun.controller.DateUtils;import org.elasticsearch.action.admin.indices.analyze.AnalyzeAction;import org.elasticsearch.action.admin.indices.analyze.AnalyzeRequestBuilder;import org.elasticsearch.action.admin.indices.analyze.AnalyzeResponse;import org.elasticsearch.action.admin.indices.mapping.put.PutMappingRequest;import org.elasticsearch.action.delete.DeleteResponse;import org.elasticsearch.action.get.GetResponse;import org.elasticsearch.action.index.IndexResponse;import org.elasticsearch.action.search.SearchRequestBuilder;import org.elasticsearch.action.search.SearchResponse;import org.elasticsearch.action.search.SearchType;import org.elasticsearch.action.update.UpdateResponse;import org.elasticsearch.client.Client;import org.elasticsearch.client.Requests;import org.elasticsearch.client.transport.TransportClient;import org.elasticsearch.common.settings.Settings;import org.elasticsearch.common.transport.InetSocketTransportAddress;import org.elasticsearch.common.unit.TimeValue;import org.elasticsearch.common.xcontent.XContentBuilder;import org.elasticsearch.common.xcontent.XContentFactory;import org.elasticsearch.index.query.*;import org.elasticsearch.search.SearchHits;import org.junit.Before;import org.junit.Test;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import java.io.BufferedReader;import java.io.File;import java.io.FileInputStream;import java.io.InputStreamReader;import java.net.InetAddress;import java.net.UnknownHostException;import java.util.ArrayList;import java.util.List;import java.util.Map;import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;/** * ç±»åŠŸèƒ½æè¿°:Elasticsearchçš„åŸºæœ¬æµ‹è¯• * * @author liu * @since 2018/5/24 */public class ElasticsearchTest { private Logger logger = LoggerFactory.getLogger(ElasticsearchTest.class); public final static String HOST = &quot;10.10.13.234&quot;; /** httpè¯·æ±‚çš„ç«¯å£æ˜¯9200ï¼Œå®¢æˆ·ç«¯æ˜¯9300 */ public final static int PORT = 9300; Client client; /** ç´¢å¼•åº“å */ private static String index = &quot;my_index&quot;; /** ç±»å‹åç§° */ private static String type = &quot;skuId&quot;; private static String clusterName = &quot;my-application&quot;; /** * åˆ›å»ºmappingï¼Œæ³¨æ„ï¼šæ¯æ¬¡åªèƒ½åˆ›å»ºä¸€æ¬¡ * åˆ›å»ºmapping(field(&quot;indexAnalyzer&quot;,&quot;ik&quot;)è¯¥å­—æ®µåˆ†è¯IKç´¢å¼• ï¼›field(&quot;searchAnalyzer&quot;,&quot;ik&quot;)è¯¥å­—æ®µåˆ†è¯ikæŸ¥è¯¢ï¼›å…·ä½“åˆ†è¯æ’ä»¶è¯·çœ‹IKåˆ†è¯æ’ä»¶è¯´æ˜) * åˆ›å»ºmapping(field(&quot;analyzer&quot;,&quot;ik&quot;)è¯¥å­—æ®µåˆ†è¯IKç´¢å¼• ï¼›field(&quot;index&quot;,&quot;analyzed&quot;)è¯¥å­—æ®µåˆ†è¯ikæŸ¥è¯¢ï¼›å…·ä½“åˆ†è¯æ’ä»¶è¯·çœ‹IKåˆ†è¯æ’ä»¶è¯´æ˜)2.xç‰ˆ * @param indices ç´¢å¼•åç§°ï¼› * @param mappingType ç±»å‹ * @throws Exception */ @Test public void createMapping()throws Exception { String indices = &quot;jd_mall_v2&quot;; String mappingType = &quot;goods&quot;; Settings settings = Settings.settingsBuilder() .put(&quot;cluster.name&quot;, clusterName) .put(&quot;client.transport.sniff&quot;, true) .build(); Client client = TransportClient.builder().settings(settings).build() .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(HOST), PORT)); client.admin().indices().prepareCreate(indices).execute().actionGet(); new XContentFactory(); XContentBuilder builder=XContentFactory.jsonBuilder() .startObject() .startObject(mappingType) .startObject(&quot;properties&quot;) .startObject(&quot;name&quot;).field(&quot;type&quot;, &quot;string&quot;).field(&quot;store&quot;, &quot;yes&quot;).field(&quot;analyzer&quot;,&quot;ik&quot;).field(&quot;index&quot;,&quot;analyzed&quot;).endObject() .startObject(&quot;price&quot;).field(&quot;type&quot;, &quot;long&quot;).endObject() .endObject() .endObject() .endObject(); PutMappingRequest mapping = Requests.putMappingRequest(indices).type(mappingType).source(builder); client.admin().indices().putMapping(mapping).actionGet(); client.close(); } @Before public void before() { /** * 1:é€šè¿‡ settingå¯¹è±¡æ¥æŒ‡å®šé›†ç¾¤é…ç½®ä¿¡æ¯ * //æŒ‡å®šé›†ç¾¤åç§° * //å¯åŠ¨å—…æ¢åŠŸèƒ½ */ Settings settings = Settings.settingsBuilder() .put(&quot;cluster.name&quot;, clusterName) .put(&quot;client.transport.sniff&quot;, true) .build(); /** * 2ï¼šåˆ›å»ºå®¢æˆ·ç«¯ * é€šè¿‡settingæ¥åˆ›å»ºï¼Œè‹¥ä¸æŒ‡å®šåˆ™é»˜è®¤é“¾æ¥çš„é›†ç¾¤åä¸ºelasticsearch * é“¾æ¥ä½¿ç”¨tcpåè®®å³9300 */ try { client = TransportClient.builder().settings(settings).build() .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(HOST), PORT)); System.out.println(&quot;Elasticsearch connect info:&quot; + client.toString()); } catch (UnknownHostException e) { e.printStackTrace(); } /*transportClient = new TransportClient(setting); TransportAddress transportAddress = new InetSocketTransportAddress(&quot;192.168.79.131&quot;, 9300); transportClient.addTransportAddresses(transportAddress);*/ /** * 3ï¼šæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ * æ³¨æ„æˆ‘çš„é›†ç¾¤ç»“æ„æ˜¯ï¼š * 131çš„elasticsearch.ymlä¸­æŒ‡å®šä¸ºä¸»èŠ‚ç‚¹ä¸èƒ½å­˜å‚¨æ•°æ®ï¼Œ * 128çš„elasticsearch.ymlä¸­æŒ‡å®šä¸ä¸ºä¸»èŠ‚ç‚¹åªèƒ½å­˜å‚¨æ•°æ®ã€‚ * æ‰€æœ‰æ§åˆ¶å°åªæ‰“å°äº†192.168.79.128,åªèƒ½è·å–æ•°æ®èŠ‚ç‚¹ * */ /*ImmutableList&lt;DiscoveryNode&gt; connectedNodes = client.connectedNodes(); for(DiscoveryNode node : connectedNodes) { System.out.println(node.getHostAddress()); }*/ } /** * æµ‹è¯•Elasticsearchå®¢æˆ·ç«¯è¿æ¥ * @Title: test1 * @author sunt * @date 2017å¹´11æœˆ22æ—¥ * @return void * @throws UnknownHostException */ @SuppressWarnings(&quot;resource&quot;) @Test public void test1() throws UnknownHostException { //åˆ›å»ºå®¢æˆ·ç«¯ /*TransportClient client = new PreBuiltTransportClient(Settings.EMPTY).addTransportAddresses( new InetSocketTransportAddress(InetAddress.getByName(HOST),PORT));*/ TransportClient client = TransportClient.builder().build().addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(HOST), PORT)); logger.debug(&quot;Elasticsearch connect info:&quot; + client.toString()); System.out.println(&quot;Elasticsearch connect info:&quot; + client.toString()); //å…³é—­å®¢æˆ·ç«¯ client.close(); } /** * æŸ¥ * * @throws Exception */ @Test public void testGet() throws Exception { String skuId = &quot;3724941&quot;; String skuName = &quot;åç››é¡¿è‹¹æœç¤¼ç›’ 8ä¸ªè£…ï¼ˆ4ä¸ªçº¢è›‡æœ+4ä¸ªé’è‹¹æœï¼‰å•æœé‡çº¦145g-180g æ–°é²œæ°´æœç¤¼ç›’&quot;; String skuPrice = &quot;4990&quot;; //è·å–_idä¸º1çš„ç±»å‹ /*GetResponse response1 = client.prepareGet(index, &quot;person&quot;, &quot;9&quot;).get(); response1.getSourceAsMap();//è·å–å€¼è½¬æ¢æˆmap System.out.println(&quot;æŸ¥è¯¢ä¸€æ¡æ•°æ®:&quot; + JSON.toJSON(response1.getSourceAsMap()));*/ //è·å–åˆ†è¯ List&lt;String&gt; listAnalysis = getIkAnalyzeSearchTerms(&quot;è¿›å£æ°´æœ&quot;); //List&lt;Map&lt;String, Object&gt;&gt; resultList6 = testMultiQueryStringQuery(index, type, &quot;name&quot;, listAnalysis); List&lt;Map&lt;String, Object&gt;&gt; resultList3 = testQueryStringQuery(index, type, &quot;name&quot;, &quot;è¿›å£æ°´æœ&quot;); //List&lt;Map&lt;String, Object&gt;&gt; resultList4 = getDataByWildcard(index, type, &quot;name&quot;, &quot;*æ°´æœ*&quot;); //List&lt;Map&lt;String, Object&gt;&gt; resultList5 = getDataByMatch(index, type, &quot;name&quot;, &quot;è¿›å£ æ°´æœ&quot;); //List&lt;Map&lt;String, Object&gt;&gt; resultList = getQueryDataBySingleField(index, type, &quot;name&quot;, &quot;è¿›å£æ°´æœ&quot;); //List&lt;Map&lt;String, Object&gt;&gt; resultList2 = testSearchByPrefix(index, &quot;name&quot;, &quot;è¿›å£æ°´æœ&quot;); //System.out.println(); } /** * å¢æŸ¥ * * @throws Exception */ @Test public void testCreate() throws Exception { String[] skuIds = {&quot;2246904&quot;, &quot;2138027&quot;, &quot;3724941&quot;, &quot;5664705&quot;, &quot;3711635&quot;}; String[] skuNames = {&quot;æœèŠ± çç å²© æ— åœŸæ ½åŸ¹åŸºè´¨ é¢—ç²’çŠ¶ ä¿æ¸©æ€§èƒ½å¥½ å›­è‰ºç”¨å“&quot;, &quot;è¿›å£åç››é¡¿çº¢è›‡æœ è‹¹æœ4ä¸ªè£… å•æœé‡çº¦180g æ–°é²œæ°´æœ&quot;, &quot;åç››é¡¿è‹¹æœç¤¼ç›’ 8ä¸ªè£…ï¼ˆ4ä¸ªçº¢è›‡æœ+4ä¸ªé’è‹¹æœï¼‰å•æœé‡çº¦145g-180g æ–°é²œæ°´æœç¤¼ç›’&quot;, &quot;æ–°ç–†é˜¿å…‹è‹å†°ç³–å¿ƒ çº¦5kg å•æœ200-250gï¼ˆ7Fresh ä¸“ä¾›ï¼‰&quot;, &quot;æ±Ÿè¥¿åç‰Œ æ¨æ°ç²¾å“è„æ©™ 5kgè£… é“‚é‡‘æœ æ°´æœæ©™å­ç¤¼ç›’ 2ç§åŒ…è£…éšæœºå‘è´§&quot;}; String[] skuPrices = {&quot;500&quot;, &quot;3800&quot;, &quot;4990&quot;, &quot;8500&quot;, &quot;5880&quot;}; for (int i=0; i&lt;skuIds.length; i++) { String skuId = skuIds[i]; String skuName = skuNames[i]; String skuPrice = skuPrices[i]; String jsonStr = &quot;{&quot; + &quot;\\&quot;skuId\\&quot;:\\&quot;&quot;+skuId+&quot;\\&quot;,&quot; + &quot;\\&quot;skuName\\&quot;:\\&quot;&quot;+skuName+&quot;\\&quot;,&quot; + &quot;\\&quot;skuPrice\\&quot;:\\&quot;&quot;+skuPrice+&quot;\\&quot;&quot; + &quot;}&quot;; //å‚æ•°è¯´æ˜ï¼š ç´¢å¼•ï¼Œç±»å‹ ï¼Œ_idï¼›//setSourceå¯ä»¥ä¼ ä»¥ä¸Šmap string byte[] å‡ ç§æ–¹å¼ IndexResponse response = client.prepareIndex(index, type, skuId) .setSource(jsonStr,XContentType.JSON) .get(); boolean created = response.isCreated(); System.out.println(&quot;åˆ›å»ºä¸€æ¡è®°å½•:&quot; + created); //è·å–_idä¸º1çš„ç±»å‹ GetResponse response1 = client.prepareGet(index, type, skuId).get(); response1.getSourceAsMap();//è·å–å€¼è½¬æ¢æˆmap System.out.println(&quot;æŸ¥è¯¢ä¸€æ¡æ•°æ®:&quot; + JSON.toJSON(response1.getSourceAsMap())); } } /** * åˆ æŸ¥ * * @throws Exception */ @Test public void testDelete() throws Exception { String skuId = &quot;3724941&quot;; String skuName = &quot;åç››é¡¿è‹¹æœç¤¼ç›’ 8ä¸ªè£…ï¼ˆ4ä¸ªçº¢è›‡æœ+4ä¸ªé’è‹¹æœï¼‰å•æœé‡çº¦145g-180g æ–°é²œæ°´æœç¤¼ç›’&quot;; String skuPrice = &quot;4990&quot;; String skuImage = &quot;jfs/t16450/249/461724533/219792/7f204d7a/5a321ecbN4526f7d3.jpg&quot;; //åˆ é™¤_idä¸º1çš„ç±»å‹ DeleteResponse response2 = client.prepareDelete(index, type, skuId).get(); System.out.println(&quot;åˆ é™¤ä¸€æ¡æ•°æ®ï¼š&quot; + response2.isFound()); //è·å–_idä¸º1çš„ç±»å‹ GetResponse response1 = client.prepareGet(index, type, skuId).get(); response1.getSourceAsMap();//è·å–å€¼è½¬æ¢æˆmap System.out.println(&quot;æŸ¥è¯¢ä¸€æ¡æ•°æ®:&quot; + JSON.toJSON(response1.getSourceAsMap())); } /** * æ”¹æŸ¥ * * @throws Exception */ @Test public void testUpdate() throws Exception { String skuId = &quot;3724941&quot;; String skuName = &quot;åç››é¡¿è‹¹æœç¤¼ç›’ 8ä¸ªè£…ï¼ˆ4ä¸ªçº¢è›‡æœ+4ä¸ªé’è‹¹æœï¼‰å•æœé‡çº¦145g-180g æ–°é²œæ°´æœç¤¼ç›’&quot;; String skuPrice = &quot;4990&quot;; String skuName2 = &quot;ååœ£ é™•è¥¿ç²¾å“çº¢å¯Œå£«è‹¹æœ 12ä¸ªè£… æœå¾„75mm çº¦2.1kg æ–°é²œæ°´æœ&quot;; //æ›´æ–° UpdateResponse updateResponse = client.prepareUpdate(index, type, skuId).setDoc(jsonBuilder() .startObject() .field(&quot;name&quot;, skuName2) .endObject()) .get(); System.out.println(&quot;æ›´æ–°ä¸€æ¡æ•°æ®:&quot; + updateResponse.isCreated()); //è·å–_idä¸º1çš„ç±»å‹ GetResponse response1 = client.prepareGet(index, type, skuId).get(); response1.getSourceAsMap();//è·å–å€¼è½¬æ¢æˆmap System.out.println(&quot;æŸ¥è¯¢ä¸€æ¡æ•°æ®:&quot; + JSON.toJSON(response1.getSourceAsMap())); } /** * å°†å¯¹è±¡é€šè¿‡jackson.databindè½¬æ¢æˆbyte[] * æ³¨æ„ä¸€ä¸‹dateç±»å‹éœ€è¦æ ¼å¼åŒ–å¤„ç† é»˜è®¤æ˜¯ æ—¶é—´æˆ³ * * @return */ public byte[] convertByteArray(Object obj) { // create once, reuse ObjectMapper mapper = new ObjectMapper(); try { byte[] json = mapper.writeValueAsBytes(obj); return json; } catch (JsonProcessingException e) { e.printStackTrace(); } return null; } /** * å°†å¯¹è±¡é€šè¿‡JSONtoStringè½¬æ¢æˆJSONå­—ç¬¦ä¸² * ä½¿ç”¨fastjson æ ¼å¼åŒ–æ³¨è§£ åœ¨å±æ€§ä¸ŠåŠ å…¥ @JSONField(format=&quot;yyyy-MM-dd HH:mm:ss&quot;) * * @return */ public String jsonStr(Object obj) { return JSON.toJSONString(obj); } /*****************************/ /** * æ ¹æ®æ–‡æ¡£åã€å­—æ®µåã€å­—æ®µå€¼æŸ¥è¯¢æŸä¸€æ¡è®°å½•çš„è¯¦ç»†ä¿¡æ¯ï¼›queryæŸ¥è¯¢ * @param type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xzï¼› * @param key å­—æ®µåï¼Œä¾‹å¦‚ï¼šbdcqzh * @param value å­—æ®µå€¼ï¼Œå¦‚ï¼šâ€œâ€ * @return List * @author Lixin */ public List getQueryDataBySingleField(String index, String type, String key, String value){ //TransportClient client = getClient(); QueryBuilder qb = QueryBuilders.termQuery(key, value); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(qb) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å¤šæ¡ä»¶ æ–‡æ¡£åã€å­—æ®µåã€å­—æ®µå€¼ï¼ŒæŸ¥è¯¢æŸä¸€æ¡è®°å½•çš„è¯¦ç»†ä¿¡æ¯ * @param type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xz * @param map å­—æ®µåï¼šå­—æ®µå€¼ çš„map * @return List * @author Lixin */ public List getBoolDataByMuchField(String index, String type, Map&lt;String,String&gt; map){ //TransportClient client = getClient(); BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); for (String in : map.keySet()) { //map.keySet()è¿”å›çš„æ˜¯æ‰€æœ‰keyçš„å€¼ String str = map.get(in);//å¾—åˆ°æ¯ä¸ªkeyå¤šå¯¹ç”¨valueçš„å€¼ boolQueryBuilder.must(QueryBuilders.termQuery(in,str)); } SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å•æ¡ä»¶ é€šé…ç¬¦æŸ¥è¯¢ * @param type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xz * @param key å­—æ®µåï¼Œä¾‹å¦‚ï¼šbdcqzh * @param value å­—æ®µåæ¨¡ç³Šå€¼ï¼šå¦‚ *123* ;?123*;?123?;*123?; * @return List * @author Lixin */ public List getDataByWildcard(String index, String type, String key, String value){ //TransportClient client = getClient(); WildcardQueryBuilder wBuilder = QueryBuilders.wildcardQuery(key, value); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(wBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å¤šæ¡ä»¶ é€šé…ç¬¦æŸ¥è¯¢ * @param type type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xz * @param map åŒ…å«key:value æ¨¡ç³Šå€¼é”®å€¼å¯¹ * @return List * @author Lixin */ public List getDataByMuchWildcard(String index, String type, Map&lt;String,String&gt; map){ //TransportClient client = getClient(); BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); for (String in : map.keySet()) { //map.keySet()è¿”å›çš„æ˜¯æ‰€æœ‰keyçš„å€¼ String str = map.get(in);//å¾—åˆ°æ¯ä¸ªkeyå¤šå¯¹ç”¨valueçš„å€¼ boolQueryBuilder.must(QueryBuilders.wildcardQuery(in,str)); } SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å•æ¡ä»¶ æ¨¡ç³Šæ‹†åˆ†æŸ¥è¯¢ * @param type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xz * @param key å­—æ®µåï¼Œä¾‹å¦‚ï¼šbdcqzh * @param value å­—æ®µåæ¨¡ç³Šå€¼ï¼šå¦‚ *123* ;?123*;?123?;*123?; * @return List * @author Lixin */ public List getDataByMatch(String index, String type, String key, String value){ //TransportClient client = getClient(); MatchQueryBuilder mBuilder = QueryBuilders.matchQuery(key, value); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(mBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å•æ¡ä»¶ ä¸­æ–‡åˆ†è¯æ¨¡ç³ŠæŸ¥è¯¢ * @param type æ–‡æ¡£åï¼Œç›¸å½“äºoracleä¸­çš„è¡¨åï¼Œä¾‹å¦‚ï¼šql_xz * @param key å­—æ®µåï¼Œä¾‹å¦‚ï¼šbdcqzh * @param value å­—æ®µåæ¨¡ç³Šå€¼ï¼šå¦‚ *123* ;?123*;?123?;*123?; * @return List * @author Lixin */ public List getDataByPrefix(String index, String type, String key, String value){ //TransportClient client = getClient(); PrefixQueryBuilder pBuilder = QueryBuilders.prefixQuery(key, value); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(pBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * ä¸­æ–‡åˆ†è¯çš„æ“ä½œ * 1.æŸ¥è¯¢ä»¥&quot;ä¸­&quot;å¼€å¤´çš„æ•°æ®ï¼Œæœ‰ä¸¤æ¡ * 2.æŸ¥è¯¢ä»¥â€œä¸­å›½â€å¼€å¤´çš„æ•°æ®ï¼Œæœ‰0æ¡ * 3.æŸ¥è¯¢åŒ…å«â€œçƒ‚â€çš„æ•°æ®ï¼Œæœ‰1æ¡ * 4.æŸ¥è¯¢åŒ…å«â€œçƒ‚æ‘Šå­â€çš„æ•°æ®ï¼Œæœ‰0æ¡ * åˆ†è¯ï¼š * ä¸ºä»€ä¹ˆæˆ‘ä»¬æœç´¢China is the greatest country~ * ä¸­æ–‡ï¼šä¸­å›½æœ€ç‰›é€¼ * * Ã—Ã—Ã— * ä¸­å * äººæ°‘ * å…±å’Œå›½ * ä¸­åäººæ°‘ * äººæ°‘å…±å’Œå›½ * åäºº * å…±å’Œ * ç‰¹æ®Šçš„ä¸­æ–‡åˆ†è¯æ³•ï¼š * åº–ä¸è§£ç‰› * IKåˆ†è¯æ³• * æœç‹—åˆ†è¯æ³• */ public List testSearchByPrefix(String index, String key, String value) { // åœ¨prepareSearch()çš„å‚æ•°ä¸ºç´¢å¼•åº“åˆ—è¡¨ï¼Œæ„ä¸ºè¦ä»å“ªäº›ç´¢å¼•åº“ä¸­è¿›è¡ŒæŸ¥è¯¢ SearchResponse response = client.prepareSearch(index) .setSearchType(SearchType.DEFAULT) // è®¾ç½®æŸ¥è¯¢ç±»å‹ï¼Œæœ‰QUERY_AND_FETCH QUERY_THEN_FETCH DFS_QUERY_AND_FETCH DFS_QUERY_THEN_FETCH //.setSearchType(SearchType.DEFAULT) // è®¾ç½®æŸ¥è¯¢ç±»å‹ï¼Œæœ‰QUERY_AND_FETCH QUERY_THEN_FETCH DFS_QUERY_AND_FETCH DFS_QUERY_THEN_FETCH //.setQuery(QueryBuilders.prefixQuery(&quot;content&quot;, &quot;çƒ‚æ‘Šå­&quot;))// è®¾ç½®ç›¸åº”çš„queryï¼Œç”¨äºæ£€ç´¢ï¼ŒtermQueryçš„å‚æ•°è¯´æ˜ï¼šnameæ˜¯docä¸­çš„å…·ä½“çš„fieldï¼Œvalueå°±æ˜¯è¦æ‰¾çš„å…·ä½“çš„å€¼// .setQuery(QueryBuilders.regexpQuery(&quot;content&quot;, &quot;.*çƒ‚æ‘Šå­.*&quot;)) .setQuery(QueryBuilders.prefixQuery(key, value)) .get(); return responseToList(client,response); } public List testFuzzyQuery(String index, String type, String key, String value){ //TransportClient client = getClient(); FuzzyQueryBuilder fBuilder = QueryBuilders.fuzzyQuery(key, value); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(fBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } public List testQueryStringQuery(String index, String type, String key, String value){ //TransportClient client = getClient(); QueryBuilder fBuilder = QueryBuilders.queryStringQuery(value).field(key); SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(fBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } public List testMultiQueryStringQuery(String index, String type, String key, List&lt;String&gt; listAnalysis){ //TransportClient client = getClient(); BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); for (String term : listAnalysis) { boolQueryBuilder.should(QueryBuilders.queryStringQuery(term).field(key)); //è¿™é‡Œå¯ä»¥ç”¨must æˆ–è€… should è§†æƒ…å†µè€Œå®š } SearchResponse response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(0).setSize(10000).setExplain(true) .execute() .actionGet(); return responseToList(client,response); } /** * å°†æŸ¥è¯¢åè·å¾—çš„responseè½¬æˆlist * @param client * @param response * @return */ public List responseToList(Client client, SearchResponse response){ SearchHits hits = response.getHits(); List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;Map&lt;String,Object&gt;&gt;(); System.out.println(&quot;------------------------&quot;); for (int i = 0; i &lt; hits.getHits().length; i++) { Map&lt;String, Object&gt; map = hits.getAt(i).getSource(); System.out.println(map.get(&quot;name&quot;)); list.add(map); } System.out.println(&quot;------------------------&quot;); //client.close(); return list; } /** * è°ƒç”¨ ES è·å– IK åˆ†è¯åç»“æœ * * @param searchContent * @return */ private List&lt;String&gt; getIkAnalyzeSearchTerms(String searchContent) { //è°ƒç”¨ IK åˆ†è¯åˆ†è¯ AnalyzeRequestBuilder ikRequest = new AnalyzeRequestBuilder(client, AnalyzeAction.INSTANCE, index, searchContent); //ikRequest.setAnalyzer(&quot;ik&quot;); ikRequest.setTokenizer(&quot;ik&quot;); List&lt;AnalyzeResponse.AnalyzeToken&gt; ikTokenList = ikRequest.execute().actionGet().getTokens(); //å¾ªç¯èµ‹å€¼ List&lt;String&gt; searchTermList = new ArrayList&lt;&gt;(); //ikTokenList.forEach(ikToken -&gt; { searchTermList.add(ikToken.getTerm()); }); for (AnalyzeResponse.AnalyzeToken ikToken: ikTokenList) { System.out.println(ikToken.getTerm()); searchTermList.add(ikToken.getTerm()); } return searchTermList; } /** * ç„¶åå°±æ˜¯åˆ›å»ºä¸¤ä¸ªæŸ¥è¯¢è¿‡ç¨‹äº† ï¼Œä¸‹é¢æ˜¯from-sizeåˆ†é¡µçš„æ‰§è¡Œä»£ç ï¼š */ @Test public void testFromSize() { System.out.println(&quot;from size æ¨¡å¼å¯åŠ¨ï¼&quot;); long begin = System.currentTimeMillis(); long count = client.prepareCount(index).setTypes(type).execute() .actionGet().getCount(); //QueryBuilder qBuilder = QueryBuilders.queryStringQuery(value).field(key); SearchRequestBuilder requestBuilder = client.prepareSearch(index).setTypes(type) .setQuery(QueryBuilders.queryStringQuery(&quot;è¿›å£æ°´æœ&quot;).field(&quot;name&quot;)); for (int i=0,sum=0; sum&lt;count; i++) { SearchResponse response = requestBuilder.setFrom(i).setSize(3).execute().actionGet(); sum += response.getHits().hits().length; responseToList(client,response); System.out.println(&quot;æ€»é‡&quot;+count+&quot;, å·²ç»æŸ¥åˆ°&quot;+sum); } System.out.println(&quot;elapsed&lt;&quot;+(System.currentTimeMillis()-begin)+&quot;&gt;ms.&quot;); } /** * ä¸‹é¢æ˜¯scrollåˆ†é¡µçš„æ‰§è¡Œä»£ç ï¼Œæ³¨æ„å•Šï¼scrollé‡Œé¢çš„sizeæ˜¯ç›¸å¯¹äºæ¯ä¸ªåˆ†ç‰‡æ¥è¯´çš„ï¼Œ * æ‰€ä»¥å®é™…è¿”å›çš„æ•°é‡æ˜¯ï¼šåˆ†ç‰‡çš„æ•°é‡*size */ @Test public void testScroll() { //String index, String type,String key,String value System.out.println(&quot;scroll æ¨¡å¼å¯åŠ¨ï¼&quot;); long begin = System.currentTimeMillis(); //QueryBuilder qBuilder = QueryBuilders.queryStringQuery(value).field(key); //è·å–Clientå¯¹è±¡,è®¾ç½®ç´¢å¼•åç§°,æœç´¢ç±»å‹(SearchType.SCAN),æœç´¢æ•°é‡,å‘é€è¯·æ±‚ SearchResponse scrollResponse = client.prepareSearch(index) .setTypes(type) .setQuery(QueryBuilders.queryStringQuery(&quot;è¿›å£æ°´æœ&quot;).field(&quot;name&quot;)) .setSearchType(SearchType.SCAN).setSize(3).setScroll(TimeValue.timeValueMinutes(1)) .execute().actionGet(); //æ³¨æ„:é¦–æ¬¡æœç´¢å¹¶ä¸åŒ…å«æ•°æ®ï¼Œç¬¬ä¸€æ¬¡ä¸è¿”å›æ•°æ®ï¼Œè·å–æ€»æ•°é‡ long count = scrollResponse.getHits().getTotalHits(); for (int i=0,sum=0; sum&lt;count; i++) { scrollResponse = client.prepareSearchScroll(scrollResponse.getScrollId()) .setScroll(TimeValue.timeValueMinutes(8)).execute().actionGet(); sum += scrollResponse.getHits().hits().length; responseToList(client,scrollResponse); System.out.println(&quot;æ€»é‡&quot;+count+&quot;, å·²ç»æŸ¥åˆ°&quot;+sum); } System.out.println(&quot;elapsed&lt;&quot;+(System.currentTimeMillis()-begin)+&quot;&gt;ms.&quot;); }} 3. åˆ†é¡µä»£ç åˆ›å»ºTestControllerç±»ï¼Œåœ¨ä¸Šè¿°æµ‹è¯•éƒ½æ— é—®é¢˜ä¹‹åï¼Œå†è¿›è¡Œä¸‹é¢çš„åˆ†é¡µæ“ä½œã€‚ TestController.javaï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387package com.sun.controller;import com.alibaba.fastjson.JSONObject;import org.elasticsearch.action.search.SearchRequestBuilder;import org.elasticsearch.action.search.SearchScrollRequestBuilder;import org.elasticsearch.search.SearchHit;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.elasticsearch.action.admin.indices.analyze.AnalyzeAction;import org.elasticsearch.action.admin.indices.analyze.AnalyzeRequestBuilder;import org.elasticsearch.action.admin.indices.analyze.AnalyzeResponse;import org.elasticsearch.action.search.SearchResponse;import org.elasticsearch.action.search.SearchType;import org.elasticsearch.client.Client;import org.elasticsearch.client.transport.TransportClient;import org.elasticsearch.common.settings.Settings;import org.elasticsearch.common.transport.InetSocketTransportAddress;import org.elasticsearch.common.unit.TimeValue;import org.elasticsearch.index.query.BoolQueryBuilder;import org.elasticsearch.index.query.QueryBuilder;import org.elasticsearch.index.query.QueryBuilders;import org.elasticsearch.search.SearchHits;import org.elasticsearch.search.sort.SortOrder;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RequestParam;import org.springframework.web.bind.annotation.ResponseBody;import org.springframework.web.bind.annotation.RestController;import java.net.InetAddress;import java.net.UnknownHostException;import java.util.ArrayList;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.concurrent.atomic.AtomicLong;/** * ç±»åŠŸèƒ½æè¿°: * * @author liu * @since 2018/2/22 */@RestControllerpublic class TestController { private Logger logger = LoggerFactory.getLogger(this.getClass()); public final static String HOST = &quot;10.10.13.234&quot;; /** httpè¯·æ±‚çš„ç«¯å£æ˜¯9200ï¼Œå®¢æˆ·ç«¯æ˜¯9300 */ public final static int PORT = 9300; /** ç´¢å¼•åº“å */ private static String index = &quot;my_index&quot;; /** ç±»å‹åç§° */ private static String type = &quot;skuId&quot;; private static String clusterName = &quot;my-application&quot;; private static final String template = &quot;Hello, %s!&quot;; private final AtomicLong counter = new AtomicLong(); @ResponseBody @RequestMapping(&quot;/greeting&quot;) public Greeting greeting(@RequestParam(value=&quot;name&quot;, defaultValue=&quot;World&quot;) String name) { return new Greeting(counter.incrementAndGet(), String.format(template, name)); } public long getTotalRows(String keyword, TransportClient client) { long totalRows; BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); boolQueryBuilder.must(QueryBuilders.termQuery(&quot;isShow&quot;, 1)) .must(QueryBuilders.termQuery(&quot;status&quot;, 1)) .must(QueryBuilders.termQuery(&quot;deleteStatus&quot;, 1)) .must(QueryBuilders.termQuery(&quot;salesStatus&quot;, 1)); if (keyword == null || keyword.isEmpty()) { totalRows = client.prepareCount(index).setTypes(type) .execute() .actionGet().getCount(); } else { QueryBuilder fBuilder = QueryBuilders.queryStringQuery(keyword).field(&quot;name&quot;); boolQueryBuilder.must(fBuilder); totalRows = client.prepareCount(index).setTypes(type) .setQuery(boolQueryBuilder) .execute() .actionGet().getCount(); } return totalRows; } @ResponseBody @RequestMapping(&quot;/searchFromSize&quot;) public Object testSearchByFromSize(@RequestParam(required = false) Integer pageIndex, @RequestParam(required = false) Integer pageSize, @RequestParam(required = false) String keyword, @RequestParam(required = false) String priceSort){ logger.info(&quot;op&lt;testSearchByFromSize&gt; pageIndex&lt;&quot;+pageIndex+&quot;&gt; pageSize&lt;&quot;+pageSize+&quot;&gt; &quot; + &quot;keyword&lt;&quot;+keyword+&quot;&gt; priceSort&lt;&quot;+priceSort+&quot;&gt;&quot;); JSONObject result = new JSONObject(); JSONObject goodsResult = new JSONObject(); long begin = System.currentTimeMillis(); TransportClient client = getClient(); long totalRows = getTotalRows(keyword, client); getIkAnalyzeSearchTerms(client, keyword); int from = (pageIndex - 1) * pageSize; List&lt;Map&lt;String, Object&gt;&gt; goodsExportList = testQueryStringQueryFromSize(client, index, type, &quot;name&quot;, keyword, from, pageSize, priceSort); goodsResult.put( &quot;goods&quot;, goodsExportList ); goodsResult.put( &quot;pageIndex&quot;, pageIndex ); goodsResult.put( &quot;pageSize&quot;, pageSize ); goodsResult.put( &quot;totalRows&quot;, totalRows ); result.put( &quot;success&quot;, true ); result.put( &quot;resultMessage&quot;, &quot;&quot; ); result.put( &quot;resultCode&quot;, &quot;0000&quot; ); result.put( &quot;result&quot;, goodsResult ); System.out.println(&quot;---op&lt;searchFromSize&gt; elapsed&lt;&quot;+(System.currentTimeMillis()-begin)+&quot;&gt;ms&quot;); return result; } public String scrollIdTemp = &quot;&quot;; @ResponseBody @RequestMapping(&quot;/searchScroll&quot;) public Object testSearchByScroll(@RequestParam(required = false) String scrollId, @RequestParam(required = false) Integer pageSize, @RequestParam(required = false) String keyword, @RequestParam(required = false) String priceSort){ logger.info(&quot;op&lt;testSearchByScroll&gt; scrollId&lt;&quot;+scrollId+&quot;&gt; pageSize&lt;&quot;+pageSize+&quot;&gt; &quot; + &quot;keyword&lt;&quot;+keyword+&quot;&gt; priceSort&lt;&quot;+priceSort+&quot;&gt;&quot;); JSONObject result = new JSONObject(); JSONObject goodsResult = new JSONObject(); long begin = System.currentTimeMillis(); scrollIdTemp = scrollId; TransportClient client = getClient(); long totalRows = getTotalRows(keyword, client); getIkAnalyzeSearchTerms(client, keyword); List&lt;Map&lt;String, Object&gt;&gt; goodsExportList = testQueryStringQueryScroll(client, index, type, &quot;name&quot;, keyword, scrollIdTemp, pageSize, priceSort); client.close(); goodsResult.put( &quot;goods&quot;, goodsExportList ); goodsResult.put( &quot;scrollId&quot;, scrollIdTemp ); goodsResult.put( &quot;pageSize&quot;, pageSize ); goodsResult.put( &quot;totalRows&quot;, totalRows ); result.put( &quot;success&quot;, true ); result.put( &quot;resultMessage&quot;, &quot;&quot; ); result.put( &quot;resultCode&quot;, &quot;0000&quot; ); result.put( &quot;result&quot;, goodsResult ); System.out.println(&quot;---op&lt;searchScroll&gt; elapsed&lt;&quot;+(System.currentTimeMillis()-begin)+&quot;&gt;ms&quot;); return result; } /** * ç„¶åå°±æ˜¯åˆ›å»ºä¸¤ä¸ªæŸ¥è¯¢è¿‡ç¨‹äº† ï¼Œä¸‹é¢æ˜¯from-sizeåˆ†é¡µçš„æ‰§è¡Œä»£ç ï¼š */ public List testQueryStringQueryFromSize(TransportClient client, String index, String type, String key, String value, Integer pageIndex, Integer pageSize ,String priceSort){ SearchResponse response = null; List resultList = null; try { //TransportClient client = getClient(); BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); if (value == null || value.isEmpty()) { boolQueryBuilder.must(QueryBuilders.termQuery(&quot;isShow&quot;, 1)) .must(QueryBuilders.termQuery(&quot;status&quot;, 1)) .must(QueryBuilders.termQuery(&quot;deleteStatus&quot;, 1)) .must(QueryBuilders.termQuery(&quot;salesStatus&quot;, 1)); } else { QueryBuilder fBuilder = QueryBuilders.queryStringQuery(value).field(key); boolQueryBuilder.must(QueryBuilders.termQuery(&quot;isShow&quot;, 1)) .must(QueryBuilders.termQuery(&quot;status&quot;, 1)) .must(QueryBuilders.termQuery(&quot;deleteStatus&quot;, 1)) .must(QueryBuilders.termQuery(&quot;salesStatus&quot;, 1)) .must(fBuilder); } if (priceSort == null || priceSort.isEmpty()) { response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(pageIndex).setSize(pageSize).setExplain(true) .execute() .actionGet(); } else { if ((&quot;desc&quot;).equals(priceSort)) { response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(pageIndex).setSize(pageSize).setExplain(true) .addSort(&quot;price&quot;, SortOrder.DESC) .execute() .actionGet(); } else { response = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setFrom(pageIndex).setSize(pageSize).setExplain(true) .addSort(&quot;price&quot;, SortOrder.ASC) .execute() .actionGet(); } } resultList = responseToList(response); } catch (Exception e) { e.printStackTrace(); } return resultList; } /** * ä¸‹é¢æ˜¯scrollåˆ†é¡µçš„æ‰§è¡Œä»£ç ï¼Œæ³¨æ„å•Šï¼scrollé‡Œé¢çš„sizeæ˜¯ç›¸å¯¹äºæ¯ä¸ªåˆ†ç‰‡æ¥è¯´çš„ï¼Œ * æ‰€ä»¥å®é™…è¿”å›çš„æ•°é‡æ˜¯ï¼šåˆ†ç‰‡çš„æ•°é‡*size * * Scroll-Scan æ–¹å¼ä¸æ™®é€š scroll æœ‰å‡ ç‚¹ä¸åŒï¼š * 1.Scroll-Scan ç»“æœæ²¡æœ‰æ’åºï¼ŒæŒ‰ index é¡ºåºè¿”å›ï¼Œæ²¡æœ‰æ’åºï¼Œå¯ä»¥æé«˜å–æ•°æ®æ€§èƒ½ã€‚ * 2.åˆå§‹åŒ–æ—¶åªè¿”å› _scroll_idï¼Œæ²¡æœ‰å…·ä½“çš„ hits ç»“æœã€‚ * 3.size æ§åˆ¶çš„æ˜¯æ¯ä¸ªåˆ†ç‰‡çš„è¿”å›çš„æ•°æ®é‡è€Œä¸æ˜¯æ•´ä¸ªè¯·æ±‚è¿”å›çš„æ•°æ®é‡ã€‚ */ public List testQueryStringQueryScroll(TransportClient client, String index, String type, String key, String value, String scrollId, Integer pageSize ,String priceSort){ if (pageSize != null) { //é»˜è®¤æœ‰5ä¸ªåˆ†ç‰‡ï¼Œ pageSize = pageSize/5; } SearchResponse scrollResponse = null; List resultList = null; try { //TransportClient client = getClient(); BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery(); if (value == null || value.isEmpty()) { boolQueryBuilder.must(QueryBuilders.termQuery(&quot;isShow&quot;, 1)) .must(QueryBuilders.termQuery(&quot;status&quot;, 1)) .must(QueryBuilders.termQuery(&quot;deleteStatus&quot;, 1)) .must(QueryBuilders.termQuery(&quot;salesStatus&quot;, 1)); } else { QueryBuilder fBuilder = QueryBuilders.queryStringQuery(value).field(key); boolQueryBuilder.must(QueryBuilders.termQuery(&quot;isShow&quot;, 1)) .must(QueryBuilders.termQuery(&quot;status&quot;, 1)) .must(QueryBuilders.termQuery(&quot;deleteStatus&quot;, 1)) .must(QueryBuilders.termQuery(&quot;salesStatus&quot;, 1)) .must(fBuilder); } if (scrollId == null || scrollId.isEmpty()) { if (priceSort == null || priceSort.isEmpty()) { scrollResponse = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setSearchType(SearchType.SCAN).setSize(pageSize).setScroll(TimeValue.timeValueMinutes(5)) .execute() .actionGet(); } else { if ((&quot;desc&quot;).equals(priceSort)) { scrollResponse = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setSearchType(SearchType.SCAN).setSize(pageSize).setScroll(TimeValue.timeValueMinutes(5)) .addSort(&quot;price&quot;, SortOrder.DESC) .execute() .actionGet(); } else { scrollResponse = client.prepareSearch(index).setTypes(type) .setQuery(boolQueryBuilder) .setSearchType(SearchType.SCAN).setSize(pageSize).setScroll(TimeValue.timeValueMinutes(5)) .addSort(&quot;price&quot;, SortOrder.ASC) .execute() .actionGet(); } } //æ³¨æ„:é¦–æ¬¡æœç´¢å¹¶ä¸åŒ…å«æ•°æ®ï¼Œç¬¬ä¸€æ¬¡ä¸è¿”å›æ•°æ®ï¼Œæ‰€ä»¥å…ˆæŸ¥ä¸€æ¬¡è·å–scrollIdï¼Œåœ¨è¿›è¡Œç¬¬äºŒæ¬¡scrollæŸ¥è¯¢ scrollId = scrollResponse.getScrollId(); } scrollResponse = client.prepareSearchScroll(scrollId) .setScroll(TimeValue.timeValueMinutes(5)) .execute() .actionGet(); //æ³¨æ„:é¦–æ¬¡æœç´¢å¹¶ä¸åŒ…å«æ•°æ®ï¼Œç¬¬ä¸€æ¬¡ä¸è¿”å›æ•°æ®ï¼Œè·å–æ€»æ•°é‡ long count = scrollResponse.getHits().getTotalHits(); System.out.println(&quot;scrollResponse.getHits().getHits().length:&quot;+scrollResponse.getHits().hits().length); System.out.println(&quot;scroll count:&quot;+count); //è·å–æœ¬æ¬¡æŸ¥è¯¢çš„scrollId scrollIdTemp = scrollResponse.getScrollId(); System.out.println(&quot;--------- searchByScroll scrollID:&quot;+scrollIdTemp); logger.info(&quot;--------- searchByScroll scrollID {}&quot;, scrollIdTemp); // æœç´¢ç»“æœ SearchHit[] searchHits = scrollResponse.getHits().hits(); for (SearchHit searchHit : searchHits) { String source = searchHit.getSource().toString(); logger.info(&quot;--------- searchByScroll source {}&quot;, source); } resultList = responseToList(scrollResponse); } catch (Exception e) { e.printStackTrace(); } return resultList; } /** * å°†æŸ¥è¯¢åè·å¾—çš„responseè½¬æˆlist * @param response * @return */ public List responseToList(SearchResponse response){ SearchHits hits = response.getHits(); List&lt;Map&lt;String, Object&gt;&gt; list = new ArrayList&lt;&gt;(); System.out.println(&quot;hits.hits().length:&quot;+hits.hits().length); System.out.println(&quot;------------------------&quot;); for (int i = 0; i &lt; hits.hits().length; i++) { Map&lt;String, Object&gt; map = hits.getAt(i).getSource(); Map&lt;String, Object&gt; resultMap = new HashMap&lt;&gt;(16); System.out.println(map.get(&quot;name&quot;)); resultMap.put(&quot;skuId&quot;, map.get(&quot;skuId&quot;)); resultMap.put(&quot;name&quot;, map.get(&quot;name&quot;)); resultMap.put(&quot;image&quot;, map.get(&quot;primaryImage&quot;)); resultMap.put(&quot;price&quot;, map.get(&quot;luckyPrice&quot;)); list.add(resultMap); } System.out.println(&quot;------------------------&quot;); return list; } public TransportClient getClient() { /** * 1:é€šè¿‡ settingå¯¹è±¡æ¥æŒ‡å®šé›†ç¾¤é…ç½®ä¿¡æ¯ * //æŒ‡å®šé›†ç¾¤åç§° * //å¯åŠ¨å—…æ¢åŠŸèƒ½ */ Settings settings = Settings.settingsBuilder() .put(&quot;cluster.name&quot;, clusterName) .put(&quot;client.transport.sniff&quot;, true) .build(); /** * 2ï¼šåˆ›å»ºå®¢æˆ·ç«¯ * é€šè¿‡settingæ¥åˆ›å»ºï¼Œè‹¥ä¸æŒ‡å®šåˆ™é»˜è®¤é“¾æ¥çš„é›†ç¾¤åä¸ºelasticsearch * é“¾æ¥ä½¿ç”¨tcpåè®®å³9300 */ TransportClient client = null; try { client = TransportClient.builder().settings(settings).build() .addTransportAddress(new InetSocketTransportAddress(InetAddress.getByName(HOST), PORT)); System.out.println(&quot;Elasticsearch connect info:&quot; + client.toString()); } catch (UnknownHostException e) { e.printStackTrace(); } /*transportClient = new TransportClient(setting); TransportAddress transportAddress = new InetSocketTransportAddress(&quot;192.168.79.131&quot;, 9300); transportClient.addTransportAddresses(transportAddress);*/ /** * 3ï¼šæŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ * æ³¨æ„æˆ‘çš„é›†ç¾¤ç»“æ„æ˜¯ï¼š * 131çš„elasticsearch.ymlä¸­æŒ‡å®šä¸ºä¸»èŠ‚ç‚¹ä¸èƒ½å­˜å‚¨æ•°æ®ï¼Œ * 128çš„elasticsearch.ymlä¸­æŒ‡å®šä¸ä¸ºä¸»èŠ‚ç‚¹åªèƒ½å­˜å‚¨æ•°æ®ã€‚ * æ‰€æœ‰æ§åˆ¶å°åªæ‰“å°äº†192.168.79.128,åªèƒ½è·å–æ•°æ®èŠ‚ç‚¹ * */ /*ImmutableList&lt;DiscoveryNode&gt; connectedNodes = client.connectedNodes(); for(DiscoveryNode node : connectedNodes) { System.out.println(node.getHostAddress()); }*/ return client; } /** * è°ƒç”¨ ES è·å– IK åˆ†è¯åç»“æœ * * @param searchContent * @return */ private List&lt;String&gt; getIkAnalyzeSearchTerms(Client client, String searchContent) { //è°ƒç”¨ IK åˆ†è¯åˆ†è¯ AnalyzeRequestBuilder ikRequest = new AnalyzeRequestBuilder(client, AnalyzeAction.INSTANCE, index, searchContent); //ikRequest.setAnalyzer(&quot;ik&quot;); ikRequest.setTokenizer(&quot;ik&quot;); List&lt;AnalyzeResponse.AnalyzeToken&gt; ikTokenList = ikRequest.execute().actionGet().getTokens(); //å¾ªç¯èµ‹å€¼ List&lt;String&gt; searchTermList = new ArrayList&lt;&gt;(); //ikTokenList.forEach(ikToken -&gt; { searchTermList.add(ikToken.getTerm()); }); for (AnalyzeResponse.AnalyzeToken ikToken: ikTokenList) { System.out.println(ikToken.getTerm()); searchTermList.add(ikToken.getTerm()); } return searchTermList; }} 4. å‰ç«¯æ•°æ®ä¸ºä¸Šè¿°çš„åˆ†é¡µçš„æ•°æ®å¯è§†åŒ–ï¼ŒåŠ å…¥å‰ç«¯å±•ç¤ºé¡µï¼Œå¯æŒ‰ä¸­æ–‡å…³é”®è¯æœç´¢åˆ†é¡µç­‰æ“ä½œã€‚ index.htmlï¼Œä»¥åŠjsæ“ä½œéƒ¨åˆ†ï¼Œdata.jsï¼Œç”±äºç¯‡å¹…é—®é¢˜ï¼Œä¸‹è½½å¯ç§»æ­¥è‡³github: https://github.com/wonderomg/elasticsearch-visualä¸‹è½½è¯¦ç»†å†…å®¹ï¼Œ å‰åç«¯é¡µç¼–å†™å®Œä¹‹åï¼Œå¯åŠ¨springbootå·¥ç¨‹ï¼Œè®¿é—®http://localhost:8080/è¯¥å·¥ç¨‹ç«¯å£ã€‚ å¯ä»¥çœ‹åˆ°æ“ä½œ é¡µé¢ï¼Œç±»ä¼¼ä¸‹å›¾ï¼š from sizeå’Œscrolléƒ½å¯é€šè¿‡è¯¥é¡µé¢è¿›è¡Œæµ‹è¯•ã€‚ 5. æ•°æ®é™åˆ¶é—®é¢˜æµ‹è¯•from sizeæ—¶å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå½“æ•°æ®è¶…è¿‡10000æ¡ä¼šæŠ¥é”™ï¼Œæç¤ºå¦‚ä¸‹ï¼š 1234Caused by: QueryPhaseExecutionException[Result window is too large, from + size must be less than or equal to: [10000] but was [10001]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level parameter.] åŸå› æ˜¯esç´¢å¼•è¢«é™åˆ¶äº†å¯æŸ¥å‰10000æ¡æ•°æ®ï¼Œå‚æ•°æ˜¯max_result_windowï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹è¿™ä¸ªé™åˆ¶ã€‚ (1)æŸ¥è¯¢index.max_result_window 1curl -XGET &quot;10.10.13.234:9200/jd_mall_v2/_settings?preserve_existing=true&quot; (2)æ›´æ”¹index.max_result_window 1curl -XPUT &quot;10.10.13.234:9200/jd_mall_v2/_settings?preserve_existing=true&quot; -d '{ &quot;index&quot; : { &quot;max_result_window&quot; : 100000000}}' è®¾ç½®max_result_windowçš„æ—¶å€™éœ€è¦å…ˆå…³é—­ç´¢å¼•ï¼Œä¸ç„¶ä¼šæŠ¥é”™Can't update non dynamic settings[[index.preserve_existing]] for open indicesçš„é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡æŒ‡ä»¤å…³é—­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡headå¯è§†åŒ–ç•Œé¢å…³é—­å’Œå¼€å¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸Šè¿°æ­¥éª¤1.7å’Œ1.8çš„apiå…³é—­å’Œå¼€å¯ã€‚ 6. æ’åºåˆ†é¡µçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥è¿˜æœ‰æ’åºçš„åœºæ™¯ï¼Œjava apiçš„è¯å¢åŠ ä»£ç ï¼š 1searchRequestBuilder.addSort(&quot;publish_time&quot;, SortOrder.DESC); æŒ‰ç…§æŸä¸ªå­—æ®µæ’åºçš„è¯ï¼Œhit.getScore()å°†ä¼šå¤±æ•ˆå¦‚æœæ˜¯scrollåˆ†é¡µæ— æ³•è¿›è¡Œæ’åºã€‚","link":"/2018/05/17/Elasticsearch%E5%AE%9E%E8%B7%B5api%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2/"}],"tags":[{"name":"sprintf","slug":"sprintf","link":"/tags/sprintf/"},{"name":"elasticsearch","slug":"elasticsearch","link":"/tags/elasticsearch/"},{"name":"ikä¸­æ–‡åˆ†è¯","slug":"ikä¸­æ–‡åˆ†è¯","link":"/tags/ik%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D/"},{"name":"alias","slug":"alias","link":"/tags/alias/"},{"name":"zookeeper","slug":"zookeeper","link":"/tags/zookeeper/"},{"name":"mysql","slug":"mysql","link":"/tags/mysql/"},{"name":"ibatis","slug":"ibatis","link":"/tags/ibatis/"},{"name":"resin","slug":"resin","link":"/tags/resin/"},{"name":"socket","slug":"socket","link":"/tags/socket/"},{"name":"C++","slug":"C","link":"/tags/C/"},{"name":"tcp","slug":"tcp","link":"/tags/tcp/"},{"name":"crontab","slug":"crontab","link":"/tags/crontab/"},{"name":"elemMatchæ¡ä»¶æ“ä½œç¬¦","slug":"elemMatchæ¡ä»¶æ“ä½œç¬¦","link":"/tags/elemMatch%E6%9D%A1%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%AC%A6/"},{"name":"mongodb","slug":"mongodb","link":"/tags/mongodb/"},{"name":"åˆ†é¡µæŸ¥è¯¢","slug":"åˆ†é¡µæŸ¥è¯¢","link":"/tags/%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2/"},{"name":"mybatis","slug":"mybatis","link":"/tags/mybatis/"},{"name":"é›†ç¾¤","slug":"é›†ç¾¤","link":"/tags/%E9%9B%86%E7%BE%A4/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"æ€§èƒ½ä¼˜åŒ–","slug":"æ€§èƒ½ä¼˜åŒ–","link":"/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"},{"name":"Web","slug":"Web","link":"/tags/Web/"},{"name":"è·¨åŸŸ","slug":"è·¨åŸŸ","link":"/tags/%E8%B7%A8%E5%9F%9F/"},{"name":"éšè®°","slug":"éšè®°","link":"/tags/%E9%9A%8F%E8%AE%B0/"},{"name":"SpingMvc","slug":"SpingMvc","link":"/tags/SpingMvc/"},{"name":"MongoDB","slug":"MongoDB","link":"/tags/MongoDB/"},{"name":"SpringData","slug":"SpringData","link":"/tags/SpringData/"},{"name":"idea","slug":"idea","link":"/tags/idea/"},{"name":"maven","slug":"maven","link":"/tags/maven/"}],"categories":[{"name":"C++","slug":"C","link":"/categories/C/"},{"name":"elasticsearch","slug":"elasticsearch","link":"/categories/elasticsearch/"},{"name":"ibatis","slug":"ibatis","link":"/categories/ibatis/"},{"name":"Socket","slug":"C/Socket","link":"/categories/C/Socket/"},{"name":"tcp","slug":"tcp","link":"/categories/tcp/"},{"name":"linux","slug":"linux","link":"/categories/linux/"},{"name":"mongodb","slug":"mongodb","link":"/categories/mongodb/"},{"name":"MongoDB","slug":"C/MongoDB","link":"/categories/C/MongoDB/"},{"name":"mysql","slug":"ibatis/mysql","link":"/categories/ibatis/mysql/"},{"name":"mybatis","slug":"mybatis","link":"/categories/mybatis/"},{"name":"zookeeper","slug":"zookeeper","link":"/categories/zookeeper/"},{"name":"Java","slug":"Java","link":"/categories/Java/"},{"name":"Web","slug":"Web","link":"/categories/Web/"},{"name":"resin","slug":"ibatis/mysql/resin","link":"/categories/ibatis/mysql/resin/"},{"name":"éšè®°","slug":"éšè®°","link":"/categories/%E9%9A%8F%E8%AE%B0/"}]}